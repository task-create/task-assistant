<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Employment Assistant</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>
<meta name="theme-color" content="#FFFFFF">
<script src="https://unpkg.com/tone"></script>
<style>
:root{
  --radius: 20px;
  --bg: #f4f7fa;
  --surface: #ffffff;
  --surface-2: #f7fbff;
  --text: #0a121e;
  --muted: #5a6b82;
  --brand: #E34A27; /* TASK Red-Orange */
  --accent: #003B5C; /* TASK Dark Blue */
  --border: #e2e8f0;
  --link: var(--brand);
  --shadow: 0 20px 40px rgba(30, 50, 80, .1);
  --shadow-soft: 0 8px 20px rgba(30, 50, 80, .08);
  --header-bg: rgba(255, 255, 255, 0.7);
  --header-border: #d9e2ec;
  --bubble-bot-bg: #e9eef3;
  --bubble-bot-text: #111827;
  --bubble-user-bg: var(--brand);
  --bubble-user-text: #fff;
  --typing: #aab4c3;
  --error: #E53935; /* Red for errors */
}
/* DARK MODE */
[data-theme="dark"]{
  --bg: #0a0f1a;
  --surface: #111929;
  --surface-2: #0e1625;
  --text: #eaf2ff;
  --muted: #a7bad5;
  --border: #344b6b;
  --link: #ff8a6b;
  --header-bg: rgba(17, 25, 41, 0.7);
  --header-border: #344b6b;
  --bubble-bot-bg: #1e293b;
  --bubble-bot-text: #eaf2ff;
  --shadow: 0 22px 46px rgba(0,0,0,.6);
  --shadow-soft: 0 12px 28px rgba(0,0,0,.45);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:"Open Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg); color:var(--text); display:flex; align-items:center; justify-content:center;
  font-size:clamp(15px, 1.6vw, 17px); min-height:100vh;
}
a{color:var(--link);text-decoration:none;font-weight:600} a:hover{text-decoration:underline}
.app{
  width:100%; max-width:560px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
  overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; height:100vh; position:relative;
}
.header{
  position: absolute; top: 0; left: 0; right: 0; z-index: 100;
  background: var(--header-bg);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border-bottom:1px solid var(--header-border); 
  padding:12px 56px; text-align:center;
}
.badge{
  display:inline-block; background: var(--surface); color:var(--text); padding:8px 20px; border-radius:999px;
  font:800 16px/1 "Nunito", sans-serif; cursor:pointer;
  border: 1px solid var(--border); box-shadow: var(--shadow-soft);
}
.icon-btn {
  position:absolute; top:10px; width:44px; height:44px; border:none; border-radius:50%; background:transparent;
  color:var(--muted); cursor:pointer; transition:all .2s ease; font-size: 20px;
  display: flex; align-items: center; justify-content: center;
}
.icon-btn:hover { color: var(--text); background: rgba(0,0,0,0.05); }
.icon-btn:active { transform: scale(.95); }
.reset{left:10px;}
.settings-btn {right:10px;}

.settings-menu{position:absolute;top:60px;right:10px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-soft);display:none;min-width:180px;z-index:200}
.settings-menu[aria-hidden="false"]{display:block}
.settings-menu button{display:flex; gap: 8px; align-items: center; width:100%;text-align:left;padding:10px 12px;background:transparent;border:none;cursor:pointer; color: var(--text);}
.settings-menu button:hover{background:var(--surface-2)}
/* .langmenu { right: 10px; } - REMOVED */

.chat{
  flex:1; overflow-y:auto; overflow-x:hidden; padding:20px; padding-top: 80px; padding-bottom:120px; overscroll-behavior:contain; -webkit-overflow-scrolling:touch;
  background: var(--surface-2);
}
.bubble-wrapper { display: flex; align-items: flex-end; gap: 8px; margin: 20px 0; max-width: 92%; animation: pop-in .3s cubic-bezier(0.25, 1, 0.5, 1); }
.bot-bubble-wrapper { margin-right: 18%; }
.user-bubble-wrapper { margin-left: 18%; flex-direction: row-reverse; }

.avatar { width: 36px; height: 36px; border-radius: 50%; background:var(--accent); flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: white; font-family: "Nunito", sans-serif; font-weight: 700; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.bubble{padding:14px 18px;border-radius:18px;line-height:1.5;box-shadow:var(--shadow-soft); transition:box-shadow .15s ease,transform .08s ease}
.bubble.bot{background:var(--bubble-bot-bg); color: var(--bubble-bot-text); border:1px solid var(--border); border-radius: 18px 18px 18px 4px;}
.bubble.user{color:var(--bubble-user-text); background:var(--bubble-user-bg); border:none; border-radius:18px 18px 4px 18px; box-shadow: 0 4px 14px rgba(227, 74, 39, 0.3);}
.bubble:hover{box-shadow:0 10px 22px rgba(20,80,120,.14); transform: translateY(-1px);}
@keyframes pop-in { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
.ctrl{
  display: inline-flex; align-items: center; gap: 8px;
  border:1px solid var(--border); background:var(--surface); border-radius:999px; padding:12px 18px;
  font-weight:600; cursor:pointer; transition:all .12s ease;
  color:var(--text); font-size: 15px;
}
.ctrl:hover { transform: translateY(-2px); border-color: var(--accent); color: var(--accent); box-shadow: var(--shadow-soft); }
.ctrl:active{transform:scale(.98)}
.ctrl:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
.typing{display:inline-flex;gap:6px;align-items:flex-end}
.typing .dot{width:6px;height:6px;border-radius:50%;background:var(--typing);animation:bounce 1s infinite ease-in-out}
.typing .dot:nth-child(2){animation-delay:.12s}.typing .dot:nth-child(3){animation-delay:.24s}
@keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-6px);opacity:1}}
@media (prefers-reduced-motion: reduce){.typing .dot{animation:none}}
.footer{position:absolute;bottom:0;left:0;right:0;padding:12px;background:var(--surface-2);border-top:1px solid var(--border);z-index:100}
.row{display:flex;gap:10px;align-items:center}
#box{flex:1;padding:14px 50px 14px 18px;border:2px solid var(--border);border-radius:999px;font-size:16px;background:var(--surface);color:var(--text);caret-color:var(--accent); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);}
#box:disabled { background: var(--surface-2); cursor: not-allowed; }
.magic-btn { position: absolute; right: 75px; top: 18px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); transition: transform 0.2s ease, color 0.2s ease; }
.magic-btn:hover { transform: scale(1.2); color: var(--accent); }

.send{width:52px;height:52px;border:none;border-radius:50%;cursor:pointer;color:white;font-size:18px;background:var(--brand);box-shadow:var(--shadow-soft);transition:transform .1s ease, background .1s ease;}
.send:hover { background: var(--accent); }
.send:active{transform:scale(.95)}
.send:disabled { background: var(--muted); cursor: not-allowed; }
.status{margin-top:6px;text-align:center;font-size:11px;color:var(--muted)}
.error-status { color: var(--error); font-weight: 600; }
/* --- Cards --- */
.card-base {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px; box-shadow: var(--shadow-soft); margin-bottom: 16px;
  animation: pop-in .5s cubic-bezier(0.25, 1, 0.5, 1) backwards;
}
.card-base h3 { font-family: "Nunito", sans-serif; font-size: 18px; color: var(--accent); margin-bottom: 8px; }
.card-base p { margin-bottom: 12px; line-height: 1.5; }
.card-base .ctrl { background: var(--surface-2); }
.job-card { margin-top: 10px; }
.job-card strong { display: block; font-family: "Nunito", sans-serif; }
.job-card span { color: var(--muted); font-size: 14px; }
</style>
</head>
<body>
<main class="app">
<header class="header">
  <button class="reset icon-btn" id="resetBtn" aria-label="Clear chat">‚Ü∫</button>
  <div class="badge" id="scrollTopBtn" tabindex="0" role="button" aria-label="Scroll to top">Employment Assistant</div>
  <button class="settings-btn icon-btn" id="settingsBtn" aria-label="Settings menu" aria-haspopup="menu" aria-expanded="false">...</button>
  <div class="settings-menu" id="settingsMenu" role="menu" aria-hidden="true">
    <button role="menuitem" id="micBtn">üéôÔ∏è Voice Input</button>
    <button role="menuitem" id="themeToggle">üåó Theme</button>
  </div>
</header>

<section class="chat" id="chat" role="log" aria-live="polite" aria-relevant="additions" aria-label="Chat transcript"></section>

<footer class="footer">
  <div class="row" style="position: relative;">
    <label class="visually-hidden" for="box">Type a message</label>
    <input id="box" type="text" placeholder="Ask me anything..." autocomplete="off"/>
    <button class="magic-btn" id="magicBtn" aria-label="Show suggestions">‚ú®</button>
    <button class="send" id="send" aria-label="Send">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
    </button>
  </div>
  <div class="status" id="status-bar">‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info.</div>
</footer>
</main>

<script>
'use strict';

/* ================= UI STRINGS (Multilingual) ================= */
const UI = {
  en:{welcome:'üëã Hi there! How can I help you today?', hello:'Hi! üëã How can I help today?', thanks:"You're welcome! üòä Is there anything else?", bye:'Take care! If you need to schedule, call (609) 337-1624.', noWalk:'We do <strong>not</strong> take walk-ins. Please call to schedule. Same-day may be possible if you call first.', frust:'I understand this can be frustrating, and I\'m sorry you\'re having trouble. Let\'s try something else. Here are our main phone numbers for direct help:'},
  es:{welcome:'üëã ¬°Hola! ¬øEn qu√© te puedo ayudar hoy?', hello:'¬°Hola! üëã ¬øEn qu√© te puedo ayudar hoy?', thanks:'¬°Con gusto! üòä ¬øAlgo m√°s?',bye:'¬°Cu√≠date! Si necesitas una cita, llama al (609) 337-1624.', noWalk:'No atendemos <strong>sin cita</strong>. Por favor llama para programar.', frust:'Entiendo que esto puede ser frustrante y lamento que tengas problemas. Probemos otra cosa. Aqu√≠ est√°n nuestros n√∫meros de tel√©fono principales para obtener ayuda directa:'},
  ht:{welcome:'üëã Bonjou! Kijan mwen ka ede w jodi a?', hello:'Bonjou! üëã Kijan mwen ka ede w jodi a?', thanks:'Av√®k plezi! üòä Gen l√≤t bagay?',bye:'Si ou bezwen randevou, rele (609) 337-1624.', noWalk:'Nou pa pran <strong>san randevou</strong>. Tanpri rele pou pran randevou.', frust:'Mwen konprann sa ka fwistre, e mwen regr√®t ou gen pwobl√®m. Ann eseye yon l√≤t bagay. Men nimewo telef√≤n prensipal nou yo pou jwenn √®d dir√®k:'}
};


/* ================= DOM ELEMENTS & STATE ================= */
let lang = 'en';
let chatHistory = [];

const ce = id => document.getElementById(id);
const chat = ce('chat');
const box = ce('box');
const sendBtn = ce('send');
const statusDiv = ce('status-bar');

const settingsBtn = ce('settingsBtn');
const settingsMenu = ce('settingsMenu');
const micBtn = ce('micBtn');

/* ================= SOUND & HAPTICS ================= */
let synth;
try {
  // Chime sound configuration
  synth = new Tone.PolySynth(Tone.Synth, {
    oscillator: { type: "sine" },
    envelope: { 
      attack: 0.005, 
      decay: 0.8, // Longer decay for bell effect
      sustain: 0.1, // Small sustain for resonance
      release: 0.5 
    }, 
    volume: -10 
  }).toDestination();
} catch (e) { console.warn("Tone.js failed to initialize."); synth = null; }

function playSound(type) {
  if (synth && Tone.context.state !== 'running') { Tone.start(); }
  if (synth) {
    try { 
      if (type === 'send') synth.triggerAttackRelease("G5", "8n", Tone.now());
      if (type === 'receive') synth.triggerAttackRelease("C6", "8n", Tone.now()); 
    } catch(e) {}
  }
}
function vibrate(style = 'light') {
  if (window.navigator?.vibrate) {
    try { 
      if (style === 'light') navigator.vibrate(10);
      if (style === 'medium') navigator.vibrate([30, 50, 30]);
    } catch(e) {}
  }
}

/* ================= UTILITY FUNCTIONS ================= */

/** Toggles loading/interaction state for the input box and send button. */
function setLoadingState(isLoading) {
    box.disabled = isLoading;
    sendBtn.disabled = isLoading;
    ce('magicBtn').disabled = isLoading;
    ce('resetBtn').disabled = isLoading;
}

/** Updates the status bar with an optional error message. */
function setErrorStatus(message) {
    if (message) {
        // Updated error message to be less prescriptive about the user's network
        statusDiv.innerHTML = `üö® **Error**: ${message}`;
        statusDiv.classList.add('error-status');
    } else {
        statusDiv.innerHTML = '‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info.';
        statusDiv.classList.remove('error-status');
    }
}

/** Sends an email to the designated address with error details. */
function sendErrorEmail(userPrompt, errorMessage) {
    const email = 'seanf@trentonsoupkitchen.org';
    const subject = encodeURIComponent(`Critical Employment Assistant Error Report`);
    const body = encodeURIComponent(`
A user encountered a persistent connection error.

--- DIAGNOSTIC DETAILS ---
User's Last Prompt: ${userPrompt}
Error Message: ${errorMessage}
Language Status: ${lang}
Timestamp: ${new Date().toISOString()}

Please check the Gemini API service status.
`);

    // Use a short delay before opening the mailto link to prevent race conditions
    // and avoid disrupting the user's current action immediately.
    setTimeout(() => {
        window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    }, 500);
}

const isNearBottom = () => (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 80;
function safeScroll() { if (isNearBottom()) requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight ); }
function setLang(l, persist = true) { 
    lang = (['en', 'es', 'ht'].includes(l) ? l : 'en'); 
    if (persist) { try { localStorage.setItem('task_lang', lang); } catch(e) {} } 
}
window.textInfo = (text) => { const url = `sms:?&body=${encodeURIComponent(text)}`; window.location.href = url; vibrate('medium'); };

/* ================= RENDER FUNCTIONS ================= */
function addU(t){ 
    const e = document.createElement('div'); 
    e.className = 'bubble-wrapper user-bubble-wrapper'; 
    e.innerHTML = `<div class="bubble user">${t}</div>`; 
    chat.appendChild(e); 
    safeScroll(); 
    playSound('send'); 
    vibrate('light'); 
}

function addB(html){
    const wrapper = document.createElement('div');
    wrapper.className = 'bubble-wrapper bot-bubble-wrapper';
    const avatar = `<div class="avatar" aria-hidden="true">E</div>`;
    const bubble = `<div class="bubble bot">${html}</div>`;
    wrapper.innerHTML = avatar + bubble;
    chat.appendChild(wrapper);
    safeScroll();
    playSound('receive');
    vibrate('light');
}

function typing(on){
    const id = 'typing';
    if(on){
        const wrapper = document.createElement('div');
        wrapper.id = id;
        wrapper.className = 'bubble-wrapper bot-bubble-wrapper';
        const avatar = `<div class="avatar" aria-hidden="true">E</div>`;
        const bubble = `<div class="bubble bot"><div class="typing" aria-hidden="true"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div></div>`;
        wrapper.innerHTML = avatar + bubble;
        chat.appendChild(wrapper);
    } else { ce(id)?.remove(); }
    safeScroll();
}


/* ================= AI CORE (GEMINI) - WITH EXPONENTIAL BACKOFF ================= */
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
const MAX_RETRIES = 3;

const systemPrompt = `
  You are the Employment Assistant for the Trenton Area Soup Kitchen (TASK). 
  Your persona is friendly, empathetic, and extremely helpful. Your goal is to provide clear, actionable information.
  Keep responses concise, using Markdown for links.
  
  ***IMPORTANT RULES***
  1.  **DETECT INTENT**: Analyze the user's message to determine their core need. Handle typos gracefully (e.g., "apointmetn" is "appointment", "tarinign" is "training").
  2.  **HANDLE STAFF**: If the user mentions "Sean", provide his info for training. If they mention "Diani", provide her info for appointments.
  3.  **HANDLE JOBS**: If the user asks for "jobs", ALWAYS ask for the job type first (warehouse, retail, food service). Once they specify a type, respond ONLY with the tag: [SEARCH_JOBS: job_type]. For specific company names (Amazon, UPS, Sodexo, Trane, Aramark, P.F. Chang's, Red Lobster, Cheesecake Factory, Cooper's Riverview, Longhorn Steakhouse), respond ONLY with the tag: [SEARCH_JOBS: company_name].
  4.  **HANDLE TRAINING**: If the user asks for "training", provide the direct application link.
  5.  **PROVIDE INFO**: For all other topics (hours, address, SORA, etc.), provide the information directly.
  6.  **BE CONVERSATIONAL**: Don't just list facts. If a user says "hi", say hi back. If they are frustrated, be empathetic before providing help.
  7.  **MATCH LANGUAGE**: Always respond in the same language as the user's last message (English, Spanish, or Haitian Creole).

  ***YOUR KNOWLEDGE BASE***
  - **TASK Website**: [https://www.trentonsoupkitchen.org](https://www.trentonsoupkitchen.org)
  - **Appointments**: To make an appointment, call **609-337-1624**. We do NOT take walk-ins.
  - **Sean (Training Contact)**: **609-697-6215**
  - **Diani (Appointment Contact)**: **609-697-6166**
  - **Training Application Link**: [https://bycell.mobi/wap/default/item.jsp?entryid=ECNDE0Mg==&itemid=170659](https://bycell.mobi/wap/default/item.jsp?entryid=ECNDE0Mg==&itemid=170659)
  - **SORA License Info**: Official NJ site is [https://www.njsp.org/private-detective/sora.shtml](https://www.njsp.org/private-detective/sora.shtml)
  - **Career Tips**: Based on [https://bycell.mobi/wap/default/item.jsp?entryid=ECNDE0Mg==&itemid=170675](https://bycell.mobi/wap/default/item.jsp?entryid=ECNDE0Mg==&itemid=170675)
`;

/**
 * Handles API fetch with exponential backoff for transient errors.
 */
async function exponentialBackoffFetch(url, options, retries = 0) {
    try {
        const response = await fetch(url, options);
        // Retry logic for rate limiting (429) or server errors (5xx)
        if (response.status === 429 || response.status >= 500) {
            if (retries < MAX_RETRIES) {
                const delay = Math.pow(2, retries) * 1000 + (Math.random() * 1000); // 1s, 2s, 4s + jitter
                await new Promise(resolve => setTimeout(resolve, delay));
                return exponentialBackoffFetch(url, options, retries + 1);
            }
            throw new Error(`API error after ${MAX_RETRIES} attempts. Status: ${response.status} ${response.statusText}`);
        }
        if (!response.ok) {
             throw new Error(`Non-retryable API error. Status: ${response.status} ${response.statusText}`);
        }
        return response.json();
    } catch (error) {
        // Log the specific error for developer troubleshooting
        console.error("Fetch attempt failed:", error.message);
        throw error; // Re-throw the error for getAiResponse to handle
    }
}

/**
 * Uses Gemini in structured output mode to detect the language of the user's prompt.
 * If a supported language (en, es, ht) is detected and differs from the current lang, the state is updated.
 */
async function detectAndSetLanguage(prompt) {
    const langDetectionPrompt = `Detect the language of the following user message and return the corresponding two-letter ISO 639-1 language code (en, es, or ht). Do not provide any other text. User message: "${prompt}"`;
    const targetLanguages = ['en', 'es', 'ht']; // Supported languages

    try {
        const payload = {
            contents: [{ parts: [{ text: langDetectionPrompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: { "language": { "type": "STRING", "description": "The two-letter ISO 639-1 code (en, es, or ht)." } },
                    propertyOrdering: ["language"]
                }
            },
            systemInstruction: { parts: [{ text: "You are a language detection expert. Output only the requested JSON object." }] },
        };

        const result = await exponentialBackoffFetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        const parsedJson = JSON.parse(jsonText);
        const detectedLang = parsedJson.language.toLowerCase();
        
        if (targetLanguages.includes(detectedLang) && detectedLang !== lang) {
            setLang(detectedLang);
            console.log(`Language switched to: ${detectedLang}`);
            // Note: We don't call greet here, as the chat response comes next.
        }
    } catch (e) {
        // Log detection failure but allow the main chat to proceed.
        console.warn("Language detection failed, proceeding with current language.", e);
    }
}


async function getAiResponse(prompt) {
    typing(true);
    setLoadingState(true);

    const currentContents = [...chatHistory, { role: "user", parts: [{ text: prompt }] }];

    try {
        const payload = {
            contents: currentContents,
            systemInstruction: { parts: [{ text: systemPrompt }] },
            tools: [{ "google_search": {} }]
        };

        const result = await exponentialBackoffFetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, the AI did not return a valid response.";
        
        // Push the user prompt and the successful model response to history
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        chatHistory.push({ role: "model", parts: [{ text: text }] });
        
        setErrorStatus(null); // <--- Clears the error status on success
        return text;

    } catch (error) {
        console.error("Gemini API call failed:", error);
        
        // CRITICAL: Send error report email
        sendErrorEmail(prompt, error.message);

        // Updated error status message
        setErrorStatus("The AI service is temporarily unavailable. An administrator has been notified.");
        return "I'm sorry, I encountered a critical connection error. An administrator has been notified. Please try again in a moment.";
    } finally {
        typing(false);
        setLoadingState(false);
    }
}


/* ================= APPLICATION FLOW ================= */
async function handle(t){
  if(!t) return;
  
  // 1. Auto-detect language BEFORE sending to main model
  await detectAndSetLanguage(t); 

  addU(t);
  
  // 2. Process main AI response
  const aiResponse = await getAiResponse(t);

  if (aiResponse.startsWith('[SEARCH_JOBS:')) {
    const jobMatch = aiResponse.match(/\[SEARCH_JOBS:\s*(.+)\]/);
    if (jobMatch && jobMatch[1]) {
        await getJobs(jobMatch[1]);
    } else {
        addB("I received a job search request but couldn't parse the type. Please try again.");
    }
  } else {
    // Convert Markdown links to standard HTML anchor tags for rendering
    const formattedResponse = aiResponse.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    addB(formattedResponse);
  }
}

async function getJobs(query) {
    addB(`Searching for the latest <strong>${query}</strong> jobs in Mercer County...`);
    
    // The link below goes directly to Google Jobs, which is a trusted aggregator
    // that links directly to the employer's website.
    const jobQuery = `entry level ${query} jobs in Mercer County NJ`;
    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(jobQuery)}&ibp=htl;jobs`;
    
    let jobsHtml = `Here are some recent <strong>${query}</strong> openings. For daily, real-time results and to navigate directly to the **Employer's Website** for safe application, click the button below:`;
    jobsHtml += `<div class="card-base job-card">
        <strong>Live Job Search Results (Google Jobs)</strong>
        <span>Mercer County, NJ</span>
        <div class="controls"><a href="${searchUrl}" target="_blank" rel="noopener" class="ctrl">View Live Jobs</a></div>
    </div>`;
    addB(jobsHtml);
}

function send(){ 
    const t = (box.value||'').trim(); 
    if(!t) return; 
    handle(t); 
    box.value = ''; 
    box.blur(); 
    setTimeout(() => box.focus(), 100); 
}


/* ================= INITIALIZATION & EVENTS ================= */

// --- Theme Initialization ---
(function initTheme(){
  let saved = null; try{saved = localStorage.getItem('task_theme');}catch(e){}
  if(!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
    document.documentElement.setAttribute('data-theme','dark');
  } else if(saved){
    document.documentElement.setAttribute('data-theme', saved);
  }
})();
ce('themeToggle').addEventListener('click',()=>{
  const dark = document.documentElement.getAttribute('data-theme') === 'dark';
  const next = dark ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  try{ localStorage.setItem('task_theme', next); }catch(e){}
});

// --- Settings Menu ---
settingsBtn.addEventListener('click', () => {
    const open = settingsMenu.getAttribute('aria-hidden') === 'false';
    settingsMenu.setAttribute('aria-hidden', open ? 'true' : 'false');
    settingsBtn.setAttribute('aria-expanded', open ? 'false' : 'true');
});
document.addEventListener('click', (e) => {
    // Only close the settings menu if the click is outside the button and menu
    if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
        settingsMenu.setAttribute('aria-hidden', 'true');
    }
});


// --- Voice Input ---
(function initMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ micBtn.style.display = 'none'; return; }
  const rec = new SR(); 
  // Voice input uses the current global language setting
  const langMap = {en:'en-US', es:'es-ES', ht:'ht-HT'};
  micBtn.addEventListener('click', () => { 
      rec.lang = langMap[lang] || 'en-US'; 
      rec.start(); 
  });
  rec.onresult = e => { box.value = e.results[0][0].transcript; send(); };
})();

// --- Main Chat Events ---
ce('resetBtn').addEventListener('click', () => { chat.innerHTML = ''; chatHistory = []; setErrorStatus(null); greet(true); });
ce('send').addEventListener('click', send);
box.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); send(); }});
box.addEventListener('focus', () => setTimeout(() => safeScroll(), 300));
ce('scrollTopBtn').addEventListener('click', () => chat.scrollTo({top:0,behavior:'smooth'}));

/* ================= GREETING & OPPORTUNITY ENGINE ================= */
async function fetchOpportunities() {
    const mockData = [
      // 1. UPDATED OPPORTUNITY: General Hiring Event (removed company name)
      { title: 'üî• High-Volume Hiring Event Today!', message: 'Multiple regional employers are hiring warehouse and entry-level associates until 3 PM at a Robbinsville location.', link: 'https://www.google.com/search?q=warehouse+jobs+robbinsville+nj&ibp=htl;jobs', linkText: 'View Openings' },
      
      // 2. NEW CARD: Amazing Career Tips (using the provided link)
      { title: '‚ú® Your Next Career Tip', message: 'Get helpful advice on interview prep, resume building, and securing your next job.', link: 'https://bycell.co/ddmnx', linkText: 'Get Tips' },

      // 3. Local Bus Route Info (Consolidated Trip Planner Link)
      { title: 'Local Bus Route Update', message: 'The 609 Bus is running on a delayed schedule this morning due to construction. Check the trip planner for alternatives.', linkText: 'Trip Planner', link: 'https://www.njtransit.com/trip-planner' },
    ];
    return mockData;
}

ce('magicBtn').addEventListener('click', async () => {
  vibrate('light');
  setLoadingState(true);
  addB('‚ú® Here are today\'s top opportunities:');
  
  try {
      const opportunities = await fetchOpportunities();
      let oppsHTML = '';
      opportunities.forEach((item, i) => {
        let cardHTML = `<div class="card-base opportunity-card" style="animation-delay: ${i*100}ms"><h3>${item.title}</h3><p>${item.message}</p>`;
        if (item.linkText && item.link) {
          cardHTML += `<div class="controls"><a class="ctrl" href="${item.link}" target="_blank" rel="noopener">${item.linkText}</a></div>`;
        }
        cardHTML += `</div>`;
        oppsHTML += cardHTML;
      });
      addB(oppsHTML);
      setErrorStatus(null); 
  } catch (e) {
      addB("Sorry, I couldn't load the opportunities right now.");
      setErrorStatus("Failed to load opportunities.");
  } finally {
      setLoadingState(false);
  }
});


function greet(fromReset = false){
  if(fromReset){
    let saved = null; try{ saved = localStorage.getItem('task_lang'); }catch(e){}
    // Restore language setting on reset
    setLang(saved || 'en');
  }
  const welcomeMessage = UI[lang] ? UI[lang].welcome : UI['en'].welcome;
  addB(`<strong>${welcomeMessage}</strong>`);
}

// Initial setup on load
(function init(){ 
    let saved = null; 
    try{ saved = localStorage.getItem('task_lang'); }catch(e){} 
    setLang(saved || 'en'); 
    setErrorStatus(null); // Clears status bar on initial load
    greet();
})();

</script>
</body>
</html>
