<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TASK Assistant</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">

  <style>
    :root {
      color-scheme: light dark;
      --bg-dark:#0b1220; --panel-dark:#0f172a; --text-dark:#e5e7eb; --muted-dark:#9aa4b2; --border-dark:#1f2937;
      --bg-light:#f8fafc; --panel-light:#ffffff; --text-light:#0b1220; --muted-light:#475569; --border-light:#e5e7eb;
      --brand:#ff8a00; --brand2:#ffd088; --chip:#eef2ff1a;
    }
    [data-theme="dark"] { --bg:var(--bg-dark); --panel:var(--panel-dark); --text:var(--text-dark); --muted:var(--muted-dark); --border:var(--border-dark); }
    [data-theme="light"]{ --bg:var(--bg-light); --panel:var(--panel-light); --text:var(--text-light); --muted:var(--muted-light); --border:var(--border-light); }

    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:grid; place-items:center;
    }
    :focus-visible{ outline:2px solid var(--brand); outline-offset:2px; }

    /* Motion safety */
    @media (prefers-reduced-motion: reduce){
      .spin,.sparkle,.sparkle-sm{ animation:none !important }
    }

    /* Splash */
    .splash{ position:fixed; inset:0; display:grid; place-items:center; background:var(--bg); z-index:9999; }
    .splash-card{ width:min(620px,92vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:28px 24px; text-align:center; position:relative; box-shadow:0 20px 60px rgba(0,0,0,.35); }
    .splash-title{ font-size:28px; font-weight:800; margin:14px 0 6px; }
    .splash-sub{ color:var(--muted); margin:0 0 16px; }
    .theme-toggle{ position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--text); display:grid; place-items:center; cursor:pointer; }

    .logo-wrap { position:relative; width:86px; height:86px; margin:0 auto; }
    .logo {
      width:86px; height:86px; border-radius:18px; display:grid; place-items:center;
      background:var(--brand); color:#000; font-weight:900; font-size:36px; z-index:2; position:relative;
      box-shadow:0 6px 22px rgba(255,138,0,.35);
    }
    .sparkle {
      position:absolute; inset:-16px; border-radius:28px; pointer-events:none; opacity:.9;
      background: conic-gradient(from 0deg, var(--brand) 0%, var(--brand2) 25%, transparent 40%, transparent 60%, var(--brand2) 75%, var(--brand) 100%);
      filter: blur(14px) saturate(1.2);
      animation: spin 4s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .actions{ display:flex; gap:10px; justify-content:center; padding-top:8px; }
    .btn{ padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:var(--brand); color:#000; cursor:pointer; font-size:16px; }

    /* App shell */
    .hidden{ display:none !important; }
    .app { width:min(980px,96vw); min-height:76vh; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:grid; grid-template-rows:auto 1fr auto auto; gap:14px; }
    header { display:flex; align-items:center; gap:12px; }
    .logo-sm-wrap{ position:relative; width:46px; height:46px; }
    .logo-sm{ width:46px; height:46px; border-radius:12px; display:grid; place-items:center; background:var(--brand); color:#000; font-weight:800; font-size:20px; z-index:2; position:relative; }
    .sparkle-sm{ position:absolute; inset:-8px; border-radius:20px; pointer-events:none; opacity:0; transition:opacity .2s; background: conic-gradient(from 0deg, var(--brand) 0%, var(--brand2) 25%, transparent 40%, transparent 60%, var(--brand2) 75%, var(--brand) 100%); filter: blur(10px) saturate(1.2); animation: spin 4s linear infinite; }
    .sparkle-sm.on{ opacity:.7; }

    .muted{ color:var(--muted); font-size:14px; }
    .chat{ overflow:auto; -webkit-overflow-scrolling:touch; padding:0; border-radius:12px; background: rgba(0,0,0,0.06); border:1px solid var(--border); display:flex; flex-direction:column; gap:12px; }
    .settings-bar{
      position: sticky; top: 0; z-index: 5; display:flex; gap:8px; align-items:center;
      padding:10px 12px; background:var(--panel); border-bottom:1px solid var(--border);
    }
    .settings-bar .spacer{ flex:1; }
    .settings-link{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:transparent; color:var(--text); text-decoration:none; font-size:14px; }
    .chat-body{ padding:12px; display:flex; flex-direction:column; gap:12px; }

    .bubble{ max-width:82%; padding:12px 14px; border-radius:14px; line-height:1.5; border:1px solid var(--border); }
    .me{ align-self:flex-end; background:#172554; color:#fff; white-space:pre-wrap; word-wrap:break-word; }
    .bot{ align-self:flex-start; background:#111827; color:#e5e7eb; }
    [data-theme="light"] .me{ background:#e6f0ff; color:#0b1220; }
    [data-theme="light"] .bot{ background:#f3f4f6; color:#0b1220; }

    .row{ display:flex; gap:10px; }
    input[type="text"]{ flex:1; font-size:18px; padding:14px; border-radius:12px; background:transparent; color:var(--text); border:1px solid var(--border); outline:none; }
    button{ font-size:18px; padding:14px 18px; border-radius:12px; border:0; cursor:pointer; background:var(--brand); color:#000; }
    .icon-btn{ width:48px; min-width:48px; display:grid; place-items:center; border-radius:12px; background:transparent; border:1px solid var(--border); color:var(--text); }
    .icon-btn.on{ background:var(--brand); color:#000; border-color:var(--brand); }
    .spin{ animation: spin 1.1s linear infinite; }

    .error{ color:#ef4444; }

    /* Lists only when needed */
    .bot ul{ margin:0; padding-left:22px; }
    .bot li{ margin:6px 0; list-style: disc; }

    /* Chips */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 0; }
    .chip{ font-size:14px; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--chip); cursor:pointer; }
    .chip-link{ text-decoration:none; }

    .disclaimer { font-size:12px; color:var(--muted); line-height:1.45; padding:4px 2px 0; }
    .disclaimer a { color:inherit; text-decoration:underline; }
  </style>
</head>
<body data-theme="dark">
  <!-- Splash -->
  <div id="splash" class="splash" aria-modal="true" role="dialog">
    <div class="splash-card">
      <button id="themeToggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">🌙</button>
      <div class="logo-wrap">
        <div class="sparkle"></div>
        <div class="logo" aria-hidden="true">T</div>
      </div>
      <div class="splash-title">TASK Assistant — Ask Anything</div>
      <div class="splash-sub">Task Employment Services • Clear steps, quick actions. Use Engage by Cell to complete tasks.</div>
      <div class="actions"><button id="start" class="btn" autofocus>Start</button></div>
    </div>
  </div>

  <!-- App -->
  <div class="app hidden" id="app">
    <header>
      <div class="logo-sm-wrap">
        <div class="sparkle-sm" id="sparkleSm"></div>
        <div class="logo-sm" aria-hidden="true">T</div>
      </div>
      <div>
        <div style="font-weight:700;">TASK Assistant</div>
        <div class="muted">You can ask anything — resumes, interviews, training dates.</div>
      </div>
      <div style="margin-left:auto;" class="muted" id="providerTag" aria-live="polite"></div>
    </header>

    <div id="chat" class="chat" aria-live="polite">
      <div class="settings-bar">
        <button id="settingsTheme" class="settings-link" type="button" title="Theme">Theme</button>
        <a id="openEngageTop" class="settings-link" href="https://bycell.co/ddmnx" target="_blank" rel="noopener">Open Engage</a>
        <a class="settings-link" href="tel:+16096976215">Call TASK: (609) 697-6215</a>
        <a class="settings-link" href="tel:+16096976166">Call TASK: (609) 697-6166</a>
        <a class="settings-link" href="tel:+16093371624" title="No walk-ins">Appointments: (609) 337-1624</a>
        <div class="spacer"></div>
        <span id="settingsInfo" class="muted">Settings</span>
      </div>
      <div class="chat-body" id="chatBody"></div>
    </div>

    <div id="suggestions" class="chips hidden" aria-label="Suggestions"></div>

    <form id="composer" class="row" autocomplete="off">
      <button id="sparkleBtn" class="icon-btn" type="button" title="Ideas"><span id="sparkleGlyph">✨</span></button>
      <input id="input" type="text" placeholder="Type your question…" aria-label="Chat input" />
      <button id="mic" class="icon-btn" type="button" title="Dictate"><span id="micIcon">🎤</span></button>
      <button id="send" type="submit" disabled>Send</button>
    </form>

    <div id="status" class="muted" aria-live="polite"></div>

    <div class="disclaimer">
      This assistant provides general guidance for Task Employment Services and is not a substitute for professional advice.
      If you are in immediate danger call <a href="tel:911">911</a>. For mental health crises in the U.S./Canada call or text <a href="tel:988">988</a>.
      For other inquiries call <a href="tel:+16096976215">(609) 697-6215</a> or <a href="tel:+16096976166">(609) 697-6166</a>.
      Appointments only (no walk-ins): <a href="tel:+16093371624">(609) 337-1624</a>. Use <a href="https://bycell.co/ddmnx" target="_blank" rel="noopener">Engage by Cell</a> to complete tasks.
    </div>
  </div>

  <script>
    /* -------- Links -------- */
    const ENGAGE = {
      landing: "https://bycell.co/ddmnx",
      jobAssistance: "https://bycell.co/ddnke",
      trainingOpps: "https://bycell.co/ddnki",
      resources: "https://bycell.co/ddnkj",
      careerTips: "https://bycell.co/ddmui",
      communityResources: "https://bycell.co/ddmua",
      employmentVerification: "https://bycell.co/ddmwm",
      events: "https://bycell.co/ddmul",
      jobOpenings: "https://bycell.co/ddmtq",
      appointment: "https://bycell.co/ddncs",
      otherServices: "https://bycell.co/ddmud",
      trainings: "https://bycell.co/ddmtn"
    };

    /* -------- Prompt nudge -------- */
    const TASK_NUDGE = `You are TASK Assistant for Task Employment Services.
Provide clear, step-by-step guidance in concise paragraphs.
Use bullet points only for true lists. Avoid bold markdown.
When an action is needed, suggest completing it in Engage by Cell.`;

    /* -------- Theme -------- */
    const root = document.body;
    const themeToggle = document.getElementById('themeToggle');
    function setTheme(t){ root.setAttribute('data-theme', t); themeToggle.textContent = t==='dark'?'🌙':'☀️'; localStorage.setItem('theme', t); }
    setTheme(localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
    themeToggle.addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark'));

    /* -------- Elements -------- */
    const splash  = document.getElementById('splash');
    const app     = document.getElementById('app');
    const startBtn= document.getElementById('start');
    const chat    = document.getElementById('chat');
    const chatBody= document.getElementById('chatBody');
    const form    = document.getElementById('composer');
    const input   = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const statusEl= document.getElementById('status');
    const sparkleSm = document.getElementById('sparkleSm');
    const providerTag = document.getElementById('providerTag');
    const micBtn  = document.getElementById('mic');
    const micIcon = document.getElementById('micIcon');
    const sparkleBtn = document.getElementById('sparkleBtn');
    const sparkleGlyph = document.getElementById('sparkleGlyph');
    const chipsEl = document.getElementById('suggestions'); // ← FIXED: no duplicate const

    document.addEventListener('DOMContentLoaded', ()=>{ /* ensure listeners always attach */ });

    /* -------- Enable Send only when text -------- */
    input.addEventListener('input', ()=> { sendBtn.disabled = input.value.trim().length === 0; });

    /* -------- Audio: single chime -------- */
    let Tone = null, audioReady = false;
    async function ensureAudio() {
      if (!Tone) {
        const mod = await import('https://cdn.jsdelivr.net/npm/tone@15.1.22/build/Tone.js');
        Tone = mod.default || window.Tone || mod;
      }
      if (Tone?.context?.state !== 'running') await Tone.start();
      audioReady = true;
    }
    async function chime(){
      try{
        if (!audioReady) await ensureAudio();
        if (!Tone) return;
        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' } }).toDestination();
        const now = Tone.now();
        ["E5","A5","C#6","E6","A6"].forEach((n,i)=> synth.triggerAttackRelease(n, "8n", now + i*0.06));
      }catch{}
    }

    /* -------- Voice -------- */
    let recognition = null, listening = false;
    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const r = new SR();
      r.lang = 'en-US'; r.interimResults = true; r.continuous = false;
      r.onstart = ()=> { listening = true; micBtn.classList.add('on'); micIcon.textContent='🛑'; };
      r.onend   = ()=> { listening = false; micBtn.classList.remove('on'); micIcon.textContent='🎤'; };
      r.onresult= (e)=> {
        let txt = '';
        for (let i = e.resultIndex; i < e.results.length; i++) txt += e.results[i][0].transcript;
        input.value = txt; sendBtn.disabled = input.value.trim().length===0;
      };
      return r;
    }
    micBtn.addEventListener('click', ()=>{
      if (!recognition) recognition = initSTT();
      if (!recognition) { statusEl.textContent = 'Voice input not supported in this browser.'; return; }
      if (!listening) recognition.start(); else recognition.stop();
    });

    /* -------- Sanitize & linkify -------- */
    function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function linkify(text){
      let s = esc(text);
      s = s.replace(/https?:\/\/[^\s)]+/g, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
      s = s.replace(/(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g, m=>{
        const digits = m.replace(/\D/g,'');
        const tel = digits.length===10 ? `+1${digits}` : (digits.startsWith('1')?`+${digits}`:digits);
        return `<a href="tel:${tel}">${m}</a>`;
      });
      s = s.replace(/\b(911|988)\b/g, x => `<a href="tel:${x}">${x}</a>`);
      return s;
    }

    /* -------- Scroll helper (only autoscroll if near bottom) -------- */
    function maybeScrollToBottom(){
      const threshold = 80;
      const nearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < threshold;
      if (nearBottom) chat.scrollTop = chat.scrollHeight;
    }

    /* -------- Render -------- */
    function bubbleMe(text){
      const div = document.createElement('div');
      div.className = 'bubble me';
      div.textContent = text;
      chatBody.appendChild(div); maybeScrollToBottom();
    }
    function renderSmart(text){
      const cleaned = text.replace(/\*\*/g,'').replace(/^#+\s*/gm,'').replace(/`{1,3}/g,'');
      const lines = cleaned.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const looksLikeList = lines.length >= 2 && lines.some(l=>/^(\*|-|•|\d+\.)\s+/.test(l) || l.endsWith(':'));
      const longBySentences = cleaned.split(/(?<=[.!?])\s+/).filter(Boolean).length >= 4;

      if (looksLikeList || lines.length >= 3 || longBySentences) {
        const ul = document.createElement('ul');
        (lines.length >= 2 ? lines : cleaned.split(/(?<=[.!?])\s+/)).forEach(item=>{
          const norm = item.replace(/^(\*|-|•|\d+\.)\s*/, '').trim();
          if(!norm) return;
          const li = document.createElement('li');
          li.innerHTML = linkify(norm);
          ul.appendChild(li);
        });
        return ul;
      } else {
        const p = document.createElement('div');
        p.innerHTML = linkify(cleaned);
        return p;
      }
    }
    function bubbleBot(text){
      const div = document.createElement('div');
      div.className = 'bubble bot';
      div.appendChild(renderSmart(text));
      chatBody.appendChild(div); maybeScrollToBottom();
    }
    function setStatus(msg, isError=false){
      statusEl.textContent = msg || '';
      statusEl.className = isError ? 'error' : 'muted';
    }

    /* -------- Chips -------- */
    function showChips(items){
      chipsEl.innerHTML = '';
      const seen = new Set();
      (items || []).forEach(it=>{
        const key = (it.type||'p') + (it.href||it.text);
        if (seen.has(key)) return; seen.add(key);
        if (it.type === 'link') {
          const a = document.createElement('a');
          a.href = it.href; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'chip chip-link'; a.textContent = it.label;
          chipsEl.appendChild(a);
        } else {
          const b = document.createElement('button');
          b.className = 'chip'; b.type = 'button'; b.textContent = it.text;
          b.addEventListener('click', ()=> { input.value = it.text; input.focus(); sendBtn.disabled=false; });
          chipsEl.appendChild(b);
        }
      });
      chipsEl.classList.toggle('hidden', !items || items.length === 0);
    }
    function routeEngageChips(text=''){
      const t = text.toLowerCase();
      const picks = [{ type:'link', label:'Open Engage', href: ENGAGE.landing }];
      if (/(job|hiring|apply|opening|posting)/.test(t)) picks.push({ type:'link', label:'Job Openings', href: ENGAGE.jobOpenings }, { type:'link', label:'Job Assistance', href: ENGAGE.jobAssistance });
      if (/(resume|cover|cv|interview|tips)/.test(t)) picks.push({ type:'link', label:'Career Tips', href: ENGAGE.careerTips }, { type:'link', label:'Job Assistance', href: ENGAGE.jobAssistance });
      if (/(training|class|course|certificate|program)/.test(t)) picks.push({ type:'link', label:'Training Opportunities', href: ENGAGE.trainingOpps }, { type:'link', label:'Trainings', href: ENGAGE.trainings });
      if (/(resource|support|help|benefit|food|housing)/.test(t)) picks.push({ type:'link', label:'Resources', href: ENGAGE.resources }, { type:'link', label:'Community Resources', href: ENGAGE.communityResources });
      if (/(verify|verification|employment verification)/.test(t)) picks.push({ type:'link', label:'Employment Verification', href: ENGAGE.employmentVerification });
      if (/(event|workshop|fair)/.test(t)) picks.push({ type:'link', label:'Events', href: ENGAGE.events });
      if (/(appoint|schedule|meet)/.test(t)) picks.push({ type:'link', label:'Make an Appointment', href: ENGAGE.appointment }, { type:'link', label:'Call Appointments: (609) 337-1624', href: 'tel:+16093371624' });
      if (picks.length === 1) picks.push({ type:'link', label:'Other TASK Services', href: ENGAGE.otherServices });
      return picks.slice(0,4);
    }

    /* -------- API -------- */
    const history = [];
    async function askAI(prompt){
      const res = await fetch('/api/ai', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt: `${TASK_NUDGE}\n\nUser: ${prompt}`, history })
      });
      if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(`Upstream error: ${res.status} ${res.statusText}\n${t}`); }
      return res.json();
    }
    async function getSuggestion(lastUserMessage){
      const res = await fetch('/api/suggest', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ lastUserMessage })
      });
      if (!res.ok) return null;
      const j = await res.json().catch(()=> null);
      return j?.suggestion || null;
    }
    async function getSuggestionsN(lastUserMessage, n=3){
      const arr = [];
      for (let i=0;i<n;i++){
        const s = await getSuggestion(lastUserMessage);
        if (s && !arr.includes(s)) arr.push(s);
      }
      return arr;
    }

    /* -------- Start / Send -------- */
    startBtn.addEventListener('click', async ()=>{
      try { await ensureAudio(); } catch {}
      splash.classList.add('hidden');
      app.classList.remove('hidden');
      requestAnimationFrame(()=> input.focus());
    });

    document.getElementById('settingsTheme').addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark'));

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const prompt = input.value.trim();
      if (!prompt) return;

      showChips([]);
      bubbleMe(prompt);
      input.value = ''; sendBtn.disabled = true;
      setStatus('Thinking…');
      sparkleGlyph.classList.add('spin');

      try {
        const json = await askAI(prompt);
        const text = json?.text || '(no response)';
        providerTag.textContent = json?.provider ? `via ${json.provider}` : '';
        history.push({ role:'user', text: prompt });
        history.push({ role:'assistant', text });

        bubbleBot(text);
        setStatus('');
        chime();

        const chips = routeEngageChips(prompt);
        const suggestion = await getSuggestion(prompt);
        if (suggestion) chips.push({ type:'prompt', text:suggestion });
        showChips(chips);

        sparkleSm.classList.add('on'); setTimeout(()=>sparkleSm.classList.remove('on'), 600);
      } catch (err) {
        console.error(err);
        setStatus(err.message || String(err), true);
        bubbleBot('Sorry — I couldn’t reach the AI service. Please try again.');
      } finally {
        sparkleGlyph.classList.remove('spin');
      }
    });

    /* -------- Sparkle (ideas) -------- */
    sparkleBtn.addEventListener('click', async ()=>{
      const lastUser = [...history].reverse().find(m => m.role === 'user')?.text || input.value.trim() || 'employment help';
      sparkleGlyph.classList.add('spin');
      try {
        const ideas = await getSuggestionsN(lastUser, 3);
        const chips = routeEngageChips(lastUser);
        ideas.forEach(s => chips.push({ type:'prompt', text:s }));
        showChips(chips);
        chime();
      } finally {
        sparkleGlyph.classList.remove('spin');
      }
    });

    /* -------- Starters -------- */
    bubbleBot('Here’s what I can help with today:');
    bubbleBot([
      'Tailor a resume to a job posting.',
      'Prep quick interview talking points.',
      'Find local trainings & prerequisites.',
      'Draft outreach messages to employers.',
      'Next steps after applying.'
    ].join('\n'));
    showChips([{ type:'link', label:'Open Engage', href: ENGAGE.landing }, { type:'link', label:'Other TASK Services', href: ENGAGE.otherServices }]);
  </script>
</body>
</html>
