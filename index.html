<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TASK Employment Assistant</title>

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

<!-- Safe sanitizer for AI HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" defer></script>

<style>
  :root{
    --brand:#FF911F;        /* Orange (user bubbles / primary action) */
    --accent:#145078;       /* Blue (assistant bubbles / header / cards) */
    --bg:#0a0f1a;           /* Page background */
    --surface:#111929;      /* Card */
    --surface-2:#0e1625;    /* Chat background */
    --text:#eaf2ff;         /* Text */
    --muted:#a7bad5;        /* Secondary text */
    --border:#344b6b;       /* Lines */
    --shadow:0 10px 20px rgba(0,0,0,.25);
    --shadow-soft:0 6px 14px rgba(0,0,0,.18);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:flex; align-items:center; justify-content:center;
    min-height:100vh;
  }

  /* App shell */
  .container{
    width:100%; max-width:980px; height:100vh;
    display:flex; flex-direction:column; position:relative;
    background:var(--surface); border:1px solid var(--border); border-radius:22px;
    box-shadow:var(--shadow); overflow:hidden;
  }
  .header{
    display:flex; align-items:center; justify-content:center;
    padding:12px 16px; background:var(--surface);
    border-bottom:1px solid var(--border);
    font-family:"Nunito",sans-serif;
    position:relative;
  }
  .title{font-weight:800; letter-spacing:.2px; color:var(--accent); font-size:1.1rem}
  .header-right{position:absolute; right:10px; top:8px; display:flex; gap:8px}
  .icon-btn{
    width:38px;height:38px;border-radius:50%;border:1px solid var(--border);
    background:transparent;color:var(--text);display:grid;place-items:center;
    cursor:pointer; transition:.15s all;
  }
  .icon-btn:hover{background:rgba(255,255,255,.06)}

  /* Chat area */
  .chat{
    flex:1; overflow:auto; background:var(--surface-2); padding:22px 18px 160px;
  }
  .row{
    display:flex; gap:10px; align-items:flex-start; margin:14px 0;
    animation:pop .2s ease-out;
  }
  @keyframes pop{from{opacity:0;transform:translateY(10px) scale(.98)} to{opacity:1;transform:translateY(0) scale(1)}}
  .avatar{
    flex:0 0 34px; height:34px; border-radius:50%; background:var(--accent);
    color:#fff; display:grid; place-items:center; font-weight:800; font-family:"Nunito",sans-serif;
  }
  .bubble{
    max-width:75%; background:var(--surface); border:1px solid var(--border);
    border-radius:18px; padding:12px 14px; line-height:1.55; box-shadow:var(--shadow-soft);
    font-size:16px;
  }
  /* two-sided layout */
  .row.user{ justify-content:flex-end }
  .row.user .avatar{ order:2; background:var(--brand) }
  .row.user .bubble{
    order:1; background:var(--brand); color:#fff; border-color:transparent;
    border-radius:18px 18px 6px 18px; max-width:48%;
  }
  .row.bot .bubble{
    border-radius:18px 18px 18px 6px; max-width:48%;
  }
  .bubble ul{margin:.5em 0 .5em 1.2em}
  .bubble li{margin:.25em 0}

  /* Input area + status */
  .input-wrap{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:64px; width:100%; max-width:980px; padding:8px 14px; z-index:50;
    background:transparent;
  }
  .input-row{
    display:grid; grid-template-columns:46px 1fr 46px; gap:8px;
    background:var(--surface); border:1px solid var(--border);
    border-radius:999px; padding:8px; box-shadow:var(--shadow-soft);
  }
  #box{
    border:0; outline:0; font-size:1rem; background:transparent; color:var(--text);
  }
  .send-btn{
    width:46px;height:46px;border:0;border-radius:50%;
    background:var(--brand); color:#fff; cursor:pointer; display:grid; place-items:center;
    box-shadow:var(--shadow-soft); transition:.12s background;
  }
  .send-btn:hover{ background:var(--accent); }
  .send-btn:disabled{ opacity:.6; cursor:not-allowed }
  .sparkle-btn{
    width:46px;height:46px;border:2px solid var(--brand);
    color:var(--brand); background:transparent; border-radius:50%;
    font-size:18px; font-weight:900; cursor:pointer; display:grid; place-items:center;
  }
  .sparkle-btn:hover{ background:rgba(255,145,31,0.14); }

  .status-line{
    margin-top:6px; font-size:.9rem; color:var(--muted);
    text-align:left; padding-left:8px;
  }

  /* Suggestions tray */
  #sparkleTray{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:130px; width:100%; max-width:980px; z-index:40; display:none;
  }
  .sparkle-pills{ display:flex; flex-wrap:wrap; gap:8px; padding:8px 14px; }
  .sparkle-pill{
    border:2px solid var(--accent); background:var(--surface);
    color:var(--accent); border-radius:999px; padding:8px 12px;
    font-weight:700; cursor:pointer; font-size:.92rem;
  }
  .sparkle-pill:hover{ background:var(--accent); color:#fff; }

  /* Typing dots */
  .typing{ display:inline-flex; gap:6px; align-items:center; }
  .typing .dot{
    width:7px;height:7px;border-radius:50%;background:var(--muted);opacity:.7;
    animation:bounce 1s infinite ease-in-out;
  }
  .typing .dot:nth-child(2){animation-delay:.2s}
  .typing .dot:nth-child(3){animation-delay:.4s}
  @keyframes bounce{0%,80%,100%{transform:scale(.6)}40%{transform:scale(1)}}

  /* Legal disclaimer */
  .legal-disclaimer{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:0; width:100%; max-width:980px; padding:8px 14px;
    background:var(--accent); color:#fff; text-align:center; font-size:.85rem;
    z-index:60;
  }

  /* Splash */
  #splash{
    position:fixed; inset:0; background:var(--bg); color:#fff; z-index:999;
    display:flex; align-items:center; justify-content:center; flex-direction:column;
    font-family:"Nunito",sans-serif; gap:16px; text-align:center;
    transition:opacity .4s ease;
  }
  .splash-card{
    background:#0f1b2c; border:1px solid rgba(255,255,255,.15);
    border-radius:16px; padding:28px 26px; box-shadow:var(--shadow);
    max-width:720px; width:90%;
  }
  .splash-btn{
    background:var(--brand); color:#fff; border:0;
    font-weight:800; border-radius:999px; padding:12px 20px; cursor:pointer;
  }
  .splash-btn:hover{ filter:brightness(.95) }
  .splash-logo{ width:128px; height:auto; margin:4px auto 6px; display:block; }

  /* Quick actions + planner modal */
  .quick-card{
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
    box-shadow:var(--shadow-soft);
    margin-bottom:10px;
  }
  .quick-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
    gap:10px;
  }
  .qbtn{
    width:100%; text-align:left;
    background:var(--surface-2);
    color:var(--text);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    cursor:pointer; transition:.15s all;
  }
  .qbtn:hover{ background:rgba(255,255,255,.06) }
  .qbtn small{ display:block; color:var(--muted); }

  #planner{
    position:fixed; inset:0; display:none; place-items:center; z-index:900;
    background:rgba(0,0,0,.5);
  }
  .planner-card{
    width:min(520px,92vw);
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:16px;
    box-shadow:var(--shadow);
  }
  .planner-card h3{ margin:0 0 8px }
  .input-row-vert{ display:flex; flex-direction:column; gap:8px; }
  .input-row-vert input{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    background:var(--surface-2); color:var(--text);
  }
  .planner-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }
  .btn{ border:1px solid var(--border); background:var(--surface-2); color:var(--text);
        padding:10px 14px; border-radius:10px; cursor:pointer; }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
  .btn:hover{ filter:brightness(.95) }
</style>
</head>

<body>
  <!-- Splash -->
  <div id="splash" role="dialog" aria-modal="true">
    <div class="splash-card">
      <img src="OIP.jpeg" alt="TASK logo" class="splash-logo" onerror="this.style.display='none'">
      <h1 style="margin:0 0 6px; font-weight:800; text-align:center">TASK Employment Assistant</h1>
      <p style="margin:0 0 16px;opacity:.9; text-align:center">
        Focused on <b>getting ready for work</b>, <b>finding work</b>, and <b>keeping work</b> ‚Äî with direct links to TASK resources.
      </p>
      <div style="display:flex; justify-content:center; margin-top:10px">
        <button id="startBtn" class="splash-btn" aria-label="Start">Start</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <main class="container" id="app" style="display:none">
    <header class="header">
      <div class="title">Employment Assistant</div>
      <div class="header-right">
        <button id="resetBtn" class="icon-btn" title="Clear chat" aria-label="Clear chat">‚Ü∫</button>
      </div>
    </header>

    <section id="chat" class="chat" role="log" aria-live="polite" aria-relevant="additions"></section>

    <!-- Suggestions tray (sparkle) -->
    <div id="sparkleTray" aria-label="Suggestions">
      <div class="sparkle-pills" id="sparklePills"></div>
    </div>

    <!-- Input + status -->
    <div class="input-wrap">
      <div class="input-row">
        <button id="sparkleBtn" class="sparkle-btn" title="Suggestions" aria-label="Suggestions">‚ú¶</button>
        <input id="box" type="text" placeholder="Type your message..." autocomplete="off" aria-label="Message to assistant"/>
        <button id="sendBtn" class="send-btn" aria-label="Send">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
            <path d="M2 21l20-9L2 3l3 7 9 2-9 2-3 7z" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div id="statusLine" class="status-line" role="status">
        ‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info.
      </div>
    </div>

    <div class="legal-disclaimer">
      Disclaimer: This assistant is for informational purposes only and is not legal, financial, or employment advice.
    </div>

    <!-- NJ Transit / planner modal -->
    <div id="planner" role="dialog" aria-modal="true" aria-labelledby="plannerTitle">
      <div class="planner-card">
        <h3 id="plannerTitle">Plan a Bus/Transit Route</h3>
        <div class="input-row-vert">
          <input id="fromField" type="text" placeholder="From (address or place)" />
          <input id="toField"   type="text" placeholder="To (default: TASK, 72 Escher St, Trenton, NJ)" />
          <small style="color:var(--muted)">Opens Google Maps in transit mode.</small>
        </div>
        <div class="planner-actions">
          <button class="btn" id="plannerClose">Cancel</button>
          <button class="btn primary" id="plannerGo">Open Directions</button>
        </div>
      </div>
    </div>
  </main>

<script>
(() => {
  'use strict';

  /* -------- TASK constants -------- */
  const TASK = {
    address: "72 Escher St, Trenton, NJ 08609",
    site: "https://trentonsoupkitchen.org/",
    employment: "https://trentonsoupkitchen.org/job-search-and-assistance/",
    getHelpEmployment: "https://trentonsoupkitchen.org/get-help/#job-search-employment-services",
    arts: "https://trentonsoupkitchen.org/creative-arts-program/",
    bycell: [
      "https://bycell.co/ddmnx",
      "https://bycell.co/ddmui",
      "https://bycell.co/ddmua",
      "https://bycell.co/ddmwm",
      "https://bycell.co/ddmul",
      "https://bycell.co/ddmtq",
      "https://bycell.co/ddncs",
      "https://bycell.co/ddmtn"
    ],
    phones: {
      employment1: "609-697-6215",
      employment2: "609-697-6166",
      appointments: "609-337-1624"
    }
  };

  /* ---------- DOM refs ---------- */
  const splash   = document.getElementById('splash');
  const startBtn = document.getElementById('startBtn');
  const app      = document.getElementById('app');
  const chat     = document.getElementById('chat');
  const box      = document.getElementById('box');
  const sendBtn  = document.getElementById('sendBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusLine = document.getElementById('statusLine');

  const sparkleBtn  = document.getElementById('sparkleBtn');
  const sparkleTray = document.getElementById('sparkleTray');
  const sparklePills= document.getElementById('sparklePills');

  const planner = document.getElementById('planner');
  const plannerClose = document.getElementById('plannerClose');
  const plannerGo = document.getElementById('plannerGo');
  const fromField = document.getElementById('fromField');
  const toField   = document.getElementById('toField');

  /* ---------- helpers ---------- */
  function openLink(url){ try{ window.open(url, '_blank', 'noopener'); }catch(e){} }
  function callNumber(n){ window.location.href = `tel:${String(n).replace(/[^\d+]/g,'')}`; }
  function escapeHTML(s){
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function scrollToBottom(){ requestAnimationFrame(() => { chat.scrollTop = chat.scrollHeight; }); }

  function addUser(text){
    const row = document.createElement('div');
    row.className = 'row user';
    row.innerHTML = `
      <div class="bubble">${escapeHTML(text)}</div>
      <div class="avatar" aria-hidden="true">U</div>
    `;
    chat.appendChild(row);
    scrollToBottom();
  }

  function addBot(html){
    const safe = DOMPurify.sanitize(html);
    const row = document.createElement('div');
    row.className = 'row bot';
    row.innerHTML = `
      <div class="avatar" aria-hidden="true">E</div>
      <div class="bubble">${safe}</div>
    `;
    chat.appendChild(row);
    scrollToBottom();
  }

  function typing(on){
    const id='typing-row';
    if (on){
      if (document.getElementById(id)) return;
      const row = document.createElement('div');
      row.id = id;
      row.className = 'row bot';
      row.innerHTML = `
        <div class="avatar" aria-hidden="true">E</div>
        <div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>
      `;
      chat.appendChild(row);
    } else {
      const r = document.getElementById(id);
      if (r) r.remove();
    }
    scrollToBottom();
  }

  function clearChat(){
    chat.innerHTML = "";
    statusLine.textContent = "‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info.";
  }

  /* ---------- suggestions ---------- */
  const SUGGESTIONS = [
    "Find entry-level jobs in Mercer County",
    "Draft a cover letter for warehouse work",
    "Create a 2-week job search plan",
    "Prepare for an Amazon interview",
    "List TASK services and address",
    "Check a message for job-scam red flags",
    "Explain PTO vs. FMLA vs. 401(k) simply",
    "Find bus routes to TASK from my address"
  ];
  function renderPills(){
    sparklePills.innerHTML = "";
    SUGGESTIONS.forEach(txt => {
      const btn = document.createElement('button');
      btn.className = 'sparkle-pill';
      btn.textContent = txt;
      btn.addEventListener('click', () => {
        box.value = txt;
        sparkleTray.style.display = 'none';
        send();
      });
      sparklePills.appendChild(btn);
    });
  }
  sparkleBtn.addEventListener('click', () => {
    sparkleTray.style.display =
      (sparkleTray.style.display === 'block') ? 'none' : 'block';
    if (sparkleTray.style.display === 'block') renderPills();
  });

  /* ---------- AI call via local proxy (/ai) ---------- */
  async function askAI(promptText){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort('timeout'), 20000);
    try{
      const r = await fetch('/ai', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: promptText }),
        signal: controller.signal
      });
      clearTimeout(t);
      if (!r.ok) throw new Error(await r.text());
      const data = await r.json();
      return data?.text || 'No reply.';
    }catch(err){
      clearTimeout(t);
      throw err;
    }
  }

  function autoBullet(text){
    // Turn long paragraphs into bullets when lines start with * or -
    const lines = String(text).split(/\r?\n/);
    const hasBullets = lines.some(l => /^\s*[\*\-]\s+/.test(l));
    if (hasBullets){
      const items = lines
        .filter(l => /^\s*[\*\-]\s+/.test(l))
        .map(l => l.replace(/^\s*[\*\-]\s+/, ''))
        .map(escapeHTML)
        .map(li => `<li>${li}</li>`)
        .join("");
      return `<ul>${items}</ul>`;
    }
    // Otherwise split long blocks into shorter paragraphs
    return escapeHTML(text).replace(/\n{2,}/g,'<br><br>').replace(/\n/g,'<br>');
  }

  function setInputEnabled(enabled){
    sendBtn.disabled = !enabled;
    box.disabled = !enabled;
    sparkleBtn.disabled = !enabled;
  }
  function setStatus(msg){
    statusLine.textContent = msg || "‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info.";
  }

  /* ---------- Intent shortcuts (don‚Äôt call AI) ---------- */
  function handledByIntent(text){
    const t = text.toLowerCase();

    // Call / appointment
    if (t.includes("call task") || t.includes("call employment")){
      callNumber(TASK.phones.employment1);
      addBot("Calling TASK Employment Services‚Ä¶");
      return true;
    }
    if (t.includes("appointment") || t.includes("make appointment")){
      callNumber(TASK.phones.appointments);
      addBot("Opening phone dialer for appointments‚Ä¶");
      return true;
    }

    // Open TASK pages
    if (t.includes("task website")){ openLink(TASK.site); addBot("Opening TASK website‚Ä¶"); return true; }
    if (t.includes("job search") || t.includes("employment page")){ openLink(TASK.employment); addBot("Opening TASK Job Search & Assistance‚Ä¶"); return true; }
    if (t.includes("creative arts")){ openLink(TASK.arts); addBot("Opening TASK Creative Arts‚Ä¶"); return true; }

    // ByCell menus
    if (t.includes("bycell") || t.includes("menu")){
      TASK.bycell.forEach(openLink);
      addBot("Opened TASK mobile menu links.");
      return true;
    }

    // Transit planner
    if (t.includes("plan route") || t.includes("bus") || t.includes("nj transit") || t.includes("transit")){
      planner.style.display = 'grid';
      fromField.focus();
      addBot("Enter your start and end, then tap Open Directions.");
      return true;
    }

    // Careers site jump: ‚Äújobs at {company}‚Äù
    const m = t.match(/jobs?\s+at\s+([a-z0-9&\-\s]+)$/i);
    if (m && m[1]){
      const company = m[1].trim();
      const url = `https://www.google.com/search?q=${encodeURIComponent(company+" careers site")}`;
      openLink(url);
      addBot(`Opened official career search for <b>${escapeHTML(company)}</b>.`);
      return true;
    }
    return false;
  }

  /* ---------- send flow ---------- */
  async function send(){
    const text = (box.value || "").trim();
    if (!text) return;

    // short-circuit intents first
    if (handledByIntent(text)){
      addUser(text);
      box.value = '';
      return;
    }

    addUser(text);
    box.value = '';
    box.focus();
    typing(true);
    setInputEnabled(false);
    setStatus("Thinking‚Ä¶");

    try{
      const reply = await askAI(text);
      typing(false);
      setStatus("Ready");
      addBot(autoBullet(reply));
    }catch(err){
      typing(false);
      setStatus("Network or API error. Try again.");
      addBot("Sorry ‚Äî I couldn‚Äôt reach the AI service. Please try again.");
      console.error(err);
    }finally{
      setInputEnabled(true);
    }
  }

  /* ---------- Greet with quick actions ---------- */
  function greet(){
    addBot(`
      <div class="quick-card">
        <strong>Welcome to TASK Employment Assistant</strong><br>
        I can connect you to TASK, plan bus routes, and open official jobs pages.
        <div class="quick-grid" style="margin-top:10px">
          <button class="qbtn" onclick="(function(){ window.location.href='tel:${TASK.phones.employment1}'; })()">
            üìû Employment Services<br><small>${TASK.phones.employment1}</small>
          </button>
          <button class="qbtn" onclick="(function(){ window.location.href='tel:${TASK.phones.employment2}'; })()">
            üìû Employment Training<br><small>${TASK.phones.employment2}</small>
          </button>
          <button class="qbtn" onclick="(function(){ window.location.href='tel:${TASK.phones.appointments}'; })()">
            üìÖ Make Appointment<br><small>${TASK.phones.appointments}</small>
          </button>
          <button class="qbtn" onclick="(function(){ window.open('${TASK.employment}','_blank'); })()">
            üß≠ Job Search & Assistance<br><small>trentonsoupkitchen.org</small>
          </button>
          <button class="qbtn" onclick="(function(){ window.open('${TASK.site}','_blank'); })()">
            üè† TASK Website<br><small>Programs & services</small>
          </button>
          <button class="qbtn" onclick="(function(){ window.open('${TASK.arts}','_blank'); })()">
            üé® Creative Arts Program<br><small>Music ‚Ä¢ Arts ‚Ä¢ More</small>
          </button>
          <button class="qbtn" onclick="(function(){ document.getElementById('planner').style.display='grid'; document.getElementById('fromField').focus(); })()">
            üöå Plan Transit Route<br><small>NJ Transit (via Google Maps)</small>
          </button>
          <button class="qbtn" onclick="(function(){ ${TASK.bycell.map(u=>`window.open('${u}','_blank')`).join(';')} })()">
            üì≤ TASK Mobile Menus (ByCell)<br><small>Open links</small>
          </button>
        </div>
        <small style="display:block;margin-top:8px;color:var(--muted)">
          Address: ${TASK.address}
        </small>
      </div>
    `);

    addBot(`How can I help you today? Try:
      <ul>
        <li>‚ÄúFind warehouse jobs hiring in Mercer County.‚Äù</li>
        <li>‚ÄúPlan a bus route from my address to TASK.‚Äù</li>
        <li>‚ÄúCall TASK Employment Services.‚Äù</li>
        <li>‚ÄúOpen TASK job search page.‚Äù</li>
      </ul>`);
  }

  /* ---------- events ---------- */
  sendBtn.addEventListener('click', send);
  box.addEventListener('keydown', (e) => {
    if (e.key === 'Enter'){ e.preventDefault(); send(); }
  });
  resetBtn.addEventListener('click', () => { clearChat(); greet(); });

  startBtn.addEventListener('click', () => {
    splash.style.opacity = '0';
    setTimeout(() => {
      splash.style.display = 'none';
      app.style.display = 'flex';
      greet();
      box.focus();
    }, 300);
  });

  /* planner controls */
  plannerClose.addEventListener('click', () => { planner.style.display='none'; });
  plannerGo.addEventListener('click', () => {
    const from = encodeURIComponent(fromField.value.trim() || "");
    const to   = encodeURIComponent((toField.value.trim() || TASK.address));
    const url  = `https://www.google.com/maps/dir/?api=1&travelmode=transit&origin=${from}&destination=${to}`;
    window.open(url,'_blank');
  });
})();
</script>
</body>
</html>
