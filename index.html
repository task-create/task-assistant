<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solace ‚Ä¢ TASK Assistant</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ES%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode:'class', theme:{ extend:{ colors:{ brand:'#ff8a00' }}}};
  </script>
  <style>
    :root { --brand:#ff8a00; }
    .custom-scrollbar::-webkit-scrollbar{width:8px;height:8px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:6px}
    .bubble{ word-break:break-word; overflow-wrap:anywhere; }
    .bubble a{ text-decoration:underline }
    .composer-shell{position:sticky;bottom:0;background:linear-gradient(to top,rgba(255,255,255,.96),rgba(255,255,255,0))}
    .dark .composer-shell{background:linear-gradient(to top,rgba(15,23,42,.96),rgba(15,23,42,0))}
  </style>
</head>
<body class="bg-gray-100 dark:bg-[#0b1220] text-gray-900 dark:text-gray-100 antialiased">

<!-- Splash -->
<div id="splash" class="fixed inset-0 z-50 grid place-items-center bg-gray-100 dark:bg-[#0b1220]">
  <div class="relative w-full max-w-md p-8 bg-white dark:bg-[#0f172a] rounded-2xl border border-gray-200 dark:border-gray-700 shadow-2xl text-center">
    <!-- Theme toggle (top-left as sun/moon) -->
    <button id="btnThemeSplash" class="absolute left-3 top-3 p-2 rounded-full border border-gray-200 dark:border-gray-700" title="Toggle theme" aria-label="Toggle theme">
      <span id="themeIconSplash">‚òÄÔ∏è</span>
    </button>

    <div class="w-20 h-20 mx-auto rounded-2xl bg-brand text-black font-black grid place-items-center text-4xl">S</div>
    <h1 class="mt-4 text-2xl font-bold">Solace</h1>
    <p class="mt-2 text-gray-600 dark:text-gray-400">Your guide to career and community resources.</p>
    <div class="mt-6">
      <button id="btnStart" class="px-6 py-2 rounded-lg bg-brand text-black font-semibold">Start</button>
    </div>
  </div>
</div>

<!-- App -->
<div id="app" class="h-screen w-screen grid lg:grid-cols-[280px_1fr] hidden">

  <!-- Sidebar -->
  <aside class="flex flex-col h-full border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-[#0f172a]">
    <div class="p-3 flex items-center gap-3 border-b border-gray-100 dark:border-gray-800">
      <div class="w-9 h-9 rounded-lg bg-brand text-black font-bold grid place-items-center">S</div>
      <div class="font-semibold">Solace</div>
    </div>

    <div class="p-3">
      <button id="btnNew" class="w-full px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">New Chat</button>
    </div>

    <div class="px-3">
      <h3 class="text-xs font-semibold text-gray-500 uppercase">Quick Actions</h3>
      <div id="quick" class="mt-2 space-y-2"></div>
    </div>

    <div class="p-3 flex-1 custom-scrollbar overflow-y-auto">
      <h3 class="text-xs font-semibold text-gray-500 uppercase">Recent</h3>
      <div id="history" class="mt-2 space-y-1"></div>
    </div>

    <!-- Theme at bottom -->
    <div class="p-3 border-t border-gray-200 dark:border-gray-800">
      <button id="btnTheme" class="w-full px-3 py-2 rounded-md border border-gray-200 dark:border-gray-700">
        <span id="themeIconSide">‚òÄÔ∏è</span> Theme
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex flex-col h-screen">

    <!-- Main header with title + Rename/Delete -->
    <header class="hidden lg:flex items-center justify-between px-4 py-3 bg-white dark:bg-[#0f172a] border-b border-gray-200 dark:border-gray-800">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-md bg-brand text-black font-bold grid place-items-center">S</div>
        <div id="chatTitle" class="font-semibold truncate">New chat</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnRename" class="px-3 py-1.5 rounded-md border border-gray-200 dark:border-gray-700">Rename</button>
        <button id="btnDelete" class="px-3 py-1.5 rounded-md border border-gray-200 dark:border-gray-700">Delete</button>
        <button id="btnThemeM" class="px-3 py-1.5 rounded-md border border-gray-200 dark:border-gray-700"><span id="themeIconM">‚òÄÔ∏è</span></button>
      </div>
    </header>

    <!-- Chat scroll -->
    <section id="chatWrap" class="flex-1 overflow-y-auto custom-scrollbar p-4">
      <div id="chatBody" class="max-w-3xl mx-auto space-y-3">
        <div class="text-center mt-8 text-gray-600 dark:text-gray-400">
          <div class="w-16 h-16 mx-auto rounded-xl bg-brand text-black font-black grid place-items-center text-3xl">S</div>
          <p class="mt-3">How can I help you today?</p>
        </div>
      </div>
    </section>

    <!-- Composer -->
    <div class="composer-shell px-4 py-3 md:px-6 md:py-4">
      <form id="composer" class="max-w-3xl mx-auto relative">
        <textarea id="input" rows="1" placeholder="Ask about trainings, jobs, resources, appointments‚Ä¶"
          class="w-full p-4 pr-16 rounded-xl bg-white dark:bg-[#0f172a] border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-brand resize-none"></textarea>
        <button id="send" class="absolute right-2 bottom-2 px-3 py-2 rounded-lg bg-brand text-black font-semibold disabled:bg-gray-400" disabled>Send</button>
      </form>
      <p class="max-w-3xl mx-auto mt-2 text-xs text-gray-500">
        Solace can make mistakes ‚Äî please confirm important info with TASK staff.
      </p>
    </div>
  </main>
</div>

<script type="module">
/* --------------------------- Config --------------------------- */
const ENGAGE = {
  appointment:"https://bycell.co/ddncs",
  jobs:"https://bycell.co/ddmtq",
  trainings:"https://bycell.co/ddmtn",
  resources:"https://bycell.co/ddmua",
};
const API_AI = (location.hostname.endsWith("task-assistant-xi.vercel.app") || location.hostname==="localhost")
  ? "/api/ai"
  : "https://task-assistant-xi.vercel.app/api/ai";

/* --------------------------- Theme --------------------------- */
const sun = "‚òÄÔ∏è", moon = "üåô";
function setThemeIcon(isDark){
  const icon = isDark ? sun : moon; // show opposite so the button indicates the toggle
  ["themeIconSplash","themeIconSide","themeIconM"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent = icon;
  });
}
function applyTheme(mode){
  document.documentElement.classList.toggle('dark', mode==='dark');
  localStorage.setItem('theme', mode);
  setThemeIcon(mode==='dark');
}
function toggleTheme(){ applyTheme(localStorage.getItem('theme')==='dark'?'light':'dark'); }
applyTheme(localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
["btnThemeSplash","btnTheme","btnThemeM"].forEach(id=>document.getElementById(id)?.addEventListener('click', toggleTheme));

/* Splash ‚Üí App */
document.getElementById('btnStart').addEventListener('click', ()=>{
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
});

/* --------------------------- Chat state --------------------------- */
let chats = JSON.parse(localStorage.getItem('chats')||'{}');
let activeId = localStorage.getItem('activeId') || null;
let lastTopic = null;                // <-- sticky topic

/* Transit flow state */
const transit = { active:false, origin:null, destination:null };

/* --------------------------- Utils --------------------------- */
function save(){
  localStorage.setItem('chats', JSON.stringify(chats));
  localStorage.setItem('activeId', activeId||'');
}
function newId(){ return 'c_'+Date.now(); }
function ensureChat(){
  if(!activeId || !chats[activeId]){
    activeId=newId(); chats[activeId]={id:activeId,title:'New chat',messages:[]};
    save(); renderHistory();
  }
}
function linkify(s=''){
  let out = s.replace(/(https?:\/\/[^\s)]+)\b/gi, m => `<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
  out = out.replace(/(\(\d{3}\)\s?\d{3}-\d{4}|\b\d{3}[-.\s]\d{3}[-.\s]\d{4}\b)/g, m => `<a href="tel:${m.replace(/[^\d]/g,'')}">${m}</a>`);
  return out;
}
function bubble(role, html){
  const w=document.createElement('div');
  w.className=`flex ${role==='user'?'justify-end':'justify-start'}`;
  const b=document.createElement('div');
  b.className=`bubble max-w-[85%] rounded-2xl px-4 py-3 shadow text-sm leading-6 ${
    role==='user' ? 'bg-brand text-black' : 'bg-white dark:bg-[#0f172a] border border-gray-200 dark:border-gray-700'
  }`;
  b.innerHTML = html;
  w.appendChild(b);
  return w;
}
function addMsg(role, html){
  ensureChat();
  chats[activeId].messages.push({ role, html, ts: Date.now() });
  if(role==='user' && (chats[activeId].title||'')==='New chat'){
    const t = html.replace(/<[^>]+>/g,'').slice(0,40);
    chats[activeId].title = t || 'New chat';
  }
  save(); renderChat(); renderHistory();
}
function scrollToBottom(){ document.getElementById('chatWrap')?.scrollTo({ top: 9e9, behavior:'smooth' }); }

/* --------------------------- Renderers --------------------------- */
function renderQuick(){
  const q=document.getElementById('quick'); q.innerHTML='';
  const items=[
    {label:'Schedule Appointment',href:ENGAGE.appointment,emoji:'üìÖ'},
    {label:'Find Jobs',href:ENGAGE.jobs,emoji:'üîé'},
    {label:'Training Programs',href:ENGAGE.trainings,emoji:'üéì'},
    {label:'Community Resources',href:ENGAGE.resources,emoji:'üìö'},
    {label:'NJ TRANSIT Trip Planner',href:'#',emoji:'üöå',onClick:startTransit}
  ];
  items.forEach(it=>{
    const el=document.createElement(it.href==='#'?'button':'a');
    el.className='w-full flex items-center justify-between px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700';
    el.innerHTML=`<span class="flex items-center gap-2"><span>${it.emoji}</span><span>${it.label}</span></span><span>‚Ä∫</span>`;
    if(it.href==='#'){ el.onclick=it.onClick; } else { el.href=it.href; el.target='_blank'; el.rel='noopener noreferrer'; }
    q.appendChild(el);
  });
}
function renderHistory(){
  const h=document.getElementById('history'); h.innerHTML='';
  Object.values(chats).sort((a,b)=>b.id.localeCompare(a.id)).forEach(c=>{
    const btn=document.createElement('button');
    btn.className=`w-full text-left px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 ${c.id===activeId?'bg-brand/20':''}`;
    btn.textContent=c.title||'Untitled';
    btn.onclick=()=>{ activeId=c.id; save(); renderChat(); renderHistory(); };
    h.appendChild(btn);
  });
}
function renderChat(){
  const title=document.getElementById('chatTitle'); title.textContent = (chats[activeId]?.title)||'New chat';
  const body=document.getElementById('chatBody'); body.innerHTML='';
  const items=(chats[activeId]?.messages)||[];
  if(!items.length){
    const empty=document.createElement('div');
    empty.className='text-center mt-8 text-gray-600 dark:text-gray-400';
    empty.innerHTML=`<div class="w-16 h-16 mx-auto rounded-xl bg-brand text-black font-black grid place-items-center text-3xl">S</div><p class="mt-3">How can I help you today?</p>`;
    body.appendChild(empty);
  }else{
    items.forEach(m=> body.appendChild(bubble(m.role, m.html)));
  }
  scrollToBottom();
}

/* --------------------------- NJ TRANSIT flow --------------------------- */
function startTransit(){ transit.active=true; transit.origin=null; transit.destination=null; addMsg('assistant','üöå Sure ‚Äî let‚Äôs plan your trip. <b>What is your <i>origin</i> address?</b>'); }
function maybeStartTransitByText(t){ if(/\bnj\s*transit\b|\btrip\s*planner\b/i.test(t)&&!transit.active){ startTransit(); return true; } return false; }
function handleTransitStep(t){
  if(!transit.active) return false;
  if(!transit.origin){ transit.origin=t.trim(); addMsg('assistant','Got it. <b>What is your destination address?</b>'); return true; }
  if(!transit.destination){
    transit.destination=t.trim();
    const o=encodeURIComponent(transit.origin), d=encodeURIComponent(transit.destination);
    const njt=`https://www.njtransit.com/trip-planner?from=${o}&to=${d}&mode=transit`;
    const g=`https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}&travelmode=transit`;
    addMsg('assistant', `Here are your pre-filled links:<br>‚Ä¢ <a href="${njt}" target="_blank" rel="noopener">NJ TRANSIT Trip Planner</a><br>‚Ä¢ <a href="${g}" target="_blank" rel="noopener">Google Maps (Transit)</a><br>Safe travels! üöÜ`);
    transit.active=false; return true;
  }
  return false;
}

/* ---------------- Sticky topic detection ---------------- */
function detectTopicFromUserText(t) {
  const s = t.toLowerCase();
  if (/\bsora\b|\bsecurity\s*(officer|guard)\b/.test(s)) return "sora";
  if (/\bemilio\b|\bculinary\b/.test(s)) return "emilio";
  if (/\bforklift\b/.test(s)) return "forklift";
  if (/\bappointment\b|\bschedule\b|\bmake\s+an?\s+appointment\b/.test(s)) return "appointment";
  if (/\bnj\s*transit\b|\btrip\s*planner\b/.test(s)) return "njt";
  if (/\bresource(s)?\b/.test(s)) return "resources";
  if (/\bjobs?\b/.test(s)) return "jobs";
  return lastTopic;
}

/* --------------------------- Network --------------------------- */
async function fetchAI(prompt){
  const r = await fetch(API_AI, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
    body: JSON.stringify({ prompt, context: { lastTopic } })   // send sticky topic
  });
  if(!r.ok){
    const t = await r.text().catch(()=> '');
    throw new Error(t || `HTTP ${r.status}`);
  }
  const j = await r.json().catch(()=> ({}));
  if (j.topic) lastTopic = j.topic;                            // update sticky topic from server
  return j.text || j.reply || '(no response)';
}

/* --------------------------- Boot --------------------------- */
function init(){
  ensureChat(); renderQuick(); renderHistory(); renderChat();

  document.getElementById('btnNew').onclick = ()=>{ activeId=newId(); chats[activeId]={id:activeId,title:'New chat',messages:[]}; save(); renderHistory(); renderChat(); };
  document.getElementById('btnRename').onclick = ()=>{ ensureChat(); const t=prompt('Rename chat:',chats[activeId].title||''); if(t){chats[activeId].title=t.trim(); save(); renderHistory(); renderChat();} };
  document.getElementById('btnDelete').onclick = ()=>{ if(!activeId) return; if(confirm('Delete this chat?')){ delete chats[activeId]; activeId=Object.keys(chats)[0]||null; save(); renderHistory(); renderChat(); } };

  const input=document.getElementById('input'), send=document.getElementById('send'), form=document.getElementById('composer');
  const up=()=> send.disabled=!input.value.trim(); ['input','keyup','change','paste'].forEach(ev=> input.addEventListener(ev,up)); up();
  input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); form.requestSubmit(); }});

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const raw=input.value.trim(); if(!raw) return;
    lastTopic = detectTopicFromUserText(raw);        // keep topic sticky

    input.value=''; up();

    if(maybeStartTransitByText(raw) || handleTransitStep(raw)){ addMsg('user', linkify(raw)); return; }

    addMsg('user', linkify(raw));
    const body=document.getElementById('chatBody'); const thinking=bubble('assistant','‚Ä¶'); body.appendChild(thinking); scrollToBottom();

    try{
      const html = linkify(await fetchAI(raw));
      thinking.querySelector('.bubble').innerHTML = html;
      chats[activeId].messages.push({role:'assistant', html, ts:Date.now()}); save(); renderChat();
    }catch(err){
      const msg=(err.message||'').replace(/</g,'&lt;').slice(0,1000);
      thinking.querySelector('.bubble').innerHTML=`Sorry ‚Äî upstream error.<br/><small class="text-gray-500">${msg}</small>`;
      save();
    }
  });
}

init();
renderQuick();
</script>
</body>
</html>
