<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TASK Assistant</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --brand: #ff8a00;
      --brand-light: #ffd088;
    }
    .dark .prose-invert { color: #d1d5db; }
    .dark .prose-invert a { color: #93c5fd; }
    .dark .prose-invert strong { color: #f9fafb; }
    .dark .prose-invert blockquote { border-left-color: #4b5563; }
    .dark .prose-invert ul > li::before { background-color: #6b7280; }
    /* Custom scrollbar for webkit browsers */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #718096; }
    /* Motion safety */
    @media (prefers-reduced-motion: reduce){ .animate-spin, .animate-bounce { animation: none !important } }
    .sparkle {
      background: conic-gradient(from 0deg, var(--brand) 0%, var(--brand-light) 25%, transparent 40%, transparent 60%, var(--brand-light) 75%, var(--brand) 100%);
      filter: blur(14px) saturate(1.2);
    }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: 'var(--brand)',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-100 dark:bg-[#0b1220] text-gray-900 dark:text-gray-100 font-sans antialiased">

  <!-- Splash Screen -->
  <div id="splash" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 dark:bg-[#0b1220]">
    <div class="w-full max-w-md p-8 text-center bg-white dark:bg-[#0f172a] rounded-2xl shadow-2xl border border-gray-200 dark:border-[#1f2937] relative">
      <button id="themeToggleSplash" class="absolute top-4 right-4 p-2 rounded-full border border-gray-200 dark:border-[#1f2937]">
        <svg id="themeIconSplash" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
      </button>
      <div class="relative w-24 h-24 mx-auto mb-6">
        <div class="absolute inset-[-16px] rounded-3xl sparkle animate-spin [animation-duration:4s]"></div>
        <div class="relative z-10 flex items-center justify-center w-24 h-24 text-5xl font-black text-black bg-brand rounded-2xl shadow-lg">T</div>
      </div>
      <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">TASK Assistant</h1>
      <p class="mt-2 text-gray-600 dark:text-[#9aa4b2]">Clear steps, quick actions. Use Engage by Cell to complete tasks.</p>
      <div class="mt-8">
        <button id="start" class="w-full px-6 py-3 text-lg font-semibold text-black bg-brand rounded-xl hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand dark:focus:ring-offset-[#0f172a]">Start</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden h-screen w-screen lg:grid lg:grid-cols-[280px_1fr]">
    <!-- Sidebar -->
    <aside class="flex-col hidden h-full p-3 bg-white lg:flex dark:bg-[#0f172a] border-r border-gray-200 dark:border-[#1f2937]">
      <div class="flex items-center gap-3 p-2">
        <div class="relative w-10 h-10">
          <div class="absolute inset-[-8px] rounded-xl sparkle"></div>
          <div class="relative z-10 flex items-center justify-center w-10 h-10 text-xl font-bold text-black bg-brand rounded-lg">T</div>
        </div>
        <span class="text-xl font-semibold">TASK Assistant</span>
      </div>
      <button id="newChat" class="flex items-center justify-between w-full p-3 mt-6 text-left bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
        <span>New Chat</span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
      </button>
      <div class="mt-4 flex-grow overflow-y-auto custom-scrollbar">
        <h3 class="px-2 text-sm font-semibold text-gray-500">Recent</h3>
        <div id="historyContainer" class="mt-2 space-y-1"></div>
      </div>
      <div class="p-2 text-xs text-gray-500 border-t border-gray-200 dark:border-gray-700">
        <button id="themeToggleApp" class="flex items-center w-full gap-2 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
          <svg id="themeIconApp" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
          <span id="themeTextApp">Toggle Theme</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex flex-col h-full bg-gray-100 dark:bg-[#0b1220]">
        <div class="flex flex-col flex-1 w-full max-w-4xl mx-auto">
            <header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-[#1f2937] lg:hidden">
                 <div class="flex items-center gap-3">
                    <div class="relative w-10 h-10">
                      <div class="absolute inset-[-8px] rounded-xl sparkle"></div>
                      <div class="relative z-10 flex items-center justify-center w-10 h-10 text-xl font-bold text-black bg-brand rounded-lg">T</div>
                    </div>
                    <span class="text-xl font-semibold">TASK Assistant</span>
                  </div>
                <button id="menuBtn" class="p-2 rounded-md lg:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </header>
            
            <div id="chat" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6">
                <div id="chatBody" class="space-y-6">
                  <!-- Chat bubbles will be appended here -->
                </div>
            </div>

            <div class="px-4 pb-4 md:px-6 md:pb-6">
                <div id="suggestions" class="flex flex-wrap gap-2 mb-3"></div>
                <form id="composer" class="relative" autocomplete="off">
                    <textarea id="input" class="w-full p-4 pr-32 text-base bg-white dark:bg-[#0f172a] border border-gray-300 dark:border-[#1f2937] rounded-xl resize-none focus:ring-2 focus:ring-brand focus:outline-none" placeholder="Type your question…" rows="1"></textarea>
                    <div class="absolute bottom-2.5 right-3 flex items-center gap-2">
                         <button id="mic" type="button" class="p-2 text-gray-500 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Dictate">
                            <svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                         </button>
                         <button id="send" type="submit" class="p-2 text-white bg-brand rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                         </button>
                    </div>
                </form>
                <div id="status" class="mt-2 text-sm text-center text-gray-500"></div>
                <div class="mt-2 text-xs text-center text-gray-500 dark:text-gray-400">
                    This assistant provides general guidance. For emergencies, call <a href="tel:911" class="underline">911</a>.
                </div>
            </div>
        </div>
    </main>
    
    <!-- Mobile Sidebar -->
    <div id="mobileMenu" class="fixed inset-0 z-40 hidden bg-black bg-opacity-50 lg:hidden">
        <div class="fixed top-0 left-0 flex flex-col w-64 h-full max-w-xs p-3 bg-white dark:bg-[#0f172a] border-r border-gray-200 dark:border-[#1f2937]">
            <div class="flex items-center justify-between">
              <span class="text-xl font-semibold">Menu</span>
              <button id="closeMenuBtn" class="p-2 rounded-md">&times;</button>
            </div>
            <!-- Mobile menu content mirrors sidebar -->
             <button id="newChatMobile" class="flex items-center justify-between w-full p-3 mt-6 text-left bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                <span>New Chat</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            </button>
            <div class="mt-4 flex-grow overflow-y-auto custom-scrollbar">
                <h3 class="px-2 text-sm font-semibold text-gray-500">Recent</h3>
                <div id="historyContainerMobile" class="mt-2 space-y-1"></div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700">
                <button id="themeToggleMobile" class="flex items-center w-full gap-2 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
                    <svg id="themeIconMobile" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <span id="themeTextMobile">Toggle Theme</span>
                </button>
            </div>
        </div>
    </div>
  </div>

  <script type="module">
    /* -------- Links & Config -------- */
    const ENGAGE = {
        landing: "https://bycell.co/ddmnx",
        jobOpenings: "https://bycell.co/ddmtq",
        appointment: "https://bycell.co/ddncs",
        trainingOpps: "https://bycell.co/ddnki"
    };
    const TASK_NUDGE = `You are TASK Assistant...`; // System prompt

    /* -------- Theme Management -------- */
    const sunIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
    const moonIcon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
    
    function applyTheme(theme) {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('theme', theme);
        const isDark = theme === 'dark';
        
        document.getElementById('themeIconSplash').innerHTML = isDark ? sunIcon : moonIcon;
        document.getElementById('themeIconApp').innerHTML = isDark ? sunIcon : moonIcon;
        document.getElementById('themeTextApp').textContent = isDark ? 'Light Mode' : 'Dark Mode';
        document.getElementById('themeIconMobile').innerHTML = isDark ? sunIcon : moonIcon;
        document.getElementById('themeTextMobile').textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
        applyTheme(currentTheme);
    }
    
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);

    [document.getElementById('themeToggleSplash'), document.getElementById('themeToggleApp'), document.getElementById('themeToggleMobile')].forEach(btn => btn.addEventListener('click', toggleTheme));

    /* -------- DOM Elements -------- */
    const splash = document.getElementById('splash'), app = document.getElementById('app'), startBtn = document.getElementById('start');
    const chat = document.getElementById('chat'), chatBody = document.getElementById('chatBody');
    const form = document.getElementById('composer'), input = document.getElementById('input'), sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status'), micBtn = document.getElementById('mic'), micIcon = document.getElementById('micIcon');
    const suggestionsEl = document.getElementById('suggestions');
    const newChatBtn = document.getElementById('newChat'), newChatMobileBtn = document.getElementById('newChatMobile');
    const historyContainer = document.getElementById('historyContainer'), historyContainerMobile = document.getElementById('historyContainerMobile');
    const menuBtn = document.getElementById('menuBtn'), mobileMenu = document.getElementById('mobileMenu'), closeMenuBtn = document.getElementById('closeMenuBtn');

    /* -------- State Management -------- */
    let currentChatId = null;
    let allChats = {};
    
    /* -------- Event Listeners -------- */
    startBtn.addEventListener('click', () => {
      splash.classList.add('hidden');
      app.classList.remove('hidden');
      loadChats();
      if (Object.keys(allChats).length === 0) {
        startNewChat();
      } else {
        const latestChatId = Object.keys(allChats).sort((a,b) => b.split('_')[1] - a.split('_')[1])[0];
        loadChat(latestChatId);
      }
      input.focus();
    });

    input.addEventListener('input', () => {
      sendBtn.disabled = input.value.trim().length === 0;
      input.style.height = 'auto';
      input.style.height = (input.scrollHeight) + 'px';
    });
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
        }
    });

    form.addEventListener('submit', handleSend);
    newChatBtn.addEventListener('click', startNewChat);
    newChatMobileBtn.addEventListener('click', () => {
        startNewChat();
        mobileMenu.classList.add('hidden');
    });

    menuBtn.addEventListener('click', () => mobileMenu.classList.remove('hidden'));
    closeMenuBtn.addEventListener('click', () => mobileMenu.classList.add('hidden'));
    mobileMenu.addEventListener('click', (e) => {
        if (e.target === mobileMenu) mobileMenu.classList.add('hidden');
    });
    
    /* -------- Core Functions -------- */
    function saveChats() { localStorage.setItem('allChats', JSON.stringify(allChats)); }
    function loadChats() {
        const saved = localStorage.getItem('allChats');
        if(saved) allChats = JSON.parse(saved);
        renderHistory();
    }
    
    function loadChat(chatId) {
        currentChatId = chatId;
        renderChat();
        renderHistory();
        scrollToBottom(true);
    }

    function startNewChat() {
      currentChatId = `chat_${Date.now()}`;
      const welcomeHistory = [
          { role: 'assistant', text: "Hello! I'm the TASK Assistant. How can I help you prepare for your next career move?" },
      ];
      allChats[currentChatId] = { id: currentChatId, title: "New Chat", history: welcomeHistory };
      renderChat();
      renderHistory();
      saveChats();
      input.value = '';
      sendBtn.disabled = true;
      showChips([
          {type: 'prompt', text: 'Help me with my resume'},
          {type: 'prompt', text: 'How do I prepare for an interview?'},
          {type: 'prompt', text: 'What jobs are available?'},
      ]);
    }
    
    async function handleSend(e) {
      if(e) e.preventDefault();
      const prompt = input.value.trim();
      if (!prompt) return;

      addMessageToHistory('user', prompt);
      bubbleMe(prompt);
      
      input.value = '';
      sendBtn.disabled = true;
      input.style.height = 'auto';
      showChips([]);
      setStatus('Thinking…');

      const typingIndicator = createTypingIndicator();
      chatBody.appendChild(typingIndicator);
      scrollToBottom();
      
      try {
        const response = await askAI(prompt);
        
        chatBody.removeChild(typingIndicator);
        addMessageToHistory('assistant', response.text);
        bubbleBot(response.text);
        showChips(response.chips);
        updateChatTitle(prompt);
        setStatus('');
        
      } catch (err) {
        console.error(err);
        chatBody.removeChild(typingIndicator);
        setStatus('Sorry, an error occurred.', true);
      }
    }

    function addMessageToHistory(role, text) {
        if(!allChats[currentChatId]) return;
        allChats[currentChatId].history.push({ role, text });
        saveChats();
    }

    function updateChatTitle(prompt) {
        if (allChats[currentChatId] && allChats[currentChatId].title === "New Chat") {
            const newTitle = prompt.split(' ').slice(0, 5).join(' ');
            allChats[currentChatId].title = newTitle;
            saveChats();
            renderHistory();
        }
    }

    /* -------- MOCK API with Intent Recognition -------- */
    async function askAI(prompt) {
        await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate network delay
        const p = prompt.toLowerCase();

        if (p.includes('job') || p.includes('opening') || p.includes('hiring') || p.includes('apply')) {
            return {
                text: "That's great you're looking for new opportunities! The best place to see all current job openings and apply is through **Engage by Cell**.\n\nIt has the most up-to-date listings. I can also help you prepare your resume or practice for interviews.",
                chips: [
                    {type: 'link', label: 'View Job Openings on Engage', href: ENGAGE.jobOpenings},
                    {type: 'prompt', text: 'Help me tailor my resume for a job'},
                    {type: 'prompt', text: 'Give me some interview tips'},
                ]
            }
        }
        if (p.includes('appointment') || p.includes('meet') || p.includes('schedule')) {
            return {
                text: "To schedule an appointment with a TASK professional, please use our booking portal on **Engage by Cell**.\n\nThis ensures you get a dedicated time slot. You can choose the time and person that works best for you there.",
                chips: [
                    {type: 'link', label: 'Schedule an Appointment', href: ENGAGE.appointment},
                    {type: 'prompt', text: 'What should I bring to my appointment?'},
                ]
            }
        }
        if (p.includes('resume') || p.includes('cv') || p.includes('cover letter')) {
            return {
                text: "A strong resume is key! Here are a few tips:\n\n- Use action verbs to describe your accomplishments.\n- Tailor your skills to the job description.\n- Keep it to one page if possible.\n\nWould you like me to review a specific part of your resume?",
                chips: [
                    {type: 'prompt', text: 'Review my "Work Experience" section'},
                    {type: 'prompt', text: 'What are good action verbs to use?'},
                    {type: 'link', label: 'See All Career Tips on Engage', href: ENGAGE.landing},
                ]
            }
        }
         if (p.includes('help') || p.includes('support')) {
            return {
                text: "I can certainly help! What do you need assistance with today?",
                chips: [
                    {type: 'prompt', text: 'Finding a job'},
                    {type: 'prompt', text: 'Improving my resume'},
                    {type: 'prompt', text: 'Scheduling an appointment'},
                    {type: 'prompt', text: 'Finding training opportunities'},
                ]
            }
        }
        return {
            text: `I can provide information on resumes, interviews, and job searching strategies. For direct actions like applying or scheduling, you'll be guided to our **Engage by Cell** portal.\n\nHow can I assist you further?`,
            chips: [
                {type: 'prompt', text: 'How do I find jobs?'},
                {type: 'prompt', text: 'Tell me about available trainings'},
            ]
        }
    }


    /* -------- Rendering Functions -------- */
    function renderChat() {
        chatBody.innerHTML = '';
        if (allChats[currentChatId]) {
            allChats[currentChatId].history.forEach(msg => {
                if (msg.role === 'user') bubbleMe(msg.text);
                else bubbleBot(msg.text, false);
            });
        }
    }

    function renderHistory() {
        const sortedChats = Object.values(allChats).sort((a, b) => b.id.split('_')[1] - a.id.split('_')[1]);
        const renderContainer = (container) => {
            container.innerHTML = '';
            sortedChats.forEach(chat => {
                const isActive = chat.id === currentChatId;
                const button = document.createElement('button');
                button.className = `w-full text-left px-2 py-1.5 rounded-md truncate ${isActive ? 'bg-brand text-black font-semibold' : 'hover:bg-gray-100 dark:hover:bg-gray-800'}`;
                button.textContent = chat.title;
                button.onclick = () => { loadChat(chat.id); if(window.innerWidth < 1024) mobileMenu.classList.add('hidden'); };
                container.appendChild(button);
            });
        };
        renderContainer(historyContainer);
        renderContainer(historyContainerMobile);
    }

    function showChips(chips = []) {
        suggestionsEl.innerHTML = '';
        chips.forEach(chip => {
            let el;
            if (chip.type === 'link') {
                el = document.createElement('a');
                el.href = chip.href;
                el.target = '_blank';
                el.rel = 'noopener noreferrer';
                el.className = 'px-4 py-2 text-sm font-semibold text-brand bg-blue-100 dark:bg-blue-900/50 rounded-full hover:bg-blue-200 dark:hover:bg-blue-900/80 flex items-center gap-2';
                el.innerHTML = `<span>${chip.label}</span> <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;
            } else {
                el = document.createElement('button');
                el.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 dark:text-gray-300 dark:bg-gray-700 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600';
                el.textContent = chip.text;
                el.onclick = () => {
                    input.value = chip.text;
                    form.dispatchEvent(new Event('submit'));
                };
            }
            suggestionsEl.appendChild(el);
        });
    }
    
    function bubbleMe(text) {
        const bubble = document.createElement('div');
        bubble.className = 'flex items-start justify-end gap-3';
        bubble.innerHTML = `
            <div class="max-w-xl p-3 bg-brand text-black rounded-lg whitespace-pre-wrap">${escapeHtml(text)}</div>
            <div class="flex items-center justify-center flex-shrink-0 w-8 h-8 font-semibold bg-gray-300 rounded-full dark:bg-gray-600">You</div>
        `;
        chatBody.appendChild(bubble);
        scrollToBottom();
    }
    
    function bubbleBot(text, doScroll = true) {
        const bubble = document.createElement('div');
        bubble.className = 'flex items-start gap-3';
        const contentDiv = document.createElement('div');
        contentDiv.className = 'prose prose-sm dark:prose-invert max-w-xl p-3 bg-white dark:bg-[#0f172a] rounded-lg border border-gray-200 dark:border-[#1f2937]';
        contentDiv.innerHTML = renderSmart(text);

        bubble.innerHTML = `
            <div class="relative flex items-center justify-center flex-shrink-0 w-8 h-8 text-lg font-bold text-black bg-brand rounded-full">
              T
              <div class="absolute inset-[-4px] rounded-full sparkle opacity-50 animate-spin [animation-duration:5s]"></div>
            </div>
        `;
        bubble.appendChild(contentDiv);
        chatBody.appendChild(bubble);
        if (doScroll) scrollToBottom();
    }

    function createTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'flex items-center gap-2 ml-11';
        indicator.innerHTML = `
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
        `;
        return indicator;
    }

    function setStatus(msg, isError=false) {
        statusEl.textContent = msg;
        statusEl.className = `mt-2 text-sm text-center ${isError ? 'text-red-500' : 'text-gray-500'}`;
    }
    
    function renderSmart(text) {
        let html = text
            .replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\s*-\s*(.*)/g, (match, item) => `<li>${item.trim()}</li>`)
            .replace(/(\<li\>.*\<\/li\>)/gs, '<ul>$1</ul>')
            .replace(/\n/g, '<br>');
        return html;
    }


    /* -------- Utility Functions -------- */
    function scrollToBottom(instant = false) {
      chat.scrollTo({ top: chat.scrollHeight, behavior: instant ? 'instant' : 'smooth' });
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* -------- Speech Recognition (STT) -------- */
    let recognition = null, listening = false;
    const stopIcon = `<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a.5.5 0 01.5-.5h3a.5.5 0 010 1h-3A.5.5 0 018 7z" clip-rule="evenodd"></path></svg>`;
    const micSvg = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>`;

    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const r = new SR();
      r.lang = 'en-US'; r.interimResults = true; r.continuous = false;
      r.onstart = () => { listening = true; micIcon.innerHTML = stopIcon; };
      r.onend   = () => { listening = false; micIcon.innerHTML = micSvg; };
      r.onresult = (e) => {
        let txt = '';
        for (let i = e.resultIndex; i < e.results.length; i++) txt += e.results[i][0].transcript;
        input.value = txt;
        sendBtn.disabled = input.value.trim().length === 0;
        input.style.height = 'auto';
        input.style.height = (input.scrollHeight) + 'px';
      };
      return r;
    }
    micBtn.addEventListener('click', () => {
      if (!recognition) recognition = initSTT();
      if (!recognition) { setStatus('Voice input not supported in this browser.', true); return; }
      if (!listening) recognition.start(); else recognition.stop();
    });

  </script>
</body>
</html>

