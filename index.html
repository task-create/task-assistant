<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TASK Assistant</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">

  <style>
    :root {
      color-scheme: light dark;
      --bg-dark:#0b1220; --panel-dark:#0f172a; --text-dark:#e5e7eb; --muted-dark:#9aa4b2; --border-dark:#1f2937;
      --bg-light:#f8fafc; --panel-light:#ffffff; --text-light:#0b1220; --muted-light:#475569; --border-light:#e5e7eb;
      --brand:#ff8a00; --brand2:#ffd088;
    }
    [data-theme="dark"] { --bg:var(--bg-dark); --panel:var(--panel-dark); --text:var(--text-dark); --muted:var(--muted-dark); --border:var(--border-dark); }
    [data-theme="light"]{ --bg:var(--bg-light); --panel:var(--panel-light); --text:var(--text-light); --muted:var(--muted-light); --border:var(--border-light); }

    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:grid; place-items:center;
    }

    /* Splash */
    .splash{ position:fixed; inset:0; display:grid; place-items:center; background:var(--bg); z-index:9999; }
    .splash-card{
      width:min(620px,92vw); background:var(--panel); border:1px solid var(--border);
      border-radius:16px; padding:28px 24px; text-align:center; position:relative;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .splash-title{ font-size:28px; font-weight:800; margin:14px 0 6px; }
    .splash-sub{ color:var(--muted); margin:0 0 16px; }
    .theme-toggle{ position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--text); display:grid; place-items:center; cursor:pointer; }

    .logo-wrap { position:relative; width:86px; height:86px; margin:0 auto; }
    .logo {
      width:86px; height:86px; border-radius:18px; display:grid; place-items:center;
      background:var(--brand); color:#000; font-weight:900; font-size:36px; z-index:2; position:relative;
      box-shadow:0 6px 22px rgba(255,138,0,.35);
    }
    .sparkle {
      position:absolute; inset:-16px; border-radius:28px; pointer-events:none; opacity:.9;
      background: conic-gradient(from 0deg, var(--brand) 0%, var(--brand2) 25%, transparent 40%, transparent 60%, var(--brand2) 75%, var(--brand) 100%);
      filter: blur(14px) saturate(1.2);
      animation: spin 4s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .actions{ display:flex; gap:10px; justify-content:center; padding-top:8px; }
    .btn{ padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:var(--brand); color:#000; cursor:pointer; font-size:16px; }

    /* App */
    .hidden{ display:none !important; }
    .app { width:min(980px,96vw); min-height:76vh; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:grid; grid-template-rows:auto 1fr auto; gap:14px; }
    header { display:flex; align-items:center; gap:12px; }
    .logo-sm-wrap{ position:relative; width:46px; height:46px; }
    .logo-sm{ width:46px; height:46px; border-radius:12px; display:grid; place-items:center; background:var(--brand); color:#000; font-weight:800; font-size:20px; z-index:2; position:relative; }
    .sparkle-sm{ position:absolute; inset:-8px; border-radius:20px; pointer-events:none; opacity:0; transition:opacity .2s; background: conic-gradient(from 0deg, var(--brand) 0%, var(--brand2) 25%, transparent 40%, transparent 60%, var(--brand2) 75%, var(--brand) 100%); filter: blur(10px) saturate(1.2); animation: spin 4s linear infinite; }
    .sparkle-sm.on{ opacity:.7; }

    .muted{ color:var(--muted); font-size:14px; }
    .chat{ overflow:auto; padding:0; border-radius:12px; background: rgba(0,0,0,0.06); border:1px solid var(--border); display:flex; flex-direction:column; gap:12px; }
    .settings-bar{
      position: sticky; top: 0; z-index: 5; display:flex; gap:8px; align-items:center;
      padding:10px 12px; background:var(--panel); border-bottom:1px solid var(--border);
    }
    .settings-bar .spacer{ flex:1; }
    .settings-link{ padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:transparent; color:var(--text); text-decoration:none; font-size:14px; }
    .chat-body{ padding:12px; display:flex; flex-direction:column; gap:12px; }

    .bubble{ max-width:82%; padding:12px 14px; border-radius:14px; line-height:1.5; border:1px solid var(--border); }
    .me{ align-self:flex-end; background:#172554; color:#fff; white-space:pre-wrap; word-wrap:break-word; }
    .bot{ align-self:flex-start; background:#111827; color:#e5e7eb; }
    [data-theme="light"] .me{ background:#e6f0ff; color:#0b1220; }
    [data-theme="light"] .bot{ background:#f3f4f6; color:#0b1220; }

    .row{ display:flex; gap:10px; }
    input[type="text"]{ flex:1; font-size:18px; padding:14px; border-radius:12px; background:transparent; color:var(--text); border:1px solid var(--border); outline:none; }
    button{ font-size:18px; padding:14px 18px; border-radius:12px; border:0; cursor:pointer; background:var(--brand); color:#000; }

    .icon-btn{ width:48px; min-width:48px; display:grid; place-items:center; border-radius:12px; background:transparent; border:1px solid var(--border); color:var(--text); }
    .icon-btn.on{ background:var(--brand); color:#000; border-color:var(--brand); }
    .spin{ animation: spin 1.1s linear infinite; }

    .error{ color:#ef4444; }

    /* bulletized output */
    .bot ul{ margin:0; padding-left:22px; }
    .bot li{ margin:6px 0; list-style: disc; }

    /* suggestion chips */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 0; }
    .chip{ font-size:14px; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; cursor:pointer; }
  </style>
</head>
<body data-theme="dark">
  <!-- Splash -->
  <div id="splash" class="splash">
    <div class="splash-card">
      <button id="themeToggle" class="theme-toggle" title="Toggle theme" aria-label="Toggle theme">ðŸŒ™</button>
      <div class="logo-wrap">
        <div class="sparkle"></div>
        <div class="logo">T</div>
      </div>
      <div class="splash-title">TASK Assistant â€” Ask Anything</div>
      <div class="splash-sub">Task Employment Services â€¢ Clear steps, quick actions, Engage by Cell for follow-through.</div>
      <div class="actions"><button id="start" class="btn">Start</button></div>
    </div>
  </div>

  <!-- App -->
  <div class="app hidden" id="app">
    <header>
      <div class="logo-sm-wrap">
        <div class="sparkle-sm" id="sparkleSm"></div>
        <div class="logo-sm">T</div>
      </div>
      <div>
        <div style="font-weight:700;">TASK Assistant</div>
        <div class="muted">You can ask anything â€” resumes, interviews, training dates.</div>
      </div>
      <div style="margin-left:auto;" class="muted" id="providerTag"></div>
    </header>

    <div id="chat" class="chat" aria-live="polite">
      <!-- sticky settings at VERY top (scroll up to change) -->
      <div class="settings-bar">
        <button id="settingsTheme" class="settings-link" type="button" title="Theme">Theme</button>
        <a id="openEngageTop" class="settings-link" href="#" target="_blank" rel="noopener">Open Engage</a>
        <button id="clearChat" class="settings-link" type="button">Clear</button>
        <div class="spacer"></div>
        <span id="settingsInfo" class="muted">Settings</span>
      </div>

      <div class="chat-body" id="chatBody"></div>
    </div>

    <!-- Suggestions row (appears above composer) -->
    <div id="suggestions" class="chips hidden"></div>

    <!-- Composer: sparkle indicator (far-left), input, mic, send -->
    <form id="composer" class="row" autocomplete="off">
      <button id="sparkleBtn" class="icon-btn" type="button" title="Ideas"><span id="sparkleGlyph">âœ¨</span></button>
      <input id="input" type="text" placeholder="Type your questionâ€¦" />
      <button id="mic" class="icon-btn" type="button" title="Dictate"><span id="micIcon">ðŸŽ¤</span></button>
      <button id="send" type="submit">Send</button>
    </form>

    <div id="status" class="muted"></div>
  </div>

  <script>
    /* ------------ CONFIG ------------ */
    const ENGAGE_URL = "https://m.engagebycell.com"; // TODO: replace with your Engage by Cell app link

    // TASK-first nudge (prepends to model prompt; keeps answers action oriented)
    const TASK_NUDGE = `You are TASK Assistant for Task Employment Services.
Respond with clear, step-by-step guidance. Keep answers concise.
Use bullet points only when they improve readability (for longer sections).
Prefer actionable steps and reference Engage by Cell for completing tasks (use short phrasing like: Open Engage by Cell to {action}).
Avoid markdown bold (**).`;

    /* ------------ THEME ------------ */
    const root = document.body;
    const themeToggle = document.getElementById('themeToggle');
    function setTheme(t){ root.setAttribute('data-theme', t); themeToggle.textContent = t==='dark'?'ðŸŒ™':'â˜€ï¸'; localStorage.setItem('theme', t); }
    setTheme(localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
    themeToggle.addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark'));

    /* ------------ ELEMENTS ------------ */
    const splash  = document.getElementById('splash');
    const app     = document.getElementById('app');
    const startBtn= document.getElementById('start');
    const chat    = document.getElementById('chat');
    const chatBody= document.getElementById('chatBody');
    const form    = document.getElementById('composer');
    const input   = document.getElementById('input');
    const statusEl= document.getElementById('status');
    const sparkleSm = document.getElementById('sparkleSm');
    const providerTag = document.getElementById('providerTag');
    const micBtn  = document.getElementById('mic');
    const micIcon = document.getElementById('micIcon');
    const sparkleBtn = document.getElementById('sparkleBtn');
    const sparkleGlyph = document.getElementById('sparkleGlyph');
    const suggestionsEl = document.getElementById('suggestions');
    const openEngageTop = document.getElementById('openEngageTop');
    const settingsTheme = document.getElementById('settingsTheme');
    const clearChatBtn  = document.getElementById('clearChat');

    openEngageTop.href = ENGAGE_URL;

    settingsTheme.addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='dark'?'light':'dark'));
    clearChatBtn.addEventListener('click', ()=>{
      chatBody.innerHTML = '';
      history.length = 0;
      suggestionsEl.classList.add('hidden');
    });

    /* ------------ AUDIO (lazy) ------------ */
    let Tone = null;
    let audioReady = false;
    async function ensureAudio() {
      if (!Tone) {
        const mod = await import('https://cdn.jsdelivr.net/npm/tone@15.1.22/build/Tone.js');
        Tone = mod.default || window.Tone || mod;
      }
      if (Tone?.context?.state !== 'running') await Tone.start();
      audioReady = true;
    }
    function sparkleChime(){
      if (!audioReady || !Tone) return;
      const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' } }).toDestination();
      const now = Tone.now();
      const notes = ["E5","A5","C#6","E6","A6"];
      notes.forEach((n,i)=> synth.triggerAttackRelease(n, "8n", now + i*0.06));
      const pad = new Tone.Synth({ oscillator:{type:'triangle'}, envelope:{attack:0.02, release:0.4} }).toDestination();
      pad.triggerAttackRelease("A4","4n", now+0.02);
    }
    function ding(){
      if (!audioReady || !Tone) return;
      const s = new Tone.Synth().toDestination();
      s.triggerAttackRelease("C5","8n");
    }

    /* ------------ VOICE (Web Speech API) ------------ */
    let recognition = null, listening = false;
    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const r = new SR();
      r.lang = 'en-US'; r.interimResults = true; r.continuous = false;
      r.onstart = ()=> { listening = true; micBtn.classList.add('on'); micIcon.textContent='ðŸ›‘'; };
      r.onend   = ()=> { listening = false; micBtn.classList.remove('on'); micIcon.textContent='ðŸŽ¤'; };
      r.onresult= (e)=> {
        let txt = '';
        for (let i = e.resultIndex; i < e.results.length; i++) txt += e.results[i][0].transcript;
        input.value = txt;
      };
      return r;
    }
    micBtn.addEventListener('click', ()=>{
      if (!recognition) recognition = initSTT();
      if (!recognition) { statusEl.textContent = 'Voice input not supported in this browser.'; return; }
      if (!listening) recognition.start(); else recognition.stop();
    });

    /* ------------ UI HELPERS ------------ */
    function bubbleMe(text){
      const div = document.createElement('div');
      div.className = 'bubble me';
      div.textContent = text;
      chatBody.appendChild(div); chat.scrollTop = 0; chat.scrollTop = chat.scrollHeight;
    }

    function cleanMarkdown(s){
      return s.replace(/\*\*/g, '')  // remove bold markers
              .replace(/^#+\s*/gm,'') // remove headings
              .replace(/`{1,3}/g, ''); // remove backticks
    }

    // make bullets only when helpful (multi-line or long text)
    function bulletizeIfHelpful(text){
      const cleaned = cleanMarkdown(text);
      const lines = cleaned.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const long = cleaned.length > 220;

      if (lines.length >= 2 || long) {
        const ul = document.createElement('ul');
        (lines.length >= 2 ? lines : cleaned.split(/(?<=[.!?])\s+(?=[A-Z(])/).filter(Boolean))
          .forEach(item=>{
            const li = document.createElement('li');
            li.textContent = item.replace(/^(\*|-|â€¢|\d+\.)\s*/, '');
            ul.appendChild(li);
          });
        return ul;
      } else {
        const p = document.createElement('div');
        p.textContent = cleaned;
        return p;
      }
    }

    function bubbleBot(text){
      const div = document.createElement('div');
      div.className = 'bubble bot';
      div.appendChild(bulletizeIfHelpful(text));
      chatBody.appendChild(div); chat.scrollTop = chat.scrollHeight;
    }

    function setStatus(msg, isError=false){
      statusEl.textContent = msg || '';
      statusEl.className = isError ? 'error' : 'muted';
    }

    function showChips(list){
      suggestionsEl.innerHTML = '';
      list.forEach(s=>{
        const b = document.createElement('button');
        b.className = 'chip';
        b.type = 'button';
        b.textContent = s;
        b.addEventListener('click', ()=> { input.value = s; input.focus(); });
        suggestionsEl.appendChild(b);
      });
      suggestionsEl.classList.toggle('hidden', list.length === 0);
    }

    /* ------------ API ------------ */
    const history = [];
    async function askAI(prompt){
      const res = await fetch('/api/ai', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt: `${TASK_NUDGE}\n\nUser: ${prompt}`, history })
      });
      if (!res.ok) { const t = await res.text().catch(()=> ''); throw new Error(`Upstream error: ${res.status} ${res.statusText}\n${t}`); }
      return res.json();
    }
    async function getSuggestion(lastUserMessage){
      const res = await fetch('/api/suggest', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ lastUserMessage })
      });
      if (!res.ok) return null;
      const j = await res.json().catch(()=> null);
      return j?.suggestion || null;
    }
    async function getSuggestionsN(lastUserMessage, n=3){
      const arr = [];
      for (let i=0;i<n;i++){
        const s = await getSuggestion(lastUserMessage);
        if (s && !arr.includes(s)) arr.push(s);
      }
      return arr;
    }

    /* ------------ START / SEND ------------ */
    startBtn.addEventListener('click', async ()=>{
      try { await ensureAudio(); } catch {}
      splash.classList.add('hidden');
      app.classList.remove('hidden');
      input.focus();
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const prompt = input.value.trim();
      if (!prompt) return;

      if (!audioReady) { try { await ensureAudio(); } catch {} }

      showChips([]); // clear any prior chips
      bubbleMe(prompt);
      input.value = '';
      setStatus('Thinkingâ€¦');
      sparkleBtn.classList.add('on'); sparkleGlyph.classList.add('spin');

      try {
        const json = await askAI(prompt);
        const text = json?.text || '(no response)';
        providerTag.textContent = json?.provider ? `via ${json.provider}` : '';
        history.push({ role:'user', text: prompt });
        history.push({ role:'assistant', text });

        bubbleBot(text);
        setStatus('');
        ding(); sparkleChime();

        // auto suggestion (header sparkle)
        sparkleSm.classList.add('on');
        const suggestion = await getSuggestion(prompt);
        sparkleSm.classList.remove('on');
        if (suggestion) showChips([suggestion, `Open Engage by Cell to continue: ${ENGAGE_URL}`]);
      } catch (err) {
        console.error(err);
        setStatus(err.message || String(err), true);
        bubbleBot('Sorry â€” I couldnâ€™t reach the AI service. Please try again.');
      } finally {
        sparkleBtn.classList.remove('on'); sparkleGlyph.classList.remove('spin');
      }
    });

    /* ------------ SPARKLE BUTTON (ideas on demand) ------------ */
    sparkleBtn.addEventListener('click', async ()=>{
      // find last user message
      const lastUser = [...history].reverse().find(m => m.role === 'user')?.text || input.value.trim() || 'employment help';
      sparkleBtn.classList.add('on'); sparkleGlyph.classList.add('spin');
      try {
        if (!audioReady) { try { await ensureAudio(); } catch {} }
        const ideas = await getSuggestionsN(lastUser, 3);
        // Always include the Engage app action as one option
        ideas.push(`Open Engage by Cell to continue: ${ENGAGE_URL}`);
        showChips(ideas);
        sparkleChime();
      } finally {
        sparkleBtn.classList.remove('on'); sparkleGlyph.classList.remove('spin');
      }
    });

    /* ------------ STARTER CONTENT (TES) ------------ */
    bubbleBot('Hereâ€™s what I can help with today:');
    bubbleBot([
      'Quick steps to tailor your resume to a specific job.',
      'Interview practice prompts and concise talking points.',
      'Find local training programs and what you need to enroll.',
      'Draft short outreach messages to employers.',
      'Next steps after applying (follow-up and documents).'
    ].join('\n'));
  </script>
</body>
</html>
