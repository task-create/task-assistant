<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TASK Employment Assistant</title>

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" defer></script>

<style>
  :root{
    --brand:#FF911F;    /* user bubble */
    --accent:#145078;   /* assistant bubble + header bar */
    --bg:#0a0f1a;
    --surface:#111929;
    --surface-2:#0f1524;
    --text:#eaf2ff;
    --muted:#a7bad5;
    --border:#334a69;
    --radius:18px;
    --shadow:0 12px 24px rgba(0,0,0,.28);
    --shadow-soft:0 8px 18px rgba(0,0,0,.18);
    --maxline:72ch;     /* keep text narrow so it's not blocky */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:flex; align-items:center; justify-content:center;
    min-height:100vh;
  }

  /* Shell */
  .container{
    width:100%; max-width:1000px; height:100vh;
    display:flex; flex-direction:column; position:relative;
    background:var(--surface); border:1px solid var(--border); border-radius:22px;
    box-shadow:var(--shadow); overflow:hidden;
  }
  .header{
    display:flex; align-items:center; justify-content:center;
    gap:12px;
    padding:12px 16px; background:var(--surface);
    border-bottom:1px solid var(--border);
  }
  .logo{
    width:42px; height:42px; object-fit:contain;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.2));
  }
  .title{
    font-family:"Nunito",sans-serif; font-weight:800; letter-spacing:.2px;
    color:var(--accent); font-size:1.2rem;
  }
  .header-right{
    position:absolute; right:12px; top:10px;
  }
  .icon-btn{
    width:38px;height:38px;border-radius:50%;border:1px solid var(--border);
    background:transparent;color:var(--text);display:grid;place-items:center;
    cursor:pointer; transition:.15s all;
  }
  .icon-btn:hover{background:rgba(255,255,255,.06)}

  /* Chat */
  .chat{
    flex:1; overflow:auto; background:var(--surface-2);
    padding:18px 18px 160px;
  }
  .row{
    display:flex; align-items:flex-start; gap:10px; margin:12px 0;
    animation:pop .2s ease-out;
  }
  @keyframes pop{from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)}}
  .avatar{
    flex:0 0 34px; height:34px; border-radius:50%; color:#fff; display:grid; place-items:center;
    font-weight:800; font-family:"Nunito",sans-serif; background:var(--accent);
  }
  .bubble{
    max-width:48%; /* 2-column vibe, never full width */
    background:var(--surface); border:1px solid var(--border);
    border-radius:16px; padding:12px 14px; box-shadow:var(--shadow-soft);
    line-height:1.55; font-size:16px; color:var(--text);
    width:fit-content;
  }
  .bubble p, .bubble ul, .bubble ol { max-width: var(--maxline); }
  .bubble ul{margin:.4em 0 .4em 1.2em}
  .bubble li{margin:.2em 0}

  /* Left/right alignment fixed */
  .bot{ justify-content:flex-start; }
  .bot .avatar{ background:var(--accent); }
  .bot .bubble{ border-radius:16px 16px 16px 6px; }

  .user{ justify-content:flex-end; }
  .user .avatar{ display:none; }
  .user .bubble{
    background:var(--brand); border-color:transparent; color:#1f1408;
    border-radius:16px 16px 6px 16px;
  }

  /* Input and status */
  .input-wrap{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:64px; width:100%; max-width:1000px; padding:8px 14px; z-index:5;
  }
  .input-row{
    display:grid; grid-template-columns:46px 1fr 46px; gap:8px;
    background:var(--surface); border:1px solid var(--border);
    border-radius:999px; padding:8px; box-shadow:var(--shadow-soft);
  }
  #box{ border:0; outline:0; font-size:1rem; background:transparent; color:var(--text); }
  .send-btn{
    width:46px;height:46px;border:0;border-radius:50%; background:var(--brand); color:#fff;
    cursor:pointer; display:grid; place-items:center; box-shadow:var(--shadow-soft); transition:.12s filter;
  }
  .send-btn:hover{ filter:brightness(.95) }
  .sparkle-btn{
    width:46px;height:46px;border:2px solid var(--brand);
    color:var(--brand); background:transparent; border-radius:50%;
    font-size:18px; font-weight:900; cursor:pointer; display:grid; place-items:center;
  }

  .status-line{ margin-top:6px; font-size:.9rem; color:var(--muted); padding-left:8px; }

  /* Suggestions tray */
  #sparkleTray{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:130px; width:100%; max-width:1000px; z-index:4; display:none;
  }
  .sparkle-pills{ display:flex; flex-wrap:wrap; gap:8px; padding:8px 14px; }
  .sparkle-pill{
    border:2px solid var(--accent); background:var(--surface);
    color:var(--accent); border-radius:999px; padding:8px 12px; font-weight:700; cursor:pointer; font-size:.92rem;
  }
  .sparkle-pill:hover{ background:var(--accent); color:#fff; }

  /* Typing dots */
  .typing{ display:inline-flex; gap:6px; align-items:center; }
  .typing .dot{ width:7px;height:7px;border-radius:50%;background:var(--muted);opacity:.8;animation:bounce 1s infinite ease-in-out; }
  .typing .dot:nth-child(2){animation-delay:.2s}
  .typing .dot:nth-child(3){animation-delay:.4s}
  @keyframes bounce{0%,80%,100%{transform:scale(.6)}40%{transform:scale(1)}}

  /* Disclaimer */
  .legal-disclaimer{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:0; width:100%; max-width:1000px; padding:8px 14px;
    background:var(--accent); color:#fff; text-align:center; font-size:.85rem; z-index:6;
  }

  /* Quick Actions card */
  .quick-card{
    background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:var(--shadow-soft); margin-bottom:8px;
  }
  .quick-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:10px; }
  .qbtn{
    width:100%; text-align:left; background:var(--surface-2); color:var(--text);
    border:1px solid var(--border); border-radius:12px; padding:10px 12px; cursor:pointer; transition:.15s all;
  }
  .qbtn small{ display:block; color:var(--muted); }
  .qbtn:hover{ background:rgba(255,255,255,.06) }

  /* Splash */
  #splash{
    position:fixed; inset:0; background:#0f1b2c; color:#fff; z-index:999;
    display:flex; align-items:center; justify-content:center; flex-direction:column; gap:16px; text-align:center;
  }
  .splash-card{
    background:#0b1424; border:1px solid rgba(255,255,255,.15); border-radius:18px; padding:26px 24px; box-shadow:var(--shadow); max-width:560px;
  }
  .splash-card h1{ margin:10px 0 4px }
  .splash-btn{ background:var(--brand); color:#fff; border:0; font-weight:800; border-radius:999px; padding:12px 18px; cursor:pointer; }
  .splash-desc{ color:#d8e7ff; opacity:.9; }
</style>
</head>
<body>
  <!-- Splash -->
  <div id="splash" role="dialog" aria-modal="true">
    <div class="splash-card">
      <img class="logo" src="logo.png" alt="TASK logo" style="width:64px;height:64px">
      <h1>TASK Employment Assistant</h1>
      <p class="splash-desc">Focused on <b>getting ready for work</b>, <b>finding work</b>, and <b>keeping work</b> — with direct links to TASK resources.</p>
      <button id="startBtn" class="splash-btn" aria-label="Start">Start</button>
    </div>
  </div>

  <!-- App -->
  <main class="container" id="app" style="display:none">
    <header class="header">
  <img
    src="OIP.jpeg"                <!-- use the exact name + extension -->
    alt="Trenton Area Soup Kitchen (TASK) logo"
    width="160"
    height="160"
    style="object-fit: contain; display:block"
  />
  <h1 class="title">Employment Assistant</h1>
</header>


    <section id="chat" class="chat" role="log" aria-live="polite" aria-relevant="additions"></section>

    <!-- Suggestions -->
    <div id="sparkleTray"><div class="sparkle-pills" id="sparklePills"></div></div>

    <!-- Input -->
    <div class="input-wrap">
      <div class="input-row">
        <button id="sparkleBtn" class="sparkle-btn" title="Suggestions" aria-label="Suggestions">✦</button>
        <input id="box" type="text" placeholder="Type your message…" autocomplete="off" aria-label="Message to assistant"/>
        <button id="sendBtn" class="send-btn" aria-label="Send">
          <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path d="M2 21l20-9L2 3l3 7 9 2-9 2-3 7z" fill="currentColor"/></svg>
        </button>
      </div>
      <div id="statusLine" class="status-line" role="status">⚠️ I can make mistakes — please double-check important info.</div>
    </div>

    <div class="legal-disclaimer">Disclaimer: This assistant is for informational purposes only and is not legal, financial, or employment advice.</div>
  </main>

<script>
(() => {
  'use strict';

  /* TASK links & phones (your exact values) */
  const TASK = {
    address: "72 Escher St, Trenton, NJ 08609",
    site: "https://trentonsoupkitchen.org/",
    jobsAssist: "https://trentonsoupkitchen.org/job-search-and-assistance/",
    getHelpEmployment: "https://trentonsoupkitchen.org/get-help/#job-search-employment-services",
    arts: "https://trentonsoupkitchen.org/creative-arts-program/",
    bycell: [
      "https://bycell.co/ddmnx",
      "https://bycell.co/ddmui",
      "https://bycell.co/ddmua",
      "https://bycell.co/ddmwm",
      "https://bycell.co/ddmul",
      "https://bycell.co/ddmtq",
      "https://bycell.co/ddncs",
      "https://bycell.co/ddmtn"
    ],
    phones: {
      employment1: "609-697-6215",
      employment2: "609-697-6166",
      appointments: "609-337-1624"
    }
  };

  /* DOM */
  const splash   = document.getElementById('splash');
  const startBtn = document.getElementById('startBtn');
  const app      = document.getElementById('app');
  const chat     = document.getElementById('chat');
  const box      = document.getElementById('box');
  const sendBtn  = document.getElementById('sendBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statusLine = document.getElementById('statusLine');
  const sparkleBtn  = document.getElementById('sparkleBtn');
  const sparkleTray = document.getElementById('sparkleTray');
  const sparklePills= document.getElementById('sparklePills');

  /* Helpers */
  const openLink = url => window.open(url, '_blank', 'noopener');
  const callNumber = n => window.location.href = `tel:${n.replace(/[^\d+]/g,'')}`;

  function escapeHTML(s){
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function addUser(text){
    const row = document.createElement('div');
    row.className = 'row user';
    row.innerHTML = `<div class="bubble">${escapeHTML(text)}</div>`;
    chat.appendChild(row); scrollToBottom();
  }
  function addBot(html){
    const safe = DOMPurify.sanitize(html);
    const row = document.createElement('div');
    row.className = 'row bot';
    row.innerHTML = `<div class="avatar" aria-hidden="true">E</div><div class="bubble">${safe}</div>`;
    chat.appendChild(row); scrollToBottom();
  }
  function typing(on){
    const id='typing';
    if (on){
      if (document.getElementById(id)) return;
      const row = document.createElement('div');
      row.id=id; row.className='row bot';
      row.innerHTML = `<div class="avatar">E</div><div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>`;
      chat.appendChild(row);
    }else{
      const r=document.getElementById(id); if(r) r.remove();
    }
    scrollToBottom();
  }
  function scrollToBottom(){ requestAnimationFrame(()=> chat.scrollTop = chat.scrollHeight); }
  function clearChat(){ chat.innerHTML=''; statusLine.textContent='⚠️ I can make mistakes — please double-check important info.'; }

  /* Make dense text easier to read
     - If reply is long, turn it into bullets by sentences.
     - Preserves existing markdown-like * bullets.
  */
  function formatOutput(text){
    const t = (text||'').trim();
    if (!t) return '';
    const alreadyBulleted = /^[\s\*\-\d]/m.test(t);
    if (alreadyBulleted) {
      const html = escapeHTML(t).replace(/^(\s*[\*\-]\s+)/gm,'</li><li>')
        .replace(/<\/li><li>/,'<ul><li>').concat('</li></ul>');
      return html.replace('<ul></li>','<ul>');
    }
    const sentences = t.split(/(?<=[\.\!\?])\s+(?=[A-Z0-9])/).filter(Boolean);
    if (sentences.length >= 4){
      return `<ul>${sentences.map(s=>`<li>${escapeHTML(s)}</li>`).join('')}</ul>`;
    }
    return `<p>${escapeHTML(t).replace(/\n{2,}/g,'</p><p>').replace(/\n/g,'<br>')}</p>`;
  }

  /* AI call */
  async function askAI(promptText){
    const controller = new AbortController();
    const timer = setTimeout(()=>controller.abort('timeout'), 20000);
    try{
      const r = await fetch('/api/ai', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ message: promptText })
});

      });
      clearTimeout(timer);
      if(!r.ok) throw new Error(await r.text());
      const data = await r.json();
      return data?.text || 'No reply.';
    }catch(e){ clearTimeout(timer); throw e; }
  }

  /* Intent shortcuts: open TASK links & phones without calling AI */
  function handledByIntent(text){
    const t = text.toLowerCase();

    if (t.includes('call') && t.includes('employment')){
      callNumber(TASK.phones.employment1); addBot('Calling TASK Employment Services…'); return true;
    }
    if (t.includes('appointment')){
      callNumber(TASK.phones.appointments); addBot('Opening phone dialer for appointments…'); return true;
    }
    if (t.includes('job search') || t.includes('jobs assistance')){ openLink(TASK.jobsAssist); addBot('Opening TASK Job Search & Assistance…'); return true; }
    if (t.includes('get help') && t.includes('employment')){ openLink(TASK.getHelpEmployment); addBot('Opening TASK Employment Services…'); return true; }
    if (t.includes('creative arts')){ openLink(TASK.arts); addBot('Opening TASK Creative Arts…'); return true; }
    if (t.includes('bycell') || t.includes('menu')){ TASK.bycell.forEach(openLink); addBot('Opened TASK ByCell menus.'); return true; }
    if (t.includes('task website')){ openLink(TASK.site); addBot('Opening TASK website…'); return true; }

    // "jobs at <company>"
    const m = t.match(/jobs?\s+at\s+([a-z0-9&\-\s]+)$/i);
    if (m && m[1]){ openLink(`https://www.google.com/search?q=${encodeURIComponent(m[1]+' careers site')}`); addBot(`Opened official careers for <b>${escapeHTML(m[1])}</b>.`); return true; }

    return false;
  }

  async function send(){
    const text = (box.value||'').trim();
    if(!text) return;

    // handle known intents locally (no AI call)
    if (handledByIntent(text)){ addUser(text); box.value=''; return; }

    addUser(text); box.value=''; box.focus();
    typing(true); setEnabled(false); statusLine.textContent='Thinking…';
    try{
      const reply = await askAI(text);
      typing(false); statusLine.textContent='Ready';
      addBot(formatOutput(reply));
    }catch(err){
      typing(false); statusLine.textContent='Network or API error.';
      addBot('Sorry — I couldn’t reach the AI service. Please try again.');
      console.error(err);
    }finally{ setEnabled(true); }
  }

  function setEnabled(on){
    [sendBtn, box, sparkleBtn].forEach(el => el.disabled = !on);
  }

  /* Suggestions focused on ready → find → keep */
  const SUGGESTIONS = [
    "Help me make a 1-page resume",
    "Show interview questions I should practice",
    "Find warehouse jobs hiring near Trenton",
    "What documents do I need to apply?",
    "How do I talk to a manager about schedule changes?",
    "Check this job post for red flags",
    "Call TASK Employment Services",
    "Make an appointment at TASK"
  ];
  function renderPills(){
    sparklePills.innerHTML='';
    SUGGESTIONS.forEach(txt=>{
      const b=document.createElement('button');
      b.className='sparkle-pill'; b.textContent=txt;
      b.onclick=()=>{ box.value=txt; sparkleTray.style.display='none'; send(); };
      sparklePills.appendChild(b);
    });
  }
  sparkleBtn.onclick=()=>{
    if (sparkleTray.style.display==='block'){ sparkleTray.style.display='none'; }
    else { renderPills(); sparkleTray.style.display='block'; }
  };

  /* Greeting with TASK Quick Actions (left side) */
  function greet(){
    addBot(`
      <div class="quick-card">
        <strong>Welcome to TASK Employment Assistant</strong><br>
        I can connect you to TASK, plan options, and find official job pages.
        <div class="quick-grid" style="margin-top:10px">
          <button class="qbtn" onclick="(${callNumber.toString()})('${TASK.phones.employment1}')">📞 Employment Services<small>${TASK.phones.employment1}</small></button>
          <button class="qbtn" onclick="(${callNumber.toString()})('${TASK.phones.employment2}')">📞 Employment Training<small>${TASK.phones.employment2}</small></button>
          <button class="qbtn" onclick="(${callNumber.toString()})('${TASK.phones.appointments}')">📅 Make an Appointment<small>${TASK.phones.appointments}</small></button>
          <button class="qbtn" onclick="(${openLink.toString()})('${TASK.jobsAssist}')">🧭 Job Search & Assistance<small>trentonsoupkitchen.org</small></button>
          <button class="qbtn" onclick="(${openLink.toString()})('${TASK.getHelpEmployment}')">🧰 Get Help: Employment<small>Official TASK page</small></button>
          <button class="qbtn" onclick="(${openLink.toString()})('${TASK.arts}')">🎨 Creative Arts Program<small>Music • Arts • More</small></button>
          <button class="qbtn" onclick="(()=>{ ${TASK.bycell.map(u=>`(${openLink.toString()})('${u}')`).join(';')} })()">📲 TASK Mobile Menus<small>ByCell links</small></button>
          <button class="qbtn" onclick="(${openLink.toString()})('${TASK.site}')">🏠 TASK Website<small>Programs & services</small></button>
        </div>
        <small style="display:block;margin-top:8px;color:var(--muted)">Address: ${TASK.address}</small>
      </div>
      <p>How can I help you today? Try:
      <ul>
        <li>“Find warehouse jobs hiring in Mercer County.”</li>
        <li>“Make an appointment at TASK.”</li>
        <li>“Call TASK Employment Services.”</li>
        <li>“Open TASK job search page.”</li>
      </ul></p>
    `);
  }

  /* Events */
  sendBtn.onclick = send;
  box.addEventListener('keydown', e => { if (e.key==='Enter'){ e.preventDefault(); send(); }});
  resetBtn.onclick = ()=>{ clearChat(); greet(); };
  startBtn.onclick = ()=>{ splash.style.display='none'; app.style.display='flex'; greet(); box.focus(); };

})();
</script>
</body>
</html>
