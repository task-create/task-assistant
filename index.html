<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solace • TASK Assistant</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ES%3C/text%3E%3C/svg%3E">
  <!-- CDN is fine for now; the warning is informational -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#ff8a00; --brand-light:#ffd088; }
    .custom-scrollbar::-webkit-scrollbar{width:6px}
    .custom-scrollbar::-webkit-scrollbar-track{background:transparent}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#4a5568;border-radius:3px}
    .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#718096}
    @media (prefers-reduced-motion: reduce){ .animate-spin,.animate-bounce,.transition-all{transition:none!important} }
    .sparkle{background:conic-gradient(from 0deg,var(--brand) 0%,var(--brand-light) 25%,transparent 40%,transparent 60%,var(--brand-light) 75%,var(--brand) 100%);filter:blur(14px) saturate(1.2)}
    .composer-shell{position:sticky;bottom:0;background:linear-gradient(to top,rgba(255,255,255,0.9),rgba(255,255,255,0))}
    .dark .composer-shell{background:linear-gradient(to top,rgba(15,23,42,0.95),rgba(15,23,42,0))}
  </style>
  <script>tailwind.config={darkMode:'class',theme:{extend:{colors:{brand:'var(--brand)'}}}}</script>
</head>
<body class="bg-gray-100 dark:bg-[#0b1220] text-gray-900 dark:text-gray-100 font-sans antialiased">

  <!-- Splash (ONLY Start + Theme + Language) -->
  <div id="splash" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 dark:bg-gray-900 p-4">
    <div class="w-full max-w-md p-8 text-center bg-white dark:bg-[#0f172a] rounded-2xl shadow-2xl border border-gray-200 dark:border-[#1f2937] relative">
      <button id="themeToggleSplash" class="absolute top-4 right-4 p-2 rounded-full border border-gray-200 dark:border-[#1f2937]" title="Toggle theme">
        <svg id="themeIconSplash" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
      </button>

      <div class="absolute top-4 left-4">
        <label for="languageSelector" class="sr-only">Language</label>
        <select id="languageSelector" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-[#1f2937] rounded-md p-1 text-sm">
          <option value="en">English</option>
          <option value="es">Español</option>
          <option value="ht">Kreyòl Ayisyen</option>
        </select>
      </div>

      <div class="relative w-24 h-24 mx-auto mb-6">
        <div class="absolute inset-[-16px] rounded-full sparkle animate-spin [animation-duration:4s]"></div>
        <div class="relative z-10 flex items-center justify-center w-24 h-24 text-5xl font-black text-black bg-brand rounded-2xl shadow-lg">S</div>
      </div>
      <h1 id="splashTitle" class="text-3xl font-extrabold">Solace</h1>
      <p id="splashSubtitle" class="mt-2 text-gray-600 dark:text-[#9aa4b2]">Your guide to career and community resources.</p>

      <div class="mt-8">
        <button id="start" class="w-full px-6 py-3 text-lg font-semibold text-black bg-brand rounded-xl hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand dark:focus:ring-offset-[#0f172a]">Start</button>
      </div>
    </div>
  </div>

  <!-- App Shell -->
  <div id="app" class="hidden h-screen w-screen">

    <!-- FIXED Left Sidebar (ChatGPT-style) -->
    <aside class="fixed left-0 top-0 z-40 hidden h-screen w-[280px] lg:flex flex-col bg-white dark:bg-[#0f172a] border-r border-gray-200 dark:border-[#1f2937]">
      <div class="flex items-center gap-3 p-3">
        <div class="relative w-10 h-10">
          <div class="absolute inset-[-8px] rounded-full sparkle"></div>
          <div class="relative z-10 flex items-center justify-center w-10 h-10 text-xl font-bold text-black bg-brand rounded-lg">S</div>
        </div>
        <span class="text-xl font-semibold">Solace</span>
      </div>

      <button id="newChat" class="mx-3 flex items-center justify-between w-auto p-3 mt-2 text-left bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
        <span>New Chat</span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
      </button>

      <!-- Quick Actions (links live ONLY here) -->
      <div class="px-3 mt-4">
        <h3 class="px-1 text-sm font-semibold text-gray-500 uppercase tracking-wider">Quick Actions</h3>
        <div id="quickActionsContainer" class="mt-2 space-y-2"></div>
      </div>

      <div class="mt-4 flex-1 overflow-y-auto custom-scrollbar px-3">
        <h3 class="px-1 text-sm font-semibold text-gray-500">Recent</h3>
        <div id="historyContainer" class="mt-2 space-y-1"></div>
      </div>

      <div class="p-3 border-t border-gray-200 dark:border-gray-700">
        <button id="themeToggleApp" class="flex items-center w-full gap-3 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
          <svg id="themeIconApp" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
          <span id="themeTextApp" class="text-sm font-medium">Dark Mode</span>
        </button>
      </div>
    </aside>

    <!-- MAIN (pushed right of fixed sidebar) -->
    <main class="relative flex flex-col h-screen lg:ml-[280px] bg-gray-100 dark:bg-[#0b1220]">
      <!-- Mobile header -->
      <header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-[#1f2937] lg:hidden">
        <div class="flex items-center gap-3">
          <div class="relative w-8 h-8">
            <div class="absolute inset-[-6px] rounded-full sparkle"></div>
            <div class="relative z-10 flex items-center justify-center w-8 h-8 text-lg font-bold text-black bg-brand rounded-md">S</div>
          </div>
          <span class="text-lg font-semibold">Solace</span>
        </div>
        <button id="menuBtn" class="p-2 rounded-md lg:hidden" title="Menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
        </button>
      </header>

      <!-- Chat scroll region -->
      <div id="chat" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 flex">
        <div id="chatBody" class="w-full max-w-3xl mx-auto">
          <div id="welcomeScreen" class="flex flex-col items-center justify-center h-full text-center">
            <div class="relative w-20 h-20 mx-auto mb-4">
              <div class="absolute inset-[-12px] rounded-full sparkle"></div>
              <div class="relative z-10 flex items-center justify-center w-20 h-20 text-4xl font-black text-black bg-brand rounded-2xl shadow-lg">S</div>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">How can I help you today?</h1>
          </div>
        </div>
      </div>

      <!-- Composer (sticky) -->
      <div class="composer-shell px-4 pb-4 md:px-6 md:pb-6">
        <form id="composer" class="relative" autocomplete="off">
          <textarea id="input" class="w-full p-4 pr-32 text-base bg-white dark:bg-[#0f172a] border border-gray-300 dark:border-[#1f2937] rounded-xl resize-none focus:ring-2 focus:ring-brand focus:outline-none" placeholder="Type your question…" rows="1"></textarea>
        <div class="absolute bottom-2.5 right-3">
            <button id="send" type="submit" class="p-2 text-white bg-brand rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
              <svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg>
            </button>
          </div>
        </form>
        <div id="status" class="mt-2 text-sm text-center text-gray-500"></div>
      </div>
    </main>

    <!-- Mobile slide-over (optional) -->
    <div id="mobileMenu" class="fixed inset-0 z-40 hidden bg-black bg-opacity-50 lg:hidden">
      <div class="fixed top-0 left-0 flex flex-col w-64 h-full max-w-xs p-3 bg-white dark:bg-[#0f172a] border-r border-gray-200 dark:border-[#1f2937]">
        <div class="flex items-center justify-between">
          <span class="text-xl font-semibold">Menu</span>
          <button id="closeMenuBtn" class="p-2 rounded-md" aria-label="Close">&times;</button>
        </div>
        <button id="newChatMobile" class="flex items-center justify-between w-full p-3 mt-6 text-left bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
          <span>New Chat</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
        </button>
        <div class="mt-4 flex-1 overflow-y-auto custom-scrollbar">
          <h3 class="px-2 text-sm font-semibold text-gray-500">Recent</h3>
          <div id="historyContainerMobile" class="mt-2 space-y-1"></div>
        </div>
        <div class="p-2 border-t border-gray-200 dark:border-gray-700">
          <button id="themeToggleMobile" class="flex items-center w-full gap-3 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">
            <svg id="themeIconMobile" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
            <span id="themeTextMobile" class="text-sm font-medium">Dark Mode</span>
          </button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* ---------------- External links (sidebar only) ---------------- */
const ENGAGE = {
  appointment:"https://bycell.co/ddncs",
  jobOpenings:"https://bycell.co/ddmtq",
  trainings:"https://bycell.co/ddmtn",
  communityResources:"https://bycell.co/ddmua"
};

/* ---------------- API base ---------------- */
const DEPLOY_BASE='https://task-assistant-xi.vercel.app';
const ON_SAME_SITE = typeof location!=='undefined'&&(location.hostname==='localhost'||location.hostname.endsWith('task-assistant-xi.vercel.app'));
const API_BASE = ON_SAME_SITE ? '' : DEPLOY_BASE;
const api = (p)=>`${API_BASE}${p}`;

/* ---------------- Theme ---------------- */
const sunIcon=`<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 0 0 1 8 0z"/></svg>`;
const moonIcon=`<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>`;
function applyTheme(theme){
  document.documentElement.classList.toggle('dark',theme==='dark');
  localStorage.setItem('theme',theme);
  const isDark = theme==='dark';
  const is=document.getElementById('themeIconSplash'); if (is) is.innerHTML = isDark ? sunIcon : moonIcon;
  const ia=document.getElementById('themeIconApp'); const ta=document.getElementById('themeTextApp');
  if (ia&&ta){ ia.innerHTML = isDark ? sunIcon : moonIcon; ta.textContent = isDark ? 'Light Mode' : 'Dark Mode'; }
  const im=document.getElementById('themeIconMobile'); const tm=document.getElementById('themeTextMobile');
  if (im&&tm){ im.innerHTML = isDark ? sunIcon : moonIcon; tm.textContent = isDark ? 'Light Mode' : 'Dark Mode'; }
}
function toggleTheme(){ applyTheme(localStorage.getItem('theme')==='dark'?'light':'dark'); }

/* ---------------- Language ---------------- */
function setLanguage(lang){
  const code=(lang||'en').slice(0,2).toLowerCase();
  const normalized=['en','es','ht'].includes(code)?code:'en';
  localStorage.setItem('lang',normalized);
  document.documentElement.setAttribute('lang',normalized);
  const strings={
    en:{title:'Solace',subtitle:'Your guide to career and community resources.',start:'Start'},
    es:{title:'Solace',subtitle:'Su guía de recursos profesionales y comunitarios.',start:'Empezar'},
    ht:{title:'Solace',subtitle:'Gid ou pou karyè ak resous kominotè yo.',start:'Kòmanse'}
  }[normalized];
  document.getElementById('splashTitle').textContent=strings.title;
  document.getElementById('splashSubtitle').textContent=strings.subtitle;
  document.getElementById('start').textContent=strings.start;
  const sel=document.getElementById('languageSelector'); if (sel && sel.value!==normalized) sel.value=normalized;
}

/* ---------------- Chat state ---------------- */
let currentChatId=null, allChats={};
function saveChats(){ localStorage.setItem('allChats',JSON.stringify(allChats)); }
function loadChats(){ const s=localStorage.getItem('allChats'); if(s) allChats=JSON.parse(s); renderHistory(); }
function startNewChat(){ currentChatId=`chat_${Date.now()}`; allChats[currentChatId]={id:currentChatId,title:'New Chat',history:[]}; saveChats(); renderHistory(); renderChat(); }
function addMessageToHistory(role,text){ if(!currentChatId||!allChats[currentChatId]) return; allChats[currentChatId].history.push({role,text}); saveChats(); }

/* ---------------- Renderers ---------------- */
function renderHistory(){
  const c=document.getElementById('historyContainer'); if(!c) return; c.innerHTML='';
  Object.values(allChats).sort((a,b)=>(b.id||'').localeCompare(a.id||'')).forEach(chat=>{
    const row=document.createElement('div');
    row.className=`flex items-center justify-between px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 ${chat.id===currentChatId?'bg-brand/20':''}`;
    row.innerHTML=`<button class="text-left flex-1 truncate" title="${chat.title}">${chat.title}</button>`;
    row.querySelector('button').addEventListener('click',()=>{ currentChatId=chat.id; renderChat(); renderHistory(); });
    c.appendChild(row);
  });
}
function renderChat(){
  const body=document.getElementById('chatBody'); if(!body) return; body.innerHTML='';
  const hist=(currentChatId&&allChats[currentChatId])?allChats[currentChatId].history:[];
  if(hist.length===0){
    const w=document.createElement('div'); w.id='welcomeScreen'; w.className='flex flex-col items-center justify-center h-full text-center';
    w.innerHTML=`<div class="relative w-20 h-20 mx-auto mb-4"><div class="absolute inset-[-12px] rounded-full sparkle"></div><div class="relative z-10 flex items-center justify-center w-20 h-20 text-4xl font-black text-black bg-brand rounded-2xl shadow-lg">S</div></div><h1 class="text-2xl font-bold">How can I help you today?</h1>`;
    body.appendChild(w); return;
  }
  hist.forEach(m=>{
    const wrap=document.createElement('div');
    wrap.className=`mb-3 flex ${m.role==='user'?'justify-end':'justify-start'}`;
    const bubble=m.role==='user'
      ? `<div class="max-w-[85%] rounded-xl bg-brand text-black px-4 py-2 shadow">${m.text}</div>`
      : `<div class="max-w-[85%] rounded-xl bg-white dark:bg-[#0f172a] border border-gray-200 dark:border-[#1f2937] px-4 py-2 shadow">${m.text}</div>`;
    wrap.innerHTML=bubble; body.appendChild(wrap);
  });
  const chat=document.getElementById('chat'); chat?.scrollTo({top:chat.scrollHeight,behavior:'smooth'});
}
function renderQuickActions(){
  const actions=[
    { label:'Schedule Appointment', icon:'📅', href:ENGAGE.appointment },
    { label:'Find Jobs',           icon:'🔎', href:ENGAGE.jobOpenings },
    { label:'Training Programs',   icon:'🎓', href:ENGAGE.trainings },
    { label:'Community Resources', icon:'🏥', href:ENGAGE.communityResources }
  ];
  const el=document.getElementById('quickActionsContainer'); el.innerHTML='';
  actions.forEach(a=>{
    const link=document.createElement('a');
    link.href=a.href; link.target='_blank'; link.rel='noopener noreferrer';
    link.className='flex items-center justify-between w-full px-3 py-2 bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700';
    link.innerHTML=`<span class="flex items-center gap-2"><span>${a.icon}</span><span>${a.label}</span></span><svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`;
    el.appendChild(link);
  });
}

/* ---------------- AI call (your /api/ai reads Supabase first) ---------------- */
async function fetchAI(prompt){
  const r=await fetch(api('/api/ai'),{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({prompt})
  });
  if(!r.ok){ const t=await r.text(); throw new Error(`AI ${r.status}: ${t}`); }
  const j=await r.json(); return j?.reply||'Sorry, no answer.';
}

/* ---------------- Boot ---------------- */
document.addEventListener('DOMContentLoaded',()=>{
  // Theme & Language
  const savedTheme=localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'); applyTheme(savedTheme);
  const sel=document.getElementById('languageSelector'); const savedLang=localStorage.getItem('lang')||(navigator.language||'en'); setLanguage(savedLang);
  sel?.addEventListener('change',e=>setLanguage(e.target.value));
  document.getElementById('themeToggleSplash')?.addEventListener('click',toggleTheme);
  document.getElementById('themeToggleApp')?.addEventListener('click',toggleTheme);

  // Open app
  document.getElementById('start')?.addEventListener('click',()=>{
    document.getElementById('splash')?.classList.add('hidden');
    document.getElementById('app')?.classList.remove('hidden');
    renderQuickActions();
    loadChats();
    if(!Object.keys(allChats).length) startNewChat(); else renderChat();

    // OPTIONAL: silent health check using an existing API route (no new files)
    fetch(api('/api/trainings'), { cache:'no-store' }).catch(()=>{});
  });

  // New Chat
  document.getElementById('newChat')?.addEventListener('click',startNewChat);

  // Composer
  const input=document.getElementById('input'), send=document.getElementById('send'), form=document.getElementById('composer');
  const updateSend=()=>{ send.disabled = !(input.value.trim().length>0); };
  ['input','change','keyup','paste'].forEach(ev=> input.addEventListener(ev,updateSend));
  input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); form.requestSubmit(); }});
  updateSend();

  form?.addEventListener('submit',async(e)=>{
    e.preventDefault();
    const text=input.value.trim(); if(!text) return;
    addMessageToHistory('user',text); renderChat(); input.value=''; updateSend();
    try{
      const reply=await fetchAI(text);
      addMessageToHistory('assistant',reply); renderChat();
    }catch(err){
      addMessageToHistory('assistant','Sorry — I could not reach the service.'); renderChat();
      console.error(err);
    }
  });
});
</script>
</body>
</html>
