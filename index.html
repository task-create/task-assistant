<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TASK Assistant</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase browser client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { --brand: #ff8a00; --brand-light: #ffd088; }
    .prose { color: inherit; } .prose strong { color: inherit; } .prose a { color: #3b82f6; text-decoration: underline; } .dark .prose a { color: #93c5fd; }
    .prose ul > li::before { background-color: #6b7280; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #718096; }
    @media (prefers-reduced-motion: reduce){ .animate-spin, .animate-bounce, .transition-all { transition: none !important } }
    .sparkle { background: conic-gradient(from 0deg, var(--brand) 0%, var(--brand-light) 25%, transparent 40%, transparent 60%, var(--brand-light) 75%, var(--brand) 100%); filter: blur(14px) saturate(1.2); }
    .action-btn-group { opacity: 0; transition: opacity 0.2s ease-in-out; } .group:hover .action-btn-group { opacity: 1; }
    aside { overflow-x: hidden; transition: width 0.3s ease-in-out; }
    @media (min-width: 1024px) { #app.sidebar-collapsed { grid-template-columns: 0 1fr; } }
    .history-item-actions { opacity: 0; transition: opacity 0.2s ease-in-out; } .history-item:hover .history-item-actions { opacity: 1; }
    /* Keep chat input pinned; ensure inner scrollers own the scroll */
    main, .main-col { min-height: 0; }
    #chat { overscroll-behavior: contain; }
  </style>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: { colors: { brand: 'var(--brand)' } } } }
  </script>
</head>
<body class="bg-gray-100 dark:bg-[#0b1220] text-gray-900 dark:text-gray-100 font-sans antialiased">

  <!-- Splash -->
  <div id="splash" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 dark:bg-gray-900 p-4">
    <div class="w-full max-w-md p-8 text-center bg-white dark:bg-[#0f172a] rounded-2xl shadow-2xl border border-gray-200 dark:border-[#1f2937] relative">
      <button id="themeToggleSplash" class="absolute top-4 right-4 p-2 rounded-full border border-gray-200 dark:border-[#1f2937]"><svg id="themeIconSplash" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
      <div class="absolute top-4 left-4">
        <select id="languageSelector" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-[#1f2937] rounded-md p-1 text-sm">
          <option value="auto">Auto</option>
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>
      <div class="relative w-24 h-24 mx-auto mb-6"><div class="absolute inset-[-16px] rounded-full sparkle animate-spin [animation-duration:4s]"></div><div class="relative z-10 flex items-center justify-center w-24 h-24 text-5xl font-black text-black bg-brand rounded-2xl shadow-lg">T</div></div>
      <h1 id="splashTitle" class="text-3xl font-extrabold text-gray-900 dark:text-white">TASK Assistant</h1>
      <p id="splashSubtitle" class="mt-2 text-gray-600 dark:text-[#9aa4b2]">Your guide to career and community resources.</p>
      <div class="mt-8"><button id="start" class="w-full px-6 py-3 text-lg font-semibold text-black bg-brand rounded-xl hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand dark:focus:ring-offset-[#0f172a]">Start</button></div>
    </div>
  </div>

  <div id="app" class="hidden h-screen w-screen lg:grid lg:grid-cols-[280px_1fr] transition-all duration-300">
    <!-- Left sidebar -->
    <aside class="flex-col hidden h-full p-3 bg-white lg:flex dark:bg-[#0f172a] border-r border-gray-200 dark:border-[#1f2937] w-[280px]">
      <div class="flex items-center gap-3 p-2"><div class="relative w-10 h-10"><div class="absolute inset-[-8px] rounded-full sparkle"></div><div class="relative z-10 flex items-center justify-center w-10 h-10 text-xl font-bold text-black bg-brand rounded-lg">T</div></div><span class="text-xl font-semibold">TASK Assistant</span></div>
      <button id="newChat" class="flex items-center justify-between w-full p-3 mt-6 text-left bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700"><span>New Chat</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button>
      <div class="px-2 mt-6"><h3 class="px-2 text-sm font-semibold text-gray-500 uppercase tracking-wider">Quick Actions</h3><div id="quickActionsContainer" class="mt-2 space-y-1"></div></div>
      <div class="mt-4 flex-1 overflow-y-auto custom-scrollbar"><h3 class="px-2 text-sm font-semibold text-gray-500">Recent</h3><div id="historyContainer" class="mt-2 space-y-1"></div></div>
      <div class="p-2 border-t border-gray-200 dark:border-gray-700"><button id="themeToggleApp" class="flex items-center w-full gap-3 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800"><svg id="themeIconApp" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg><span id="themeTextApp" class="text-sm font-medium">Dark Mode</span></button></div>
    </aside>

    <!-- Main column -->
    <main class="relative flex flex-col h-screen overflow-hidden bg-gray-100 dark:bg-[#0b1220]">
      <button id="toggleSidebarBtn" class="absolute top-4 -left-3 z-20 hidden lg:flex items-center justify-center w-6 h-6 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full shadow-md hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-brand"><svg id="toggleSidebarIcon" class="w-4 h-4 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>

      <div class="main-col flex flex-col flex-1 min-h-0 w-full max-w-4xl mx-auto">
        <header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-[#1f2937] lg:hidden">
          <div class="flex items-center gap-3"><div class="relative w-8 h-8"><div class="absolute inset-[-6px] rounded-full sparkle"></div><div class="relative z-10 flex items-center justify-center w-8 h-8 text-lg font-bold text-black bg-brand rounded-md">T</div></div><span class="text-lg font-semibold">TASK Assistant</span></div>
          <button id="menuBtn" class="p-2 rounded-md lg:hidden"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
        </header>

        <!-- Scrollable chat area -->
        <div id="chat" class="flex-1 min-h-0 overflow-y-auto custom-scrollbar p-4 md:p-6 flex">
          <div id="chatBody" class="w-full">
            <div id="welcomeScreen" class="flex flex-col items-center justify-center h-full text-center">
              <div class="relative w-20 h-20 mx-auto mb-4"><div class="absolute inset-[-12px] rounded-full sparkle"></div><div class="relative z-10 flex items-center justify-center w-20 h-20 text-4xl font-black text-black bg-brand rounded-2xl shadow-lg">T</div></div>
              <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">How can I help you today?</h1>
            </div>
          </div>
        </div>

        <!-- Sticky composer -->
        <div class="sticky bottom-0 z-10 px-4 pb-4 pt-2 md:px-6 md:pb-6 bg-gray-100/95 dark:bg-[#0b1220]/95 backdrop-blur">
          <div id="suggestions" class="flex flex-wrap gap-2 mb-3"></div>
          <form id="composer" class="relative" autocomplete="off">
            <textarea id="input" class="w-full p-4 pr-32 text-base bg-white dark:bg-[#0f172a] border border-gray-300 dark:border-[#1f2937] rounded-xl resize-none focus:ring-2 focus:ring-brand focus:outline-none" placeholder="Type your question…" rows="1"></textarea>
            <div class="absolute bottom-2.5 right-3 flex items-center gap-2">
              <button id="mic" type="button" class="p-2 text-gray-500 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Dictate"><svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg></button>
              <button id="send" type="submit" class="p-2 text-white bg-brand rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed" disabled><svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button>
            </div>
          </form>
          <div id="status" class="mt-2 text-sm text-center text-gray-500"></div>
          <div class="mt-3 text-xs text-center text-gray-500 dark:text-gray-400 space-y-1.5">
            <p><span class="font-semibold">Disclaimer:</span> This AI assistant can make mistakes. Please verify important information.</p>
            <div class="flex flex-wrap justify-center items-center gap-x-4 gap-y-1">
              <p><span class="font-semibold">Crisis?</span> Call/Text <a href="tel:988" class="underline hover:text-brand">988</a></p>
              <p><span class="font-semibold">Emergencies:</span> <a href="tel:911" class="underline hover:text-brand">911</a></p>
              <p><span class="font-semibold">Appointments:</span> <a href="tel:+16093371624" class="underline hover:text-brand">609-337-1624</a></p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile menu + delete modal (unchanged for brevity) -->
    <div id="mobileMenu" class="fixed inset-0 z-40 hidden bg-black bg-opacity-50 lg:hidden"></div>
    <div id="deleteModal" class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-50"></div>
  </div>

<script type="module">
  /* ---------------- Config ---------------- */
  // Engage links
  const ENGAGE = {
    landing: "https://bycell.co/ddmnx", jobAssistance: "https://bycell.co/ddnke", trainingOpps: "https://bycell.co/ddnki", resources: "https://bycell.co/ddnkj",
    careerTips: "https://bycell.co/ddmui", communityResources: "https://bycell.co/ddmua", employmentVerification: "https://bycell.co/ddmwm", events: "https://bycell.co/ddmul",
    jobOpenings: "https://bycell.co/ddmtq", appointment: "https://bycell.co/ddncs", otherServices: "https://bycell.co/ddmud", trainings: "https://bycell.co/ddmtn"
  };

  // AI API base
  const DEPLOY_BASE = 'https://task-assistant-xi.vercel.app';
  const ON_SAME_SITE = typeof location !== 'undefined' && (location.hostname === 'localhost' || location.hostname.endsWith('task-assistant-xi.vercel.app'));
  const API_BASE = ON_SAME_SITE ? '' : DEPLOY_BASE;
  const api = (path) => `${API_BASE}${path}`;

  // Supabase (browser)
  const SUPABASE_URL = "https://yamqxbmckcaaltswxmny.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // System prompt
  const SYSTEM_PROMPT = `You are the TASK Assistant, a friendly, empathetic, and professional career guide for Task Employment Services. Your primary goal is to provide clear, actionable advice on all employment-related topics, including resume writing, interview preparation, job searching, and career development. Be encouraging and use markdown for clarity. If users need to take action, guide them to the [Engage by Cell portal](https://bycell.co/ddmnx). If you detect crisis language, share 988.`

  /* ---------------- Theme ---------------- */
  const sunIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
  const moonIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
  function applyTheme(theme) {
    document.documentElement.classList.toggle('dark', theme === 'dark');
    localStorage.setItem('theme', theme);
    const isDark = theme === 'dark';
    const themeIconSplash = document.getElementById('themeIconSplash');
    if (themeIconSplash) themeIconSplash.innerHTML = isDark ? sunIcon : moonIcon;
    const themeIconApp = document.getElementById('themeIconApp');
    const themeTextApp = document.getElementById('themeTextApp');
    if (themeIconApp && themeTextApp) {
      themeIconApp.innerHTML = isDark ? sunIcon : moonIcon;
      themeTextApp.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }
  }
  function toggleTheme() {
    const currentTheme = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
    applyTheme(currentTheme);
  }

  /* ---------------- State ---------------- */
  let currentChatId = null;
  let allChats = {};
  let conversationState = { mode: null, step: 0, data: {} };
  let recognition = null, listening = false;
  let userLang = 'en'; // 'en' | 'es'
  let chatToDelete = null;

  /* ---------------- DOM Ready ---------------- */
  document.addEventListener('DOMContentLoaded', () => {
    const splash = document.getElementById('splash'), app = document.getElementById('app');
    const startBtn = document.getElementById('start');
    const chatBody = document.getElementById('chatBody');
    const form = document.getElementById('composer'), input = document.getElementById('input'), sendBtn = document.getElementById('send');
    const micBtn = document.getElementById('mic');
    const newChatBtn = document.getElementById('newChat');
    const menuBtn = document.getElementById('menuBtn'), mobileMenu = document.getElementById('mobileMenu');
    const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
    const themeToggleSplash = document.getElementById('themeToggleSplash');
    const themeToggleApp = document.getElementById('themeToggleApp');
    const languageSelector = document.getElementById('languageSelector');

    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);

    if (startBtn) {
      startBtn.addEventListener('click', () => {
        splash?.classList.add('hidden');
        app?.classList.remove('hidden');
        renderQuickActions();
        loadChats();
        setSidebarState(localStorage.getItem('sidebarCollapsed') === 'true');
        if (Object.keys(allChats).length === 0) startNewChat();
        else loadChat(Object.keys(allChats).sort((a,b) => b.split('_')[1] - a.split('_')[1])[0]);
        input?.focus();
      });
    }

    themeToggleSplash?.addEventListener('click', toggleTheme);
    themeToggleApp?.addEventListener('click', toggleTheme);

    languageSelector?.addEventListener('change', (e) => setLanguage(e.target.value));

    if (input) {
      ['input','change','keyup','paste'].forEach(ev => {
        input.addEventListener(ev, () => { updateSendState(); autosize(); });
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          form?.requestSubmit();
        }
      });
    }
    sendBtn?.addEventListener('click', (e) => { e.preventDefault(); form?.requestSubmit(); });
    newChatBtn?.addEventListener('click', startNewChat);
    menuBtn?.addEventListener('click', () => mobileMenu?.classList.remove('hidden'));
    mobileMenu?.addEventListener('click', (e) => { if (e.target === mobileMenu) mobileMenu.classList.add('hidden'); });
    toggleSidebarBtn?.addEventListener('click', () => setSidebarState(!document.getElementById('app')?.classList.contains('sidebar-collapsed')));

    if (form) form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = (input?.value || '').trim();
      if (!prompt) { updateSendState(); return; }

      // Auto-detect language on first user message if selector is "auto"
      if (document.getElementById('languageSelector')?.value === 'auto' && allChats[currentChatId]?.history?.filter(m=>m.role==='user').length === 0) {
        userLang = detectLang(prompt);
      }

      if (!currentChatId || (allChats[currentChatId] && allChats[currentChatId].history.length === 0)) {
        if (!currentChatId) startNewChat();
        addMessageToHistory('assistant', greetText());
        renderChat();
      }

      addMessageToHistory('user', prompt);
      bubbleMe(prompt);
      if (input) input.value = '';
      autosize();
      updateSendState();
      showChips([]);
      setStatus('Thinking…');
      const typingIndicator = createTypingIndicator();
      chatBody?.appendChild(typingIndicator);

      try {
        const response = await getSmartResponse(prompt);
        typingIndicator?.remove();
        addMessageToHistory('assistant', response.text);
        bubbleBot(response.text);
        updateChatTitle(prompt);
        setStatus('');
      } catch (err) {
        console.error(err);
        typingIndicator?.remove();
        setStatus(`Error: ${err.message}.`, true);
        bubbleBot(userLang === 'es' ? 'Lo siento—no pude conectar con el servicio. Inténtalo de nuevo.' : 'Sorry — I could not reach the service. Please try again.');
        resetConversationState();
      }
    });

    micBtn?.addEventListener('click', () => {
      if (!recognition) recognition = initSTT();
      if (!recognition) { setStatus('Voice input not supported in this browser.', true); return; }
      recognition.lang = userLang === 'es' ? 'es-US' : 'en-US';
      if (!listening) recognition.start(); else recognition.stop();
    });

    updateSendState(); autosize();
  });

  /* ---------------- Language helpers ---------------- */
  function setLanguage(val) {
    if (val === 'auto') return; // will detect on first message
    userLang = (val === 'es') ? 'es' : 'en';
    const t = (en, es) => (userLang === 'es' ? es : en);
    document.getElementById('splashTitle').textContent = t('TASK Assistant', 'Asistente de TASK');
    document.getElementById('splashSubtitle').textContent = t('Your guide to career and community resources.', 'Su guía de recursos profesionales y comunitarios.');
    document.getElementById('start').textContent = t('Start', 'Empezar');
  }
  function detectLang(text) {
    const s = text.toLowerCase();
    const spanishHits = ['hola','buenos','gracias','por favor','necesito','trabajo','ayuda','entrevista','currículum','cómo','dónde','qué'].filter(w => s.includes(w)).length;
    return spanishHits >= 2 || /^[\s¡¿a-záéíóúñü,.;:!?0-9-]+$/i.test(s) && /[áéíóúñ]/.test(s) ? 'es' : 'en';
  }
  function greetText() {
    return (userLang === 'es')
      ? '¡Hola! Soy el Asistente de TASK. ¿En qué puedo ayudarte hoy?'
      : "Hello! I'm the TASK Assistant. How can I help you?";
  }

  /* ---------------- Supabase helpers ---------------- */
  async function sbSelect(table, select = '*', orderField = 'created_at', limit = 50) {
    const { data, error } = await supabase.from(table).select(select).order(orderField, { ascending: false }).limit(limit);
    if (error) return { ok:false, error:error.message };
    return { ok:true, data };
  }

  /* ---------------- Conversation logic ---------------- */
  async function handleGuidedConversation(prompt) {
    if (conversationState.mode === 'TRIP_PLANNER') return handleTripPlanner(prompt);
    resetConversationState();
    return getGenerativeResponse(prompt);
  }
  async function handleTripPlanner(prompt) {
    const step = conversationState.step;
    if (step === 1) {
      conversationState.data.origin = prompt;
      conversationState.step = 2;
      return { text: userLang === 'es' ? "Entendido. ¿Cuál es tu destino (dirección o lugar)?" : "Got it. And what's the destination (address or landmark)?" };
    }
    if (step === 2) {
      conversationState.data.destination = prompt;
      const origin = encodeURIComponent(conversationState.data.origin);
      const destination = encodeURIComponent(conversationState.data.destination);
      // Prefill NJ Transit correctly – use only *_text params
      const tripUrl = `https://www.njtransit.com/trip-planner-to?origin_text=${origin}&destination_text=${destination}`;
      const responseText = (userLang === 'es')
        ? `¡Listo! Abre este enlace para ver las mejores rutas en el sitio oficial de NJ Transit con tus datos ya completados:\n\n[Ver indicaciones de mi viaje](${tripUrl})`
        : `Great! Here’s the link to see the best routes on the official NJ Transit site with your trip pre-filled:\n\n[View my trip directions](${tripUrl})`;
      resetConversationState();
      return { text: responseText };
    }
  }

  async function getSmartResponse(prompt) {
    const p = prompt.toLowerCase();
    const hasWord = (words) => words.some(word => new RegExp(`\\b${word}\\b`, 'i').test(p));

    if (conversationState.mode) return handleGuidedConversation(prompt);

    const crisis = ['kill myself','hurt myself','suicide','end my life'];
    if (hasWord(crisis)) {
      return { text: (userLang==='es')
        ? "Parece que estás pasando por un momento muy difícil. Por favor, llama o envía un mensaje al 988 ahora mismo. Si estás en peligro inmediato, llama al 911."
        : "It sounds like you’re in immediate distress. Please call or text 988 right now. If you’re in immediate danger, call 911." };
    }

    if (hasWord(['trip','directions','bus route','transit','get to','plan a trip'])) {
      conversationState = { mode:'TRIP_PLANNER', step:1, data:{} };
      return { text: userLang === 'es'
        ? "Puedo ayudarte. ¿Desde dónde sales (dirección u lugar de origen)?"
        : "I can help with that. Where are you starting from (origin address or landmark)?" };
    }

    if (hasWord(['training','trainings','class','classes','culinary','sora','forklift','certification'])) {
      setStatus(userLang==='es' ? 'Consultando el calendario…' : 'Checking our program schedule…');
      const result = await sbSelect('trainings', 'name, description, schedule, next_start_date, start_date_note, app_window_start, app_window_end, requirements');
      let context = userLang==='es' ? "Actualmente no hay programas de capacitación programados." : "There are currently no training programs scheduled.";
      if (result.ok && result.data?.length) {
        context = (userLang==='es' ? "Lista de capacitaciones:\n\n" : "Here is a list of our current training programs:\n\n")
          + result.data.map(t => (
            `---
Program: ${t.name}
Description: ${t.description}
Schedule: ${t.schedule || (userLang==='es'?'No especificado.':'Not specified.')}
Next Start Date: ${t.next_start_date ? new Date(t.next_start_date).toLocaleDateString() : (userLang==='es'?'Sin fecha':'N/A')}. ${t.start_date_note||''}
Application Window: ${t.app_window_start?new Date(t.app_window_start).toLocaleDateString():''} - ${t.app_window_end?new Date(t.app_window_end).toLocaleDateString():''}
Requirements: ${t.requirements||'-'}
---`
          )).join('\n\n');
      }
      const finalPrompt = `CONTEXT:\n${context}\n\nReply in ${userLang==='es'?'Spanish':'English'} to the user: "${prompt}"`;
      return getGenerativeResponse(finalPrompt);
    }

    if (hasWord(['job','jobs','opening','hiring','apply'])) {
      setStatus(userLang==='es' ? 'Buscando empleos destacados…' : 'Checking our featured jobs list…');
      const result = await sbSelect('jobs', 'title, company, apply_link');
      let context = userLang==='es' ? "No hay empleos destacados por el momento." : "There are currently no featured jobs from our partners.";
      if (result.ok && result.data?.length) {
        context = result.data.map(job => `* **${job.title}** at ${job.company}. [Apply Here](${job.apply_link})`).join('\n');
      }
      const finalPrompt = `The user asked about jobs. First present the jobs from CONTEXT; then ask if they'd like a broader search.\n\nCONTEXT:\n${context}\n\nUSER: "${prompt}"\nReply in ${userLang==='es'?'Spanish':'English'}.`;
      return getGenerativeResponse(finalPrompt);
    }

    if (hasWord(['resource','resources','food','pantry','housing','shelter','legal','support'])) {
      setStatus(userLang==='es' ? 'Buscando recursos…' : 'Looking up community resources…');
      const result = await sbSelect('resources', 'name, provider, description, website');
      let context = userLang==='es' ? "No hay recursos comunitarios listados." : "No community resources are listed at this time.";
      if (result.ok && result.data?.length) {
        context = result.data.map(r => `* **${r.name}** (${r.provider}): ${r.description} Website: ${r.website || 'N/A'}`).join('\n');
      }
      const finalPrompt = `CONTEXT:\n${context}\n\nBased ONLY on the context above, answer the user's question about resources: "${prompt}". Reply in ${userLang==='es'?'Spanish':'English'}.`;
      return getGenerativeResponse(finalPrompt);
    }

    if (hasWord(['event','events','job fair','workshop'])) {
      setStatus(userLang==='es' ? 'Buscando eventos…' : 'Checking for upcoming events…');
      const result = await sbSelect('events', 'name, event_date');
      let context = userLang==='es' ? "No hay eventos programados." : "There are currently no events scheduled.";
      if (result.ok && result.data?.length) {
        context = result.data.map(e => `* **${e.name}** on ${e.event_date ? new Date(e.event_date).toLocaleString() : ''}.`).join('\n');
      }
      const finalPrompt = `CONTEXT:\n${context}\n\nAnswer about events: "${prompt}". Reply in ${userLang==='es'?'Spanish':'English'}.`;
      return getGenerativeResponse(finalPrompt);
    }

    return getGenerativeResponse(prompt);
  }

  /* ---------------- AI call ---------------- */
  async function getGenerativeResponse(prompt) {
    const sys = SYSTEM_PROMPT + (userLang==='es' ? ' Responde en español claro y amable.' : '');
    const response = await fetch(api('/api/ai'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt, systemPrompt: sys })
    });
    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`API Error: ${response.status} - ${errorBody}`);
    }
    const result = await response.json();
    return result.ok && result.text ? { text: result.text } : { text: userLang==='es' ? "No pude generar una respuesta." : "I couldn't generate a response." };
  }

  /* ---------------- UI helpers (unchanged with small tweaks) ---------------- */
  function autosize() { const i=document.getElementById('input'); if(i){i.style.height='auto'; i.style.height=i.scrollHeight+'px';} }
  function updateSendState() { const i=document.getElementById('input'), s=document.getElementById('send'); if(i&&s){const h=i.value.trim().length>0; s.disabled=!h; s.setAttribute('aria-disabled', String(!h));} }
  function setSidebarState(isCollapsed) {
    const asideEl = document.querySelector('aside');
    const toggleSidebarIcon = document.getElementById('toggleSidebarIcon');
    const app = document.getElementById('app');
    if (app) app.classList.toggle('sidebar-collapsed', isCollapsed);
    if (asideEl) {
      asideEl.classList.toggle('w-[280px]', !isCollapsed);
      asideEl.classList.toggle('w-0', isCollapsed);
      asideEl.classList.toggle('p-3', !isCollapsed);
      asideEl.classList.toggle('p-0', isCollapsed);
    }
    if (toggleSidebarIcon) {
      toggleSidebarIcon.innerHTML = isCollapsed
        ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`
        : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>`;
    }
    localStorage.setItem('sidebarCollapsed', String(isCollapsed));
  }
  function saveChats() { localStorage.setItem('allChats', JSON.stringify(allChats)); }
  function loadChats() { const saved = localStorage.getItem('allChats'); if(saved) allChats = JSON.parse(saved); renderHistory(); }
  function loadChat(chatId) { currentChatId = chatId; resetConversationState(); renderChat(); renderHistory(); scrollToBottom(true); }
  function startNewChat() {
    const existingEmpty = Object.values(allChats).find(c => c.title === "New Chat" && c.history.length === 0);
    if (existingEmpty) return loadChat(existingEmpty.id);
    currentChatId = `chat_${Date.now()}`;
    allChats[currentChatId] = { id: currentChatId, title: "New Chat", history: [] };
    resetConversationState(); renderChat(); renderHistory(); saveChats();
    const input = document.getElementById('input'); if (input) input.value = ''; updateSendState();
    showChips([{text:userLang==='es'?'Ayúdame con mi currículum':'Help me with my resume'},{text:userLang==='es'?'¿Cómo preparo una entrevista?':'How do I prepare for an interview?'},{text:userLang==='es'?'¿Qué trabajos hay?':'What jobs are available?'}]);
  }
  function resetConversationState() { conversationState = { mode: null, step: 0, data: {} }; }
  function addMessageToHistory(role, text) { if(!currentChatId || !allChats[currentChatId]) return; allChats[currentChatId].history.push({ role, text }); saveChats(); }
  function updateChatTitle(prompt) { if (allChats[currentChatId] && allChats[currentChatId].title === "New Chat") { const t = prompt.split(' ').slice(0, 4).join(' '); allChats[currentChatId].title = t || 'New Chat'; saveChats(); renderHistory(); } }
  function deleteChat(chatId) { delete allChats[chatId]; saveChats(); if (currentChatId === chatId) { currentChatId = null; const sorted = Object.values(allChats).sort((a,b)=>b.id.split('_')[1]-a.id.split('_')[1]); if (sorted.length>0) loadChat(sorted[0].id); else startNewChat(); } else renderHistory(); }
  function setStatus(msg, isError=false) { const el=document.getElementById('status'); if(el){ el.textContent=msg; el.className = `mt-2 text-sm text-center ${isError ? 'text-red-500' : 'text-gray-500'}`; } }
  function scrollToBottom(instant=false){ const c=document.getElementById('chat'); if(c) c.scrollTo({ top:c.scrollHeight, behavior: instant?'instant':'smooth' }); }
  function renderQuickActions() {
    const actions = [
      { label: 'Schedule Appointment', key: 'appointment', icon: '📅' },
      { label: 'Find Jobs', key: 'jobOpenings', icon: '🔎' },
      { label: 'Training Programs', key: 'trainings', icon: '🎓' },
      { label: 'Community Resources', key: 'communityResources', icon: '🏥' },
      { label: 'Plan a Trip', key: 'trip', icon: '🚌' }
    ];
    const renderInto = (id) => {
      const el = document.getElementById(id); if (!el) return; el.innerHTML = '';
      actions.forEach(({label,key,icon}) => {
        if (key==='trip') {
          const btn = document.createElement('button');
          btn.type='button';
          btn.className='flex items-center justify-between w-full px-3 py-2 bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700';
          btn.innerHTML=`<span class="flex items-center gap-2"><span>${icon}</span><span>${label}</span></span><svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
          btn.addEventListener('click', () => {
            conversationState = { mode:'TRIP_PLANNER', step:1, data:{} };
            bubbleBot(userLang==='es' ? '¿Desde dónde sales (dirección o lugar)?' : 'Where are you starting from (origin address or landmark)?');
          });
          el.appendChild(btn);
          return;
        }
        const href = ENGAGE[key]; if (!href) return;
        const a = document.createElement('a');
        a.href = href; a.target = '_blank'; a.rel='noopener noreferrer';
        a.className='flex items-center justify-between w-full px-3 py-2 bg-gray-100 rounded-lg dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700';
        a.innerHTML = `<span class="flex items-center gap-2"><span>${icon}</span><span>${label}</span></span><svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
        el.appendChild(a);
      });
    };
    renderInto('quickActionsContainer');
    renderInto('quickActionsContainerMobile');
  }
  function renderChat() {
    const chatBody=document.getElementById('chatBody'); if (!chatBody) return;
    chatBody.innerHTML='';
    const history=(currentChatId&&allChats[currentChatId])?allChats[currentChatId].history:[];
    if (!history || history.length===0) {
      const welcome=document.createElement('div');
      welcome.id='welcomeScreen'; welcome.className='flex flex-col items-center justify-center h-full text-center';
      welcome.innerHTML=`<div class="relative w-20 h-20 mx-auto mb-4"><div class="absolute inset-[-12px] rounded-full sparkle"></div><div class="relative z-10 flex items-center justify-center w-20 h-20 text-4xl font-black text-black bg-brand rounded-2xl shadow-lg">T</div></div><h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">${userLang==='es'?'¿Cómo puedo ayudarte hoy?':'How can I help you today?'}</h1>`;
      chatBody.appendChild(welcome); return;
    }
    history.forEach(msg => { if (msg.role==='user') bubbleMe(msg.text,false); else bubbleBot(msg.text,false); });
    scrollToBottom(true);
  }
  function renderHistory() {
    const container=document.getElementById('historyContainer');
    const items=Object.values(allChats).sort((a,b)=>(b.id||'').localeCompare(a.id||''));
    if (!container) return; container.innerHTML='';
    items.forEach(chat => {
      const row=document.createElement('div');
      row.className=`history-item group flex items-center justify-between px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 ${chat.id===currentChatId?'bg-brand/20':''}`;
      row.innerHTML=`<button class="text-left flex-1 truncate" title="${chat.title}">${chat.title}</button>
      <div class="history-item-actions flex gap-2 opacity-0 group-hover:opacity-100">
        <button class="rename-btn text-xs underline">Rename</button>
        <button class="delete-btn text-xs text-red-600 underline">Delete</button>
      </div>`;
      row.querySelector('button.text-left')?.addEventListener('click', () => loadChat(chat.id));
      row.querySelector('.rename-btn')?.addEventListener('click', () => { const t=prompt('Rename chat:', chat.title); if (t) { allChats[chat.id].title=t; saveChats(); renderHistory(); }});
      row.querySelector('.delete-btn')?.addEventListener('click', () => { if (confirm('Delete this chat?')) deleteChat(chat.id); });
      container.appendChild(row);
    });
  }
  function bubbleMe(text, doScroll=true){ const body=document.getElementById('chatBody'); if(!body)return; document.getElementById('welcomeScreen')?.remove(); const w=document.createElement('div'); w.className='mb-3 flex justify-end'; w.innerHTML=`<div class="max-w-[85%] rounded-xl bg-brand text-black px-4 py-2 shadow">${renderSmart(text)}</div>`; body.appendChild(w); if(doScroll)scrollToBottom(); }
  function bubbleBot(text, doScroll=true){ const body=document.getElementById('chatBody'); if(!body)return; document.getElementById('welcomeScreen')?.remove(); const w=document.createElement('div'); w.className='group mb-3 flex justify-start'; w.innerHTML=`<div class="max-w-[85%] rounded-xl bg-white dark:bg-[#0f172a] border border-gray-200 dark:border-[#1f2937] px-4 py-2 shadow prose dark:prose-invert prose-p:my-2 first:prose-p:mt-0 last:prose-p:mb-0">${renderSmart(text)}</div>`; body.appendChild(w); if(doScroll)scrollToBottom(); }
  function showChips(chips=[]){ const s=document.getElementById('suggestions'); if(!s)return; s.innerHTML=''; chips.forEach(c=>{ const b=document.createElement('button'); b.type='button'; b.className='px-3 py-1.5 bg-white dark:bg-[#0f172a] border border-gray-200 dark:border-[#1f2937] rounded-full text-sm hover:bg-gray-50'; b.textContent=c.text; b.addEventListener('click', ()=>{ const i=document.getElementById('input'); if(i)i.value=c.text; updateSendState(); i?.focus(); }); s.appendChild(b); }); }
  function createTypingIndicator(){ const i=document.createElement('div'); i.className='flex items-center gap-2 ml-11'; i.innerHTML=`<div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>`; return i; }
  function renderSmart(text){ const esc=(s)=>s.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); let html=esc(text); html=html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, `<a class="underline" href="$2" target="_blank" rel="noopener noreferrer">$1</a>`); html=html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>'); html=html.split('\n').filter(p=>p.trim()).map(p=>`<p>${p}</p>`).join(''); return html; }
  function initSTT(){ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR)return null; const r=new SR(); r.interimResults=true; r.continuous=false; r.onstart=()=>{listening=true; document.getElementById('micIcon').innerHTML=`<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a.5.5 0 01.5-.5h3a.5.5 0 010 1h-3A.5.5 0 018 7z" clip-rule="evenodd"></path></svg>`;}; r.onend=()=>{listening=false; document.getElementById('micIcon').innerHTML=`<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>`;}; r.onresult=(e)=>{ let txt=''; for(let i=e.resultIndex;i<e.results.length;i++) txt+=e.results[i][0].transcript; document.getElementById('input').value=txt; updateSendState(); autosize(); }; return r; }
</script>
</body>
</html>
