<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solace â€¢ TASK Assistant</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ES%3C/text%3E%3C/svg%3E">
  <!-- Tailwind CDN (warning is informational; fine for now) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: { colors: { brand: '#ff8a00' }}}};
  </script>
  <style>
    :root { --brand:#ff8a00; --ink:#0f172a; }
    .custom-scrollbar::-webkit-scrollbar{width:8px;height:8px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:6px}
    .bubble a{ text-decoration: underline; }
    .bubble{ word-break: break-word; overflow-wrap: anywhere; }
    .bubble pre, .bubble code { white-space: pre-wrap; }
    .composer-shell{position:sticky;bottom:0;background:linear-gradient(to top,rgba(255,255,255,.96),rgba(255,255,255,0))}
    .dark .composer-shell{background:linear-gradient(to top,rgba(15,23,42,.96),rgba(15,23,42,0))}
  </style>
</head>
<body class="bg-gray-100 dark:bg-[#0b1220] text-gray-900 dark:text-gray-100 antialiased">

<!-- App -->
<div class="h-screen w-screen grid lg:grid-cols-[280px_1fr]">

  <!-- Sidebar -->
  <aside class="hidden lg:flex flex-col h-full border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-[#0f172a]">
    <div class="p-3 flex items-center gap-3 border-b border-gray-100 dark:border-gray-800">
      <div class="w-9 h-9 rounded-lg bg-brand text-black font-bold grid place-items-center">S</div>
      <div class="font-semibold">Solace</div>
    </div>

    <div class="p-3 flex items-center gap-2">
      <button id="btnNew" class="px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">New</button>
      <button id="btnRename" class="px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">Rename</button>
      <button id="btnDelete" class="px-3 py-1.5 rounded-md bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">Del</button>
      <button id="btnTheme" class="ml-auto px-3 py-1.5 rounded-md border border-gray-200 dark:border-gray-700">Theme</button>
    </div>

    <div class="px-3">
      <h3 class="text-xs font-semibold text-gray-500 uppercase">Quick Actions</h3>
      <div id="quick" class="mt-2 space-y-2"></div>
    </div>

    <div class="p-3">
      <h3 class="text-xs font-semibold text-gray-500 uppercase">Recent</h3>
      <div id="history" class="mt-2 custom-scrollbar overflow-y-auto" style="max-height: 45vh;"></div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex flex-col h-screen">

    <!-- Mobile header -->
    <header class="lg:hidden flex items-center justify-between p-3 bg-white dark:bg-[#0f172a] border-b border-gray-200 dark:border-gray-800">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-md bg-brand text-black font-bold grid place-items-center">S</div>
        <div class="font-semibold">Solace</div>
      </div>
      <button id="btnThemeM" class="px-3 py-1.5 rounded-md border border-gray-200 dark:border-gray-700">Theme</button>
    </header>

    <!-- Chat -->
    <section id="chatWrap" class="flex-1 overflow-y-auto custom-scrollbar p-4">
      <div id="chatBody" class="max-w-3xl mx-auto space-y-3">
        <div class="text-center mt-8 text-gray-600 dark:text-gray-400">
          <div class="w-16 h-16 mx-auto rounded-xl bg-brand text-black font-black grid place-items-center text-3xl">S</div>
          <p class="mt-3">How can I help you today?</p>
        </div>
      </div>
    </section>

    <!-- Composer -->
    <div class="composer-shell px-4 py-3 md:px-6 md:py-4">
      <form id="composer" class="max-w-3xl mx-auto relative">
        <textarea id="input" rows="1" placeholder="Ask about trainings, jobs, resources, appointmentsâ€¦"
          class="w-full resize-none rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-[#0f172a] p-4 pr-28 focus:ring-2 focus:ring-brand"></textarea>
        <div class="absolute right-2 bottom-2 flex items-center gap-2">
          <button id="btnTransit" type="button" class="px-3 py-1.5 text-sm rounded-md bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700" title="NJ TRANSIT Trip Planner">NJT</button>
          <button id="send" class="px-3 py-1.5 rounded-md text-black bg-brand disabled:bg-gray-400">Send</button>
        </div>
      </form>
    </div>

  </main>
</div>

<script type="module">
/* --------------------------- Config --------------------------- */
const ENGAGE = {
  appointment: "https://bycell.co/ddncs",
  jobs:        "https://bycell.co/ddmtq",
  trainings:   "https://bycell.co/ddmtn",
  resources:   "https://bycell.co/ddmua",
};
const API_AI = "/api/ai";      // same origin
const API_SUGGEST = "/api/suggest"; // optional; not required

/* --------------------------- Theme --------------------------- */
const applyTheme = (t)=>{ document.documentElement.classList.toggle('dark', t==='dark'); localStorage.setItem('theme', t); };
const toggleTheme = ()=> applyTheme(localStorage.getItem('theme')==='dark'?'light':'dark');
applyTheme(localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
document.getElementById('btnTheme')?.addEventListener('click',toggleTheme);
document.getElementById('btnThemeM')?.addEventListener('click',toggleTheme);

/* --------------------------- State --------------------------- */
let chats = JSON.parse(localStorage.getItem('chats')||'{}');
let activeId = localStorage.getItem('activeId') || null; // declare BEFORE functions (fixes TDZ)

/* transit flow state */
const transitFlow = { active:false, origin:null, destination:null };

/* --------------------------- Utils --------------------------- */
function save(){ localStorage.setItem('chats', JSON.stringify(chats)); localStorage.setItem('activeId', activeId||''); }
function newId(){ return 'c_'+Date.now(); }
function ensureChat(){
  if(!activeId || !chats[activeId]) {
    activeId = newId();
    chats[activeId] = { id: activeId, title: 'New chat', messages: [] };
    save(); renderHistory();
  }
}
function linkifyText(s=''){
  // urls
  let out = s.replace(/(https?:\/\/[^\s)]+)\b/gi, m => `<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);
  // phone numbers
  out = out.replace(/(\(\d{3}\)\s?\d{3}-\d{4}|\b\d{3}[-.\s]\d{3}[-.\s]\d{4}\b)/g, m => `<a href="tel:${m.replace(/[^\d]/g,'')}">${m}</a>`);
  return out;
}
function addMsg(role, html){
  ensureChat();
  const rec = { role, html, ts: Date.now() };
  chats[activeId].messages.push(rec);
  // title: first user line becomes title
  if(role==='user' && chats[activeId].title==='New chat'){
    const t = html.replace(/<[^>]+>/g,'').trim().slice(0,40);
    chats[activeId].title = t || 'New chat';
  }
  save(); renderChat(); renderHistory();
}
function bubble(role, html){
  const wrap = document.createElement('div');
  wrap.className = `flex ${role==='user'?'justify-end':'justify-start'}`;
  const inner = document.createElement('div');
  inner.className = `bubble max-w-[85%] rounded-2xl px-4 py-3 shadow text-sm leading-6 ${
    role==='user'
      ? 'bg-brand text-black'
      : 'bg-white dark:bg-[#0f172a] border border-gray-200 dark:border-gray-700'
  }`;
  inner.innerHTML = html;
  wrap.appendChild(inner);
  return wrap;
}
function scrollToBottom(){
  const wrap = document.getElementById('chatWrap');
  wrap?.scrollTo({ top: wrap.scrollHeight, behavior: 'smooth' });
}

/* --------------------------- Renderers --------------------------- */
function renderHistory(){
  const h = document.getElementById('history');
  if(!h) return;
  h.innerHTML = '';
  Object.values(chats).sort((a,b)=>b.id.localeCompare(a.id)).forEach(c=>{
    const row = document.createElement('button');
    row.className = `w-full text-left px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-800 ${c.id===activeId?'bg-brand/20':''}`;
    row.textContent = c.title || 'Untitled';
    row.title = c.title || 'Untitled';
    row.onclick = ()=>{ activeId=c.id; save(); renderChat(); renderHistory(); };
    h.appendChild(row);
  });
}
function renderChat(){
  const body = document.getElementById('chatBody');
  body.innerHTML = '';
  const items = (chats[activeId]?.messages)||[];
  if(!items.length){
    const empty = document.createElement('div');
    empty.className="text-center mt-8 text-gray-600 dark:text-gray-400";
    empty.innerHTML = `<div class="w-16 h-16 mx-auto rounded-xl bg-brand text-black font-black grid place-items-center text-3xl">S</div><p class="mt-3">How can I help you today?</p>`;
    body.appendChild(empty);
  }else{
    items.forEach(m=> body.appendChild(bubble(m.role, m.html)));
  }
  scrollToBottom();
}

/* --------------------------- Quick actions --------------------------- */
function renderQuick(){
  const q = document.getElementById('quick'); if(!q) return;
  const items = [
    {label:'Schedule Appointment', href: ENGAGE.appointment, emoji:'ðŸ“…'},
    {label:'Find Jobs', href: ENGAGE.jobs, emoji:'ðŸ”Ž'},
    {label:'Training Programs', href: ENGAGE.trainings, emoji:'ðŸŽ“'},
    {label:'Community Resources', href: ENGAGE.resources, emoji:'ðŸ“š'},
    {label:'NJ TRANSIT Trip Planner', href:'#', emoji:'ðŸšŒ', onClick: ()=>startTransitFlow()}
  ];
  q.innerHTML='';
  items.forEach(it=>{
    const a = document.createElement(it.href==='#'?'button':'a');
    a.className='w-full flex items-center justify-between px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700';
    a.innerHTML = `<span class="flex items-center gap-2"><span>${it.emoji}</span><span>${it.label}</span></span><span>â€º</span>`;
    if(it.href==='#') a.onclick=it.onClick; else { a.href=it.href; a.target='_blank'; a.rel='noopener noreferrer'; }
    q.appendChild(a);
  });
}

/* --------------------------- NJ TRANSIT flow --------------------------- */
function startTransitFlow(){
  transitFlow.active = true; transitFlow.origin = null; transitFlow.destination = null;
  addMsg('assistant', 'ðŸšŒ Sure â€” letâ€™s plan your trip. <b>What is your <i>origin</i> address?</b>');
}
function maybeHandleTransit(userText){
  if(!transitFlow.active) return false;
  if(!transitFlow.origin){
    transitFlow.origin = userText.trim();
    addMsg('assistant', 'Got it. <b>What is your destination address?</b>');
    return true;
  }
  if(!transitFlow.destination){
    transitFlow.destination = userText.trim();
    const o = encodeURIComponent(transitFlow.origin);
    const d = encodeURIComponent(transitFlow.destination);
    const njt = `https://www.njtransit.com/trip-planner?from=${o}&to=${d}&mode=transit`;
    const gmaps = `https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}&travelmode=transit`;
    const html = [
      `<b>Here are your pre-filled links:</b>`,
      `â€¢ <a href="${njt}" target="_blank" rel="noopener">NJ TRANSIT Trip Planner</a>`,
      `â€¢ <a href="${gmaps}" target="_blank" rel="noopener">Google Maps (Transit)</a>`,
      `<br/>Safe travels! ðŸš†`
    ].join('<br/>');
    addMsg('assistant', html);
    transitFlow.active = false;
    return true;
  }
  return false;
}

/* --------------------------- Network --------------------------- */
async function fetchAI(prompt){
  const r = await fetch(API_AI, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ prompt })
  });
  if(!r.ok){
    const t = await r.text().catch(()=> '');
    throw new Error(t || `HTTP ${r.status}`);
  }
  const j = await r.json();
  // Accept either {text} or {reply}
  return j.text || j.reply || '(no response)';
}

/* --------------------------- Boot --------------------------- */
function init(){
  // ensure one chat
  ensureChat();
  renderQuick(); renderHistory(); renderChat();

  // actions
  document.getElementById('btnNew')?.addEventListener('click', ()=>{
    activeId = newId();
    chats[activeId] = { id: activeId, title:'New chat', messages: [] };
    save(); renderHistory(); renderChat();
  });
  document.getElementById('btnRename')?.addEventListener('click', ()=>{
    ensureChat();
    const current = chats[activeId].title || '';
    const t = prompt('Rename chat:', current);
    if(t){ chats[activeId].title = t.trim(); save(); renderHistory(); }
  });
  document.getElementById('btnDelete')?.addEventListener('click', ()=>{
    if(!activeId) return;
    if(confirm('Delete this chat?')){
      delete chats[activeId];
      activeId = Object.keys(chats)[0] || null;
      save(); renderHistory(); renderChat();
    }
  });

  // composer
  const input = document.getElementById('input');
  const send = document.getElementById('send');
  const form = document.getElementById('composer');
  const btnTransit = document.getElementById('btnTransit');

  const update = ()=> send.disabled = !input.value.trim();
  ['input','keyup','change','paste'].forEach(ev=> input.addEventListener(ev, update));
  update();

  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); }
  });

  btnTransit.addEventListener('click', startTransitFlow);

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const textRaw = input.value.trim();
    if(!textRaw) return;
    input.value=''; update();

    // trip planner capture?
    if(maybeHandleTransit(textRaw)){ addMsg('user', linkifyText(textRaw)); return; }

    // show user bubble immediately
    addMsg('user', linkifyText(textRaw));

    // placeholder
    const body = document.getElementById('chatBody');
    const thinking = bubble('assistant', 'â€¦');
    body.appendChild(thinking); scrollToBottom();

    try{
      // optional tone detector (non-blocking)
      // fetch(API_SUGGEST,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:textRaw})}).catch(()=>{});

      const replyHtml = linkifyText(await fetchAI(textRaw));
      thinking.querySelector('.bubble').innerHTML = replyHtml;
      // also record into history
      chats[activeId].messages.push({ role:'assistant', html: replyHtml, ts: Date.now() });
      save();
    }catch(err){
      thinking.querySelector('.bubble').innerHTML = `Sorry â€” upstream error.<br/><small class="text-gray-500">${(err.message||'').slice(0,300)}</small>`;
      save();
    }
  });
}

init();
</script>
</body>
</html>
