<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TASK Assistant</title>

  <!-- Inline favicon (prevents /favicon.ico 404) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">

  <style>
    :root {
      --bg: #0f1720;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --brand: #ff8a00;
      --radius: 14px;
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      display: grid; place-items: center;
    }
    .app {
      width: min(920px, 94vw); min-height: 70vh; background: var(--panel);
      border-radius: var(--radius); padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,.40);
      display: grid; grid-template-rows: auto 1fr auto; gap: 16px;
    }
    header { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 40px; height: 40px; border-radius: 9px; display: grid; place-items: center;
      background: var(--brand); font-weight: 800; color: #fff;
    }
    .muted { color: var(--muted); }

    .chat {
      overflow: auto; padding: 12px; border-radius: 12px; background: #0b1220; border: 1px solid #1f2937;
      display: flex; flex-direction: column; gap: 12px;
    }
    .bubble {
      max-width: 80%;
      padding: 12px 14px; border-radius: 14px; line-height: 1.4;
      border: 1px solid #1f2937;
      word-wrap: break-word; white-space: pre-wrap;
    }
    .me   { align-self: flex-end; background: #172554; }
    .bot  { align-self: flex-start; background: #111827; }
    .row { display: flex; gap: 8px; }
    input[type="text"] {
      flex: 1; font-size: 18px; padding: 14px; border-radius: 12px;
      background: #0b1220; color: var(--text); border: 1px solid #1f2937;
      outline: none;
    }
    button {
      font-size: 18px; padding: 14px 18px; border-radius: 12px; border: 0; cursor: pointer;
      background: var(--brand); color: #000;
    }
    .toolbar { display: flex; gap: 8px; align-items: center; }
    .pill { font-size: 14px; padding: 8px 12px; border-radius: 999px; background: #0b1220; border: 1px solid #1f2937; }
    .error { color: #fca5a5; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <!-- Inline logo (prevents /logo.png 404) -->
      <div class="logo">T</div>
      <div>
        <div style="font-weight:700;">TASK Assistant</div>
        <div class="muted" style="font-size:14px;">Ask questions. Get help. No setup errors.</div>
      </div>
      <div style="margin-left:auto;" class="toolbar">
        <button id="enable-audio" class="pill">Enable sound</button>
        <span id="audio-status" class="muted">audio off</span>
      </div>
    </header>

    <div id="chat" class="chat" aria-live="polite"></div>

    <form id="composer" class="row" autocomplete="off">
      <input id="input" type="text" placeholder="Type your question…" />
      <button id="send" type="submit">Send</button>
    </form>

    <div id="status" class="muted"></div>
  </div>

  <!-- Tone.js -->
  <script type="module">
    import * as Tone from "https://cdn.jsdelivr.net/npm/tone@15.1.22/build/Tone.js";

    const chat  = document.getElementById('chat');
    const form  = document.getElementById('composer');
    const input = document.getElementById('input');
    const statusEl = document.getElementById('status');
    const enableBtn = document.getElementById('enable-audio');
    const audioStatus = document.getElementById('audio-status');

    // --- Audio gate (fixes "AudioContext was not allowed to start") ---
    let audioReady = false;
    async function ensureAudio() {
      if (!audioReady) {
        if (Tone.context.state !== 'running') await Tone.start();
        audioReady = true;
        audioStatus.textContent = 'audio on';
        enableBtn.classList.add('hidden');
      }
    }
    enableBtn.addEventListener('click', ensureAudio);

    function ding() {
      if (!audioReady) return;
      const synth = new Tone.Synth().toDestination();
      synth.triggerAttackRelease("C5", "8n");
    }

    // --- UI helpers ---
    function bubble(text, who='bot') {
      const div = document.createElement('div');
      div.className = `bubble ${who}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function setStatus(msg, isError=false) {
      statusEl.textContent = msg || '';
      statusEl.className = isError ? 'error' : 'muted';
    }

    // --- API client (correct path: /api/ai) ---
    const API_URL = '/api/ai';

    async function askAI(prompt, history=[]) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, history }),
      });
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`Upstream error: ${res.status} ${res.statusText}\n${text}`);
      }
      return res.json();
    }

    // --- Chat send flow ---
    const history = [];
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Start audio as part of the user's first gesture if not already
      if (!audioReady) await ensureAudio();

      const prompt = input.value.trim();
      if (!prompt) return;

      bubble(prompt, 'me');
      input.value = '';
      setStatus('Thinking…');

      try {
        const json = await askAI(prompt, history);
        const text = json?.text || '(no response)';
        history.push({ role: 'user', text: prompt });
        history.push({ role: 'assistant', text });

        bubble(text, 'bot');
        setStatus('');
        ding();
      } catch (err) {
        console.error(err);
        const msg = (err && err.message) ? err.message : String(err);
        setStatus(msg.includes('NOT_FOUND') ? 'Service not found. Check /api/ai route.' : msg, true);
        bubble('Sorry — I couldn’t reach the AI service. Please try again.', 'bot');
      }
    });
  </script>
</body>
</html>

