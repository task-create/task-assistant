<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TASK Assistant</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --task-blue:#145078;
      --task-teal:#33A7B5;
      --task-orange:#ff911f;
      --task-yellow:#ffc91f;
      --task-green:#74ba58;
      --task-blue-accent:#0085CA;
      --gray-700:#6b6b6b;
      --gray-200:#e9eef3;

      /* Optional watermark logo (PNG/SVG url) */
      --logo-url:'';
    }

    /* ---------- DARK THEME OVERRIDES ---------- */
    :root[data-theme="dark"]{
      --task-blue:#0e3957;
      --task-teal:#1b6a73;
      --task-orange:#ff9b2a;
      --task-yellow:#ffc44d;
      --task-green:#79cc64;
      --task-blue-accent:#4eb5e6;
      --gray-700:#cfd6dd;
      --gray-200:#1f2a33;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--task-blue) 0%,var(--task-teal) 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:14px;
    }
    :root[data-theme="dark"] body{ color-scheme: dark; background:linear-gradient(135deg,#0b2436 0%, #0d3e44 100%) }

    .app{
      position:relative;
      width:100%;max-width:420px;background:#fff;
      border:3px solid var(--task-orange);border-radius:18px;overflow:hidden;
      box-shadow:0 20px 40px rgba(20,80,120,.30);
    }
    :root[data-theme="dark"] .app{ background:#0e141a; }

    /* Soft watermark */
    .app::before{
      content:"";
      position:absolute;inset:0;pointer-events:none;opacity:.06;
      background:radial-gradient(ellipse at center, #fff 0%, #fff 40%, transparent 60%) center/75% 75% no-repeat;
      mix-blend-mode:normal;
    }
    .app[data-logo="on"]::before{ background:url(var(--logo-url)) center/70% no-repeat; opacity:.05; }
    :root[data-theme="dark"] .app::before{ opacity:.03 }

    .header{
      position:relative;
      text-align:center;background:#fff;border-bottom:2px solid var(--task-blue);padding:12px 44px 10px;
    }
    :root[data-theme="dark"] .header{ background:#0e141a; border-bottom-color:#2a3d4c; }

    .badge{
      display:inline-block;background:var(--task-blue);color:#fff;
      padding:6px 12px;border-radius:999px;font:700 13px/1 "Nunito",sans-serif;letter-spacing:.2px;
    }
    .subline{ margin-top:6px;color:var(--task-orange);font:700 12px/1 "Nunito",sans-serif; }

    /* Theme toggle */
    .theme-toggle{
      position:absolute;right:10px;top:10px;
      width:34px;height:34px;border-radius:999px;border:1px solid var(--task-orange);
      background:#fff;cursor:pointer;font-size:18px;line-height:32px;
    }
    .theme-toggle:focus{ outline:2px solid var(--task-blue-accent) }
    :root[data-theme="dark"] .theme-toggle{ background:#0e141a;color:#ffd; }

    /* Quick-rail */
    .rail{
      display:flex;gap:12px;flex-wrap:wrap;justify-content:center;
      padding:10px 12px;background:#f7fbff;border-bottom:1px solid var(--gray-200);
    }
    .rail a{
      font-weight:600;text-decoration:none;color:var(--task-blue);
      border:1px solid var(--task-orange);background:#fff;border-radius:999px;
      padding:6px 10px;font-size:12px;
    }
    .rail a:hover{background:var(--task-orange);color:#fff}
    :root[data-theme="dark"] .rail{ background:#0f1a21; border-bottom-color:#1f2a33 }
    :root[data-theme="dark"] .rail a{ background:#0e141a; color:#d6e6f2 }

    .chat{height:360px;overflow:auto;background:#fafafa;padding:14px;scroll-behavior:smooth}
    :root[data-theme="dark"] .chat{ background:#0f1a21 }

    .msg{margin:12px 0;padding:12px 16px;border-radius:16px;font-size:13px;line-height:1.45;animation:fade-in .16s ease}
    .user{
      margin-left:20%;text-align:right;color:#fff;
      background:linear-gradient(135deg,var(--task-orange),var(--task-yellow));
      border-radius:16px 16px 4px 16px; box-shadow:0 4px 12px rgba(255,145,31,.28);
    }
    .bot{
      margin-right:20%;background:#fff;border:2px solid var(--task-blue-accent);
      color:#333;border-radius:16px 16px 16px 4px;box-shadow:0 3px 10px rgba(0,133,202,.12);
    }
    :root[data-theme="dark"] .bot{ background:#0f1a21; color:#e7eef6; border-color:var(--task-blue-accent) }

    .typing{display:flex;align-items:center;gap:6px;background:#e8edf2;color:#4b5a69}
    :root[data-theme="dark"] .typing{ background:#15222b; color:#cfe3f1 }
    .dot{width:6px;height:6px;border-radius:50%;background:#4b5a69;animation:bob 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}

    /* Suggestion chips */
    .chips{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      display:inline-block;padding:4px 10px;border-radius:999px;
      border:1px solid var(--task-orange);font-size:11px;font-weight:600;
      background:#fff;color:var(--task-blue);cursor:pointer;user-select:none;
    }
    .chip:hover{background:var(--task-orange);color:#fff}
    :root[data-theme="dark"] .chip{ background:#0e141a; color:#d6e6f2 }

    .footer{padding:12px;background:#fafafa;border-top:2px solid var(--task-blue-accent)}
    :root[data-theme="dark"] .footer{ background:#0f1a21; border-top-color:var(--task-blue-accent) }
    .hint{
      font-size:11px;color:var(--task-blue);
      background:linear-gradient(135deg,rgba(116,186,88,.1),rgba(51,167,181,.1));
      border:2px solid var(--task-green);border-radius:12px;padding:8px 10px;text-align:center;font-weight:600;margin-bottom:10px
    }
    :root[data-theme="dark"] .hint{ color:#cfe3f1; border-color:#79cc64 }

    .inputrow{display:flex;gap:10px;align-items:center}
    input[type="text"]{
      flex:1;padding:14px 16px;border:2px solid var(--task-blue-accent);border-radius:25px;font-size:13px;outline:none;background:#fff;
    }
    input[type="text"]:focus{border-color:var(--task-orange)}
    :root[data-theme="dark"] input[type="text"]{ background:#0e141a; color:#e7eef6; }

    button.send{
      width:50px;height:50px;border:none;border-radius:50%;cursor:pointer;color:#fff;font-size:18px;
      background:linear-gradient(135deg,var(--task-orange),var(--task-yellow));box-shadow:0 4px 15px rgba(255,145,31,.28);
    }

    .status{margin-top:6px;text-align:center;font-size:10px;color:#6b6b6b}
    :root[data-theme="dark"] .status{ color:#b7c4cd }

    @keyframes fade-in{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @keyframes bob{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}

    @media (max-width:480px){ .app{border-radius:16px} }
  </style>
</head>
<body>
  <main class="app" id="app">
    <div class="header">
      <div class="badge">TASK Assistant</div>
      <div class="subline">Trenton Area Soup Kitchen</div>
      <button class="theme-toggle" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">üåô</button>
    </div>

    <!-- Quick links rail (open directly) -->
    <nav class="rail" id="top-rail">
      <a href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">üìç Address</a>
      <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">üíº Jobs</a>
      <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">üîî Alerts</a>
      <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">üéì Training</a>
      <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">üìÑ Resume</a>
      <a href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">üé• Interview Tips</a>
      <a href="https://bycell.co/ddmua" target="_blank" rel="noopener">üß∞ Resources</a>
    </nav>

    <section class="chat" id="chat"></section>

    <footer class="footer">
      <div class="hint" id="hint">I speak English, Espa√±ol & Krey√≤l</div>
      <div class="inputrow">
        <input id="box" type="text" placeholder="Type: training, jobs, hours, address, bus‚Ä¶" autocomplete="off"/>
        <button class="send" id="send" aria-label="Send">‚û§</button>
      </div>
      <div class="status" id="status">‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info!</div>
    </footer>
  </main>

  <script>
    // OPTIONAL watermark logo
    // document.getElementById('app').setAttribute('data-logo','on');

    const chat = document.getElementById('chat');
    const box  = document.getElementById('box');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const hintEl = document.getElementById('hint');
    const themeToggle = document.getElementById('themeToggle');
    const root = document.documentElement;
    const THEME_KEY = 'task-theme';

    let BUSY = false;
    let sessionLang = 'en';   // start in ENGLISH

    /* ============== Theme toggle ============== */
    function applyTheme(t){
      root.setAttribute('data-theme', t);
      themeToggle.textContent = (t==='dark') ? '‚òÄÔ∏è' : 'üåô';
    }
    const savedTheme = localStorage.getItem(THEME_KEY) ||
      (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);
    themeToggle.addEventListener('click', ()=>{
      const t = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, t);
      applyTheme(t);
    });

    /* ============== UI helpers ============== */
    function addUser(text){
      const el = document.createElement('div');
      el.className = 'msg user';
      el.textContent = text;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }
    function addBot(html, chips=[]){
      const el = document.createElement('div');
      el.className = 'msg bot';
      el.innerHTML = html;
      chat.appendChild(el);

      if (chips && chips.length){
        const c = document.createElement('div');
        c.className = 'chips';
        chips.forEach(({label, ask})=>{
          const b = document.createElement('span');
          b.className = 'chip';
          b.textContent = label;
          b.dataset.ask = ask || label;
          c.appendChild(b);
        });
        el.appendChild(c);
      }

      chat.scrollTop = chat.scrollHeight;
    }
    function typingOn(){
      const wrap = document.createElement('div');
      wrap.className = 'msg typing';
      wrap.id = 'typing';
      wrap.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      chat.appendChild(wrap); chat.scrollTop = chat.scrollHeight;
    }
    function typingOff(){ const t = document.getElementById('typing'); if (t) t.remove(); }

    /* ============== Language & time helpers ============== */
    function detectLang(t){
      t = t.toLowerCase();
      const es = /hola|necesito|trabajo|empleo|d[o√≥]nde|cu[a√°]ndo|hora|horas|espa[n√±]ol|tel[e√©]fono|direcci[o√≥]n|cita|servicios|comida|gracias/.test(t);
      const ht = /bonjou|bonswa|mwen|bezwen|travay|kote|ede|manje|krey[o√≤]l|telef[o√≤]n|adr[e√®]s|randevou|s[e√®]vis|m[e√®]si/.test(t);
      return es ? 'es' : ht ? 'ht' : 'en';
    }
    function tryExplicitLangSwitch(t){
      const s = t.trim().toLowerCase();
      if (/(^|\s)(english|ingl[e√©]s)\b/.test(s)) return 'en';
      if (/(^|\s)(espa[n√±]ol|spanish)\b/.test(s)) return 'es';
      if (/(^|\s)(krey[o√≤]l|creole|kr[e√©]y[o√≤]l)\b/.test(s)) return 'ht';
      return null;
    }
    function setLang(l){
      sessionLang = l;
      if (l==='es') hintEl.textContent = 'Hablo Espa√±ol, English & Krey√≤l';
      else if (l==='ht') hintEl.textContent = 'M pale Krey√≤l, English & Espa√±ol';
      else hintEl.textContent = 'I speak English, Espa√±ol & Krey√≤l';
    }
    function nowInfo(){
      const d = new Date();
      const dow = d.getDay(); // 0=Sun
      const hr = d.getHours() + d.getMinutes()/60;
      const afterLunch = hr >= 13;
      const weekend = (dow===0 || dow===6);
      return {d, dow, hr, afterLunch, weekend};
    }

    /* ============== Intent classification ============== */
    const bag = {
      trainings: /(training|trainings|program|programs|class|classes|course|courses|certificate|certification|servsafe|culinary|emilio|academy|sora|forklift|osha|apprenticeship|ged|hiset)\b|capacitaci[o√≥]n|curso|cursos|clases|certificado|certificaci[o√≥]n|culinaria|aprendizaje|montacargas|ged|hiset|f[o√≤]masyon|kou|klas|s[e√®]tifikasyon|akademi|kwizin|forklift|ged|hiset/i,
      jobs: /(job|jobs|opening|openings|hiring|hire|career|careers|apply|application|posting|position|positions|full[- ]?time|part[- ]?time|temp|seasonal|warehouse|security|guard|janitorial|dishwasher|line cook|cdl|ups|amazon)\b|empleo|empleos|vacante|vacantes|contratando|carreras|aplicar|solicitud|puesto|puestos|tiempo completo|medio tiempo|almac[e√©]n|guardia|lavaplatos|cocinero|cdl|travay|pozisyon|ap anboche|kary[e√®]|apl(e|i)ke|depo|gad sekirite|kwizin/i,
      alerts: /(alert|alerts|notify|notification|subscribe|updates)\b|alertas/i,
      resume: /(resume|r√©sum√©|curriculum|curr[i√≠]culum|cv|cover\s*letter|template|plantilla)\b/i,
      interview: /(interview|interview\s*tips|mock\s*interview|practice\s*interview|preguntas de entrevista|consejos de entrevista|kons√®y ent[e√®]vyou)\b/i,
      appointments: /(appointment|schedule|book|register|sign\s*up|rsvp|walk[- ]?in|drop[- ]?in)\b|cita|agendar|programar|reservar|registrarse|inscribirse|randevou|pwograme|anrejistre/i,
      hours: /(hour|hours|today|now|open|close|lunch|dinner|meal|eat|food)\b|horario|hoy|ahora|almuerzo|cena|lunch|dine|louvri|f[e√®]men|manje|jodi a|kounye a/i,
      location: /(where|address|location|directions|map|parking|entrance|wheelchair|escher|trenton transit)\b|direcci[o√≥]n|c[o√≥]mo llegar|mapa|estacionamiento|entrada|kote|adr[e√®]s|direksyon|kat|pakin/i,
      transit: /(bus|bus 600|bus 606|bus 608|bus 613|nj\s*transit|river\s*line|light\s*rail|route|fare|ticket|pass|transfer|planner)\b|autob[u√∫]s|ruta|pase|otobis|wout|pas/i,
      computer_lab: /(computer\s*lab|wifi|wi[- ]?fi|password|print|scan|fax|copy|email help|phone charge|charging)\b|laboratorio de c[o√≥]mputo|clave|imprimir|escanear|f(ax|acs)|copiar|laboratwa|modpas|enprime|eskane|faks|kope/i,
      resources: /(resource|resources|social\s*services|support\s*services|benefits|snap|food\s*stamps|medicaid|ssi|ssd|wic|housing|shelter|rent|utilities|id|identification|birth\s*certificate|mail|clothing|shower|locker|laundry|narcan|veteran|legal|lawyer|attorney|immigration|asylum|green\s*card|expungement|court|mental\s*health|domestic\s*violence|recovery)\b|recursos|beneficios|refugio|renta|servicios|inmigraci[o√≥]n|asilo|abogado|tribunal|lojman|abri|lwaye|idantite|avoka|imigrasyon|tribinal|sante mantal|vyolans domestik/i,
      greeting: /^( *hi| *hello| *hey| *hola| *bonjou)[!. ]*$/i,
      thanks: /(thanks|thank you|gracias|m[e√®]si)\b/i,
      crisis: /(suicide|self[- ]?harm|overdose|kill myself|hurt myself|danger|assault)\b|suicidio|autolesi[o√≥]n|sobredosis|peligro|agresi[o√≥]n|swisid|f[e√®] t[e√®]t li mal|surd[o√≤]z|danje|agresyon/i,
      work_hub: /(work|trabajo|travay)\b/i
    };

    const PRIORITY = [
      'crisis', 'appointments', 'hours', 'location', 'transit',
      'trainings', 'jobs', 'resume', 'interview', 'computer_lab', 'resources', 'greeting', 'thanks'
    ];

    function findIntents(text){
      const t = (' '+text.toLowerCase()+' ').replace(/[^\p{L}\p{N}\s]/gu,' ');
      const hits = [];
      for (const [k, rx] of Object.entries(bag)){
        if (rx.test(t)) hits.push(k);
      }
      if (!hits.includes('jobs') && !hits.includes('trainings') && bag.work_hub.test(t)) hits.push('work_hub');
      hits.sort((a,b)=>PRIORITY.indexOf(a)-PRIORITY.indexOf(b));
      return hits.length ? hits : ['default'];
    }

    /* ============== Localization ============== */
    function L(key){
      const dict = {
        call: {en:'Call', es:'Llama', ht:'Rele'},
        sss: {en:'Social Services Specialist', es:'Especialista de Servicios Sociales', ht:'Espesyalis S√®vis Sosyal'},
        phone: {en:'<a href="tel:609-337-1624">(609) 337-1624</a>', es:'<a href="tel:609-337-1624">(609) 337-1624</a>', ht:'<a href="tel:609-337-1624">(609) 337-1624</a>'},
        during: {
          en:'During lunch (10:30 AM‚Äì1:00 PM)',
          es:'Durante el almuerzo (10:30 AM‚Äì1:00 PM)',
          ht:'L√® manje midi (10:30 AM‚Äì1:00 PM)'
        },
        asked: {en:'You asked about', es:'Me preguntas sobre', ht:'W ap mande sou'},
        training: {en:'training', es:'capacitaciones', ht:'f√≤masyon'},
        jobs: {en:'jobs', es:'empleos', ht:'travay'},
        alerts: {en:'job alerts', es:'alertas de empleo', ht:'al√®t travay'},
        resume: {en:'resume help', es:'ayuda con curr√≠culum', ht:'ede ak CV'},
        interview: {en:'interview tips', es:'consejos de entrevista', ht:'kons√®y ent√®vyou'},
        appt: {en:'an appointment', es:'una cita', ht:'yon randevou'},
        hours: {en:'hours', es:'horarios', ht:'or√® a'},
        location: {en:'our location', es:'nuestra ubicaci√≥n', ht:'kote nou ye'},
        transit: {en:'transit', es:'transporte', ht:'transp√≤'},
        lab: {en:'the computer lab', es:'el laboratorio de computaci√≥n', ht:'laboratwa √≤dinat√® a'},
        resources: {en:'resources', es:'recursos', ht:'resous'}
      };
      return (dict[key]||{})[sessionLang] || (dict[key]||{}).en || '';
    }

    /* ============== Responses ============== */
    function resp_trainings(){
      return (
        `<strong>üéì ${L('asked')} ${L('training')}.</strong><br><br>
         ‚Ä¢ Emilio Culinary Academy (10-week)<br>
         ‚Ä¢ SORA Security Certification<br>
         ‚Ä¢ Forklift Certification<br><br>
         <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Browse training & apply</a><br>
         ${L('call')} ${L('sss')}: ${L('phone')}. ${L('during')}.`
      );
    }
    function resp_jobs(){
      return (
        `<strong>üíº ${L('asked')} ${L('jobs')}.</strong><br><br>
         <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Open positions (Mercer County)</a><br>
         <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Get job alerts</a><br><br>
         Need help applying? ${L('call')} ${L('sss')}: ${L('phone')}. ${L('during')}.`
      );
    }
    function resp_alerts(){
      return `<strong>üîî ${L('asked')} ${L('alerts')}.</strong><br><br>
              <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Subscribe to alerts</a>`;
    }
    function resp_resume(){
      return `<strong>üìÑ ${L('asked')} ${L('resume')}.</strong><br><br>
              <a href="https://bycell.co/ddmui" target="_blank" rel="noopener">Resume help & templates</a><br><br>
              1-on-1 help? ${L('call')} ${L('sss')}: ${L('phone')}. ${L('during')}.`;
    }
    function resp_interview(){
      return `<strong>üé• ${L('asked')} ${L('interview')}.</strong><br><br>
              <a href="https://www.youtube.com/watch?v=ZU9x1vFx5lI" target="_blank" rel="noopener">Watch quick tips</a>`;
    }
    function resp_appt(){
      /* PHONE ONLY ‚Äî no register-online link anywhere */
      return `<strong>üìÖ ${L('asked')} ${L('appt')}.</strong><br><br>
              ${L('call')} ${L('sss')} at ${L('phone')}. ${L('during')}.`;
    }
    function resp_hours(){
      const {afterLunch, weekend} = nowInfo();
      let extra = '';
      if (weekend) extra = sessionLang==='es' ? 'Hoy es fin de semana; el almuerzo vuelve el lunes a las 10:30 AM.'
                 : sessionLang==='ht' ? 'Se fen sem√®n; manje midi retounen lendi a 10:30 AM.'
                 : 'It‚Äôs the weekend; lunch resumes Monday at 10:30 AM.';
      else if (afterLunch) extra = sessionLang==='es' ? 'El almuerzo ya termin√≥; la cena es Lun‚ÄìJue 3:30‚Äì5:00 PM.'
                             : sessionLang==='ht' ? 'Manje midi fini; dine se Len‚ÄìJed 3:30‚Äì5:00 PM.'
                             : 'Lunch is over; dinner is Mon‚ÄìThu 3:30‚Äì5:00 PM.';
      return `<strong>üïí ${L('asked')} ${L('hours')}.</strong><br><br>
              <strong>Meals:</strong> Lunch Mon‚ÄìFri 10:30a‚Äì1:00p ‚Ä¢ Dinner Mon‚ÄìThu 3:30‚Äì5:00p<br>
              Employment appointments are scheduled ${L('during').toLowerCase()}.<br>${extra ? '<br>'+extra : ''}`;
    }
    function resp_location(){
      return `<strong>üìç ${L('asked')} ${L('location')}.</strong><br><br>
              72¬Ω Escher St, Trenton, NJ 08609<br>
              <a href="https://www.google.com/maps?q=72+1/2+Escher+St,+Trenton,+NJ+08609" target="_blank" rel="noopener">Open Google Maps</a><br><br>
              Appointments: ${L('phone')}.`;
    }
    function resp_transit(){
      return `<strong>üöå ${L('asked')} ${L('transit')}.</strong><br><br>
              <a href="https://www.njtransit.com/trip-planner-to" target="_blank" rel="noopener">NJ Transit Trip Planner</a> ‚Ä¢ 1-973-275-5555<br>
              Destination: 72¬Ω Escher St, Trenton.`;
    }
    function resp_lab(){
      return `<strong>üíª ${L('asked')} ${L('lab')}.</strong><br><br>
              Open during meal hours. Free internet & job applications.`;
    }
    function resp_resources(){
      return `<strong>üß∞ ${L('asked')} ${L('resources')}.</strong><br><br>
              <a href="https://bycell.co/ddmua" target="_blank" rel="noopener">Additional resources</a><br>
              <a href="https://trentonsoupkitchen.org/what-we-do/" target="_blank" rel="noopener">Full TASK services</a>`;
    }
    function resp_greeting(){
      return `üëã Hello! Tell me <em>training</em>, <em>jobs</em>, <em>hours</em>, <em>address</em>, or <em>bus</em>.<br><br>
              <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a> ‚Ä¢
              <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Jobs</a>`;
    }
    function resp_crisis(){
      return sessionLang==='es'
        ? `üö® Si t√∫ o alguien est√° en peligro inmediato, llama al 911.<br>
           Para apoyo en crisis 24/7, llama o env√≠a mensaje al <strong>988</strong> (L√≠nea de Vida).`
        : sessionLang==='ht'
        ? `üö® Si ou menm oswa yon moun nan danje imedya, rele 911.<br>
           Pou sip√≤ kriz 24/7, rele oswa voye mesaj <strong>988</strong> (Liy Lavi).`
        : `üö® If you or someone is in immediate danger, call 911.<br>
           For 24/7 crisis support, call or text <strong>988</strong> (Lifeline).`;
    }
    function resp_default(){
      return `I‚Äôll keep it simple. Try ‚Äútraining‚Äù, ‚Äújobs‚Äù, ‚Äúappointment‚Äù, ‚Äúhours‚Äù, ‚Äúaddress‚Äù, or ‚Äúbus‚Äù.<br><br>
              <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a> ‚Ä¢
              <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Jobs</a>`;
    }
    function resp_workHub(){
      return `<strong>üß≠ Work options:</strong> What do you need today?`;
    }

    /* ============== Router & chips ============== */
    function chipsAfter(intent){
      const common = [
        {label:'Training', ask:'training'},
        {label:'Jobs', ask:'jobs'},
        {label:'Address', ask:'address'}
      ];
      switch(intent){
        case 'trainings': return [{label:'Apply for Training', ask:'training programs'}, {label:'Open Jobs', ask:'jobs'}, {label:'Make Appointment', ask:'appointment'}];
        case 'jobs':      return [{label:'Get Job Alerts', ask:'alerts'}, {label:'Resume Help', ask:'resume'}, {label:'Interview Tips', ask:'interview'}];
        case 'appointments': return [{label:'Training', ask:'training'}, {label:'Open Jobs', ask:'jobs'}]; /* NO register online */
        case 'hours':     return [{label:'Address', ask:'address'}, {label:'Transit', ask:'bus to TASK'}, {label:'Make Appointment', ask:'appointment'}];
        case 'location':  return [{label:'Transit', ask:'bus'}, {label:'Hours', ask:'hours today'}, {label:'Make Appointment', ask:'appointment'}];
        case 'resources': return [{label:'Legal Help', ask:'legal'}, {label:'Housing', ask:'housing'}, {label:'Benefits', ask:'benefits'}];
        default:          return common;
      }
    }

    function route(text){
      const switchTo = tryExplicitLangSwitch(text);
      if (switchTo){ setLang(switchTo); return {html: resp_greeting(), chips: chipsAfter('greeting')} }

      setLang(detectLang(text));

      const intents = findIntents(text);
      const top = intents[0];

      switch(top){
        case 'crisis'       : return {html: resp_crisis(),    chips: []};
        case 'appointments' : return {html: resp_appt(),      chips: chipsAfter('appointments')};
        case 'hours'        : return {html: resp_hours(),     chips: chipsAfter('hours')};
        case 'location'     : return {html: resp_location(),  chips: chipsAfter('location')};
        case 'transit'      : return {html: resp_transit(),   chips: chipsAfter('transit')};
        case 'trainings'    : return {html: resp_trainings(), chips: chipsAfter('trainings')};
        case 'jobs'         : return {html: resp_jobs(),      chips: chipsAfter('jobs')};
        case 'resume'       : return {html: resp_resume(),    chips: chipsAfter('resume')};
        case 'interview'    : return {html: resp_interview(), chips: chipsAfter('interview')};
        case 'computer_lab' : return {html: resp_lab(),       chips: chipsAfter('lab')};
        case 'resources'    : return {html: resp_resources(), chips: chipsAfter('resources')};
        case 'greeting'     : return {html: resp_greeting(),  chips: chipsAfter('greeting')};
        case 'thanks'       : return {html: 'üòä You‚Äôre welcome!', chips: chipsAfter('thanks')};
        case 'work_hub'     : return {html: resp_workHub(), chips: [
                                  {label:'Open Jobs', ask:'jobs'},
                                  {label:'Career/Training Help', ask:'training'},
                                  {label:'Resume Help', ask:'resume'}]};
        default             : return {html: resp_default(), chips: chipsAfter('default')};
      }
    }

    /* ============== Send flow & events ============== */
    function sendMessage(){
      if (BUSY) return;
      const text = (box.value || '').trim();
      if (!text) return;

      BUSY = true;
      addUser(text);
      box.value = '';
      statusEl.textContent = 'ü§ñ Thinking‚Ä¶';
      typingOn();

      setTimeout(()=>{
        typingOff();
        const {html, chips} = route(text);
        addBot(html, chips);
        statusEl.textContent = '‚úÖ Answered!';
        setTimeout(()=> statusEl.textContent = '‚ö†Ô∏è I can make mistakes ‚Äî please double-check important info!', 1300);
        BUSY = false;
        box.focus();
      }, 280);
    }

    sendBtn.addEventListener('click', sendMessage);
    box.addEventListener('keydown', e=>{ if (e.key === 'Enter'){ e.preventDefault(); sendMessage(); } });
    chat.addEventListener('click', e=>{
      const chip = e.target.closest('.chip'); if (!chip) return;
      box.value = chip.dataset.ask || chip.textContent;
      sendMessage();
    });
    document.getElementById('top-rail').addEventListener('click', e=>{
      const a = e.target.closest('a'); if (!a) return; /* open only */
    });

    /* Initial English greeting */
    setLang('en');
    addBot(`üëã Hello! I'm the TASK Assistant.<br>
            Ask me about <em>training</em>, <em>jobs</em>, <em>appointments</em>, <em>hours</em>,
            <em>directions</em>, or <em>transit</em>.<br><br>
            Quick links: <a href="https://bycell.co/ddmtn" target="_blank" rel="noopener">Training</a> ‚Ä¢
            <a href="https://bycell.co/ddmtq" target="_blank" rel="noopener">Jobs</a> ‚Ä¢
            <a href="https://bycell.co/ddmtr" target="_blank" rel="noopener">Alerts</a>`,
            [{label:'Address', ask:'address'}, {label:'Make Appointment', ask:'appointment'}, {label:'Bus to TASK', ask:'bus'}]);
  </script>
</body>
</html>
