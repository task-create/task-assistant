<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Employment Assistant</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet"/>
<meta name="theme-color" content="#FFFFFF">
<script src="https://unpkg.com/tone"></script>
<style>
/* =================== BRAND GUIDELINES & COLORS =================== */
:root{
  --radius: 20px;
  --bg: #0a0f1a;
  --surface: #111929;
  --surface-2: #0e1625;
  --text: #eaf2ff;
  --muted: #a7bad5;
  --brand: #FF911F; /* TASK Logo Orange (New) */
  --accent: #145078; /* TASK Logo Blue (New) */
  --border: #344b6b;
  --link: #ff8a6b;
  --shadow: 0 20px 40px rgba(0,0,0,.6);
  --shadow-soft: 0 8px 20px rgba(0,0,0,.45);
  --header-bg: rgba(17, 25, 41, 0.7);
  --header-border: #344b6b;
  --bubble-bot-bg: #1e293b;
  --bubble-bot-text: #eaf2ff;
  --bubble-user-bg: var(--brand);
  --bubble-user-text: #fff;
  --typing: #aab4c3;
  --error: #bc2f32; /* Red for errors (Required Red) */
  --success: #13a10e;
  --base-font-size: 17px; 
}
/* LIGHT MODE */
[data-theme="light"]{
  --bg: #f4f7fa;
  --surface: #ffffff;
  --surface-2: #f7fbff;
  --text: #0a121e;
  --muted: #5a6b82;
  --border: #e2e8f0;
  --link: var(--brand);
  --shadow: 0 20px 40px rgba(30, 50, 80, .1);
  --shadow-soft: 0 8px 20px rgba(30, 50, 80, .08);
  --header-bg: rgba(255, 255, 255, 0.7);
  --header-border: #d9e2ec;
  --bubble-bot-bg: #e9eef3;
  --bubble-bot-text: #111827;
  --bubble-user-bg: var(--brand);
  --bubble-user-text: #fff;
  --typing: #aab4c3;
  --legal-bg: #e9eef3; 
  --legal-text: #5a6b82;
}
/* =================== BASE STYLES =================== */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:"Open Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg); color:var(--text); display:flex; align-items:center; justify-content:center;
  font-size:clamp(16px, 1.7vw, 18px); 
  min-height:100vh;
}
a{color:var(--link);text-decoration:none;font-weight:600} a:hover{text-decoration:underline}

/* Main App Container */
.main-container{
  width:100%; max-width:600px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
  overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; height:100vh; position:relative;
}
@media (min-width: 600px) {
  .main-container {
      height: 95vh;
  }
}

/* Header */
.header{
  position: sticky; top: 0; left: 0; right: 0; z-index: 100;
  background: var(--header-bg);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  border-bottom:1px solid var(--header-border); 
  padding:10px 15px; text-align:center;
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.header-title {
  font:800 1.2em/1 "Nunito", sans-serif; 
  color: var(--accent);
}
.icon-btn {
  width:38px; height:38px; border:none; border-radius:50%; background:transparent;
  color:var(--accent); cursor:pointer; transition:all .2s ease; font-size: 20px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.icon-btn:hover { color: var(--brand); background: rgba(0,0,0,0.05); }
.icon-btn:active { transform: scale(.95); }
.reset{margin-left: 0;}

/* Settings Menu */
.settings-menu{position:absolute;top:50px;right:10px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-soft);display:none;min-width:180px;z-index:200}
.settings-menu[aria-hidden="false"]{display:block}
.settings-menu button{display:flex; gap: 8px; align-items: center; width:100%;text-align:left;padding:10px 12px;background:transparent;border:none;cursor:pointer; color: var(--text);}
.settings-menu button:hover{background:var(--surface-2)}

/* Chat Area */
.chat{
  flex:1; overflow-y:auto; overflow-x:hidden; padding:20px; 
  padding-bottom: 120px; /* Space for the fixed input bar */
  background: var(--surface-2);
  min-height: 400px; 
}
.bubble-wrapper { 
  display: flex; align-items: flex-start; gap: 10px; 
  margin: 16px 0; max-width: 95%; 
  animation: pop-in .3s ease-out; 
  padding: 0 5px; 
}
.bot-bubble-wrapper { margin-right: 18%; }
.user-bubble-wrapper { margin-left: auto; flex-direction: row-reverse; display: flex; align-items: flex-start; }

.avatar { 
  width: 32px; height: 32px; border-radius: 50%; background:var(--accent); 
  color: white; font-family: "Nunito", sans-serif; font-weight: 700; font-size: 14px; 
  flex-shrink: 0;
}

.bubble{
  padding: 14px 18px; border-radius: 20px; line-height: 1.6;
  box-shadow: var(--shadow-soft); 
  transition: box-shadow .15s ease, transform .08s ease;
  font-size: 0.95em;
  padding-top: 10px; 
}
.bubble.bot{
  background:var(--bubble-bot-bg); color: var(--bubble-bot-text); 
  border:1px solid var(--border); 
  border-radius: 20px 20px 20px 6px;
  max-width: 100%;
}
.bubble.user{
  color:var(--bubble-user-text); background:var(--bubble-user-bg); 
  border-radius:20px 20px 6px 20px; 
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  max-width: 100%;
}
.bubble.bot ul, .bubble.bot ol {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  padding-left: 20px;
  list-style: disc;
}
.bubble.bot li { margin-bottom: 0.25em; }
@keyframes pop-in { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

/* Quick Start Buttons */
.suggestions-container {
  display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 10px 0;
}
.suggestion-btn {
  border: 2px solid var(--brand); background: var(--brand); color: white; 
  border-radius: 999px; padding: 12px 18px; font-weight: 700; cursor: pointer; 
  transition: all .2s ease; font-size: 0.9em; flex-shrink: 0;
  box-shadow: var(--shadow-soft);
}
.suggestion-btn:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 6px 12px rgba(0,0,0,0.15); 
  background: var(--accent); 
  border-color: var(--accent);
}
.suggestion-btn:active {transform: scale(.95)}
.suggestion-btn:focus-visible { outline: 3px solid var(--accent); outline-offset: 2px; }
.suggestion-btn.clicked {
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  transform: scale(0.98);
}


/* Loading and Status */
.typing{display:inline-flex;gap:6px;align-items:flex-end}
.typing .dot{width:6px;height:6px;border-radius:50%;background:var(--typing);animation:bounce 1s infinite ease-in-out}
.typing .dot:nth-child(2){animation-delay:.12s}.typing .dot:nth-child(3){animation-delay:.24s}

/* Footer and Input */
.input-area{position:relative;bottom:0;left:0;right:0;padding:12px;background:var(--surface-2);border-top:1px solid var(--border);z-index:100}
.row{display:flex;gap:10px;align-items:center}
#box{flex:1;padding:14px 18px;border:2px solid var(--border);border-radius:999px;font-size:1em;background:var(--surface);color:var(--text);caret-color:var(--accent); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);}
#box:disabled { background: var(--surface-2); cursor: not-allowed; }

.send{width:50px;height:50px;border-radius:50%;background:var(--brand);color:white;box-shadow:var(--shadow-soft);transition:transform .1s ease, background .1s ease;}
.send:hover { background: var(--accent); }
.send:active{transform:scale(.95)}
.send:disabled { background: var(--muted); cursor: not allowed; }
.send-icon { transition: transform 0.2s ease; }
.send:disabled .send-icon { transform: scale(0.8) rotate(360deg); }

/* Status Bar & Error Display */
.status{margin-top:6px;text-align:center;font-size:0.75em;color:var(--muted)}
.error-status { 
    color: var(--error); 
    font-weight: 600; 
    padding: 8px 12px;
    margin-top: 0;
    border-top: 1px solid var(--border);
    background: var(--surface);
    display: block;
}
.error-status strong { color: var(--error); margin-right: 5px; }

/* Disclaimer Bar */
.legal-disclaimer {
    background: var(--accent);
    color: white;
    padding: 6px 10px;
    font-size: 0.7em;
    text-align: center;
    line-height: 1.3;
    z-index: 101;
}

/* Call/Text Buttons */
.contact-buttons { display: flex; gap: 8px; margin-top: 10px; }
.contact-buttons a {
    padding: 8px 12px; border-radius: 999px; font-weight: 700; transition: all 0.15s ease;
    text-decoration: none; display: flex; align-items: center; gap: 5px;
}
.contact-buttons .call-btn {
    background: var(--success);
    color: white;
    border: 1px solid var(--success);
}
.contact-buttons .text-btn {
    background: var(--surface);
    color: var(--accent);
    border: 1px solid var(--accent);
}
.contact-buttons a:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-decoration: none;
}
.contact-buttons .text-btn:hover {
    background: var(--accent);
    color: white;
}
/* Card Styles */
.card-base {
    background: var(--surface); 
    border: 1px solid var(--border); 
    border-radius: 12px;
    padding: 16px; 
    box-shadow: var(--shadow-soft); 
    margin-top: 10px; 
    margin-bottom: 8px;
}
.card-base h3 { 
    font-family: "Nunito", sans-serif; 
    font-size: 1.1em; 
    color: var(--accent); 
    margin-bottom: 8px; 
}
.card-base p { margin-bottom: 12px; line-height: 1.5; }
.card-base .ctrl { background: var(--surface-2); }
.job-card strong { display: block; font-family: "Nunito", sans-serif; }
.job-card span { color: var(--muted); font-size: 0.85em; }

/* =================== SPLASH SCREEN =================== */
#splash-screen {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--accent); /* TASK Blue */
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    transition: opacity 0.5s ease;
    font-family: "Nunito", sans-serif;
    text-align: center;
}
.splash-content {
    animation: fadeIn 1.5s ease forwards;
    opacity: 0;
    max-width: 80%;
}
.splash-logo {
    width: 250px;
    height: auto;
    margin: 0 auto 30px; /* Centering fix */
    background: white;
    padding: 10px;
    border-radius: 10px;
    display: block; /* Ensures centering works */
}
.splash-logo img {
    width: 100%;
    height: auto;
    display: block;
}
.splash-text h1 {
    font-size: clamp(1.8em, 5vw, 3em);
    margin-bottom: 10px;
}
.splash-text p {
    font-size: clamp(1em, 3vw, 1.3em);
    margin-bottom: 40px;
    line-height: 1.4;
}
.splash-button {
    background: var(--brand); /* TASK Orange */
    color: white;
    border: 2px solid white;
    padding: 15px 30px;
    border-radius: 999px;
    font-size: 1.2em;
    font-weight: 800;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.1s ease;
}
.splash-button:hover {
    background: #e0801a; 
    transform: scale(1.05);
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
/* =================== ADVANCED TOOLS OVERLAY (NEW) =================== */
.tools-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
}
.tools-panel {
    background: var(--surface);
    width: 95%;
    max-width: 500px;
    height: 95vh;
    max-height: 800px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    color: var(--text);
}
.tools-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}
.tools-header h2 {
    font-size: 1.2em;
    color: var(--accent);
    font-family: "Nunito", sans-serif;
}
.tools-tabs {
    display: flex;
    overflow-x: auto;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}
.tools-tabs button {
    padding: 10px 15px;
    white-space: nowrap;
    border: none;
    background: transparent;
    color: var(--muted);
    font-weight: 600;
    cursor: pointer;
    transition: color 0.1s;
    font-size: 0.85em;
}
.tools-tabs button.active {
    border-bottom: 2px solid var(--brand);
    color: var(--brand);
}
.tools-body {
    padding: 15px;
    overflow-y: auto;
    flex-grow: 1;
}
.tool-content h3 {
    font-size: 1.1em;
    color: var(--accent);
    margin-bottom: 10px;
    font-family: "Nunito", sans-serif;
}
.tool-content textarea {
    width: 100%;
    min-height: 100px;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 10px;
    resize: vertical;
    font-size: 1em;
    background: var(--surface-2);
    color: var(--text);
}
.tool-content input[type="text"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 10px;
    font-size: 1em;
    background: var(--surface-2);
    color: var(--text);
}
.tool-content button {
    background: var(--brand);
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 999px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 15px;
}
.tool-output {
    min-height: 150px;
    border: 1px dashed var(--muted);
    padding: 10px;
    border-radius: 6px;
    background: var(--surface-2);
    white-space: pre-wrap;
    text-align: left;
    font-size: 0.95em;
}

</style>
</head>
<body>

<div id="splash-screen">
    <div class="splash-content">
        <div class="splash-logo">
            <img src="https://placehold.co/500x125/FFFFFF/145078?text=TASK+Logo" alt="TASK Logo">
        </div>
        <div class="splash-text">
            <h1>Welcome to the Employment Assistant</h1>
            <p>Your guide to jobs, training, and resources in the Greater Trenton Area.</p>
        </div>
        <button class="splash-button" onclick="startApp()">Start Chatting</button>
    </div>
</div>

<div class="main-container" id="app-container" style="display: none;">
    <header class="header">
        <button class="icon-btn" id="resetBtn" aria-label="Clear chat">↺</button>
        <div class="header-title">Employment Assistant</div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle" aria-label="Toggle Theme">🌗</button>
            <button class="icon-btn" id="magicBtn" aria-label="Advanced Tools">✨</button>
        </div>
    </header>

    <section class="chat" id="chat" role="log" aria-live="polite" aria-relevant="additions" aria-label="Chat transcript"></section>

    <div class="input-area">
        <div class="row">
            <input id="box" type="text" placeholder="Ask me anything..." autocomplete="off"/>
            <button class="send" id="send" aria-label="Send">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="send-icon">
                    <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                </svg>
            </button>
        </div>
        <div class="status" id="status-bar">⚠️ I can make mistakes — please double-check important info.</div>
    </div>
    <div class="legal-disclaimer">
        Disclaimer: This assistant is for informational purposes only and is not legal, financial, or employment advice.
    </div>
</main>
</div>
<div class="tools-overlay" id="tools-overlay">
    <div class="tools-panel">
        <div class="tools-header">
            <h2>Advanced Job Search Tools</h2>
            <button class="icon-btn" onclick="closeToolsOverlay()">✕</button>
        </div>
        <div class="tools-tabs" id="tools-tabs">
            </div>
        <div class="tools-body" id="tools-body">
            </div>
    </div>
</div>

<script>
/* ================== SCRIPT START ================== */
'use strict';

/* ================== CONFIGURATION & STATE ================== */
const CONFIG = {
    // --- API Key (Inserted from user input) ---
    API_KEY: "AIzaSyBGCzk-xHAi4uZITtxGbsw_2uhK0asMhO8",
    API_URL_BASE: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=",
    
    // --- Contact & Resource Links (Centralized) ---
    APPOINTMENT_NUMBER: '6093371624',
    DIANI_NUMBER: '6096976166',
    SEAN_NUMBER: '6096976215',
    TASK_ADDRESS: '72 1/2 Escher Street, Trenton, NJ 08609',
    TASK_WEBSITE: 'https://www.trentonsoupkitchen.org',
    TRAINING_APPLY_LINK: 'https://bycell.mobi/wap/default/item.jsp?entryid=ECNDE0Mg==&itemid=170659',
    SORA_LINK: 'https://www.njsp.org/private-detective/sora.shtml',
    CAREER_TIPS_LINK: 'https://bycell.co/ddmnx',
    NJ_TRANSIT_TRIP_PLANNER: 'https://www.njtransit.com/trip-planner',
    GOOGLE_MAPS_BASE: 'https://www.google.com/maps/search/?api=1&query=$',

    MAX_RETRIES: 3,

    // --- Advanced Tools Configuration (23 Tools) ---
    ADVANCED_TOOLS: [
        { id: 'simplify', title: 'Job Simplifier', inputs: [{ id: 'jargon', label: 'Paste Job Jargon/Text Here', type: 'textarea' }, { id: 'job_type', label: 'Target Job (e.g., Warehouse, Retail)', type: 'text' }] },
        { id: 'resume_keywords', title: 'Keyword Checker', inputs: [{ id: 'resume_text', label: 'Paste your resume text', type: 'textarea' }, { id: 'job_type', label: 'Target Job (e.g., Warehouse, Retail)', type: 'text' }] },
        { id: 'interview_prep', title: 'Interview Coach', inputs: [{ id: 'job_desc', label: 'Paste Job Description', type: 'textarea' }] },
        { id: 'cover_letter', title: 'Cover Letter Drafter', inputs: [{ id: 'job_title', label: 'Job Title You Are Applying For', type: 'text' }] },
        { id: 'doc_explainer', title: 'Document Explainer', inputs: [{ id: 'doc_text', label: 'Paste document text (Pay Stub, Form, etc.)', type: 'textarea' }] },
        { id: 'follow_up_email', title: 'Follow-up Email Drafter', inputs: [{ id: 'context', label: 'Interview Context (e.g., "Interviewed with John for warehouse job yesterday")', type: 'textarea' }] },
        { id: 'negotiation_planner', title: 'Negotiation Planner', inputs: [{ id: 'job_title_neg', label: 'Job Title', type: 'text' }, { id: 'pay_rate', label: 'Expected Pay Rate (e.g., $18/hr)', type: 'text' }] },
        { id: 'financial_goals', title: 'Financial Goal Planner', inputs: [{ id: 'job_type_pay', label: 'Job/Pay Rate (e.g., $17/hr warehouse job)', type: 'text' }] },
        { id: 'resource_finder', title: 'Local Resource Finder', inputs: [{ id: 'query', label: 'Resource Needed (e.g., Food assistance, shelter, utility help)', type: 'text' }] },
        { id: 'search_strategy', title: 'Search Strategy Planner', inputs: [{ id: 'tasks', label: 'Current To-Do List (e.g., Write resume, check email)', type: 'textarea' }] },
        { id: 'balance_check', title: 'Emotional Support Check-In', inputs: [{ id: 'stress_level', label: 'Describe your stress level and search intensity', type: 'textarea' }] },
        { id: 'scam_checker', title: 'Scam and Fraud Checker', inputs: [{ id: 'suspicious_text', label: 'Paste suspicious email/text/post here', type: 'textarea' }] },
        { id: 'form_assistant', title: 'Digital Form Assistant', inputs: [{ id: 'form_question', label: 'Paste Confusing Form Question', type: 'textarea' }] },
        { id: 'career_path', title: 'Career Path Finder', inputs: [{ id: 'interests', label: 'Interests/Skills (e.g., driving, working with hands)', type: 'textarea' }] },
        { id: 'task_prioritizer', title: 'Search Task Prioritizer', inputs: [{ id: 'daily_tasks', label: 'Paste all tasks you need to do today', type: 'textarea' }] },
        { id: 'workplace_rights', title: 'Workplace Rights Explainer', inputs: [{ id: 'rights_term', label: 'Confusing Term (e.g., FMLA, Deductible, PTO)', type: 'text' }] },
        { id: 'skill_translator', title: 'Food Service Skill Translator', inputs: [{ id: 'kitchen_task', label: 'Describe a task you did (e.g., "I wash dishes fast")', type: 'textarea' }] },
        { id: 'digital_coach', title: 'Basic Digital Skill Coach', inputs: [{ id: 'digital_task', label: 'Digital Task (e.g., attach file to email, join Zoom)', type: 'text' }] },
        { id: 'benefits_explainer', title: 'Benefits Explainer', inputs: [{ id: 'benefits_term', label: 'Confusing Benefit (e.g., 401k, Deductible, HSA)', type: 'text' }] },
        { id: 'resume_score', title: 'Resume Feedback & Scoring', inputs: [{ id: 'resume_draft', label: 'Paste your current resume draft', type: 'textarea' }] },
        { id: 'skill_gap', title: 'Skill Gap Analyzer', inputs: [{ id: 'job_goal', label: 'Desired Job Title', type: 'text' }, { id: 'known_skill', label: 'A skill you already have', type: 'text' }] },
        { id: 'app_troubleshooter', title: 'App Troubleshooter', inputs: [{ id: 'app_name', label: 'App Name (e.g., Indeed, LinkedIn)', type: 'text' }, { id: 'error_msg', label: 'Error Message/Problem', type: 'textarea' }] },
        { id: 'public_route', title: 'Public Transit Route Planner', inputs: [{ id: 'start_address', label: 'Starting Address', type: 'text' }, { id: 'destination', label: 'Destination Address', type: 'text' }] },
    ]
};

const API_URL = CONFIG.API_URL_BASE + CONFIG.API_KEY;

let lang = 'en';
let chatHistory = [];
const ce = id => document.getElementById(id);
const chat = ce('chat');
const box = ce('box');
const sendBtn = ce('send');
const sendIcon = ce('send-icon');
const statusDiv = ce('status-bar');

const settingsBtn = ce('settingsBtn');
const micBtn = document.createElement('button'); // Mic button needs to be created dynamically
micBtn.id = 'micBtn';
micBtn.innerHTML = '🎙️';
micBtn.className = 'icon-btn';
micBtn.style.display = 'none';

/* ================== UI STRINGS (Multilingual) ================== */
const UI = {
  en:{
      welcome:'👋 Hi there! How can I help you today?', 
      hello:'Hi! 👋 How can I help today?', 
      thanks:"You're welcome! 😊 Is there anything else?", 
      bye:`Take care! If you need to schedule, call (${CONFIG.APPOINTMENT_NUMBER.substring(0, 3)}) ${CONFIG.APPOINTMENT_NUMBER.substring(3, 6)}-${CONFIG.APPOINTMENT_NUMBER.substring(6)}.`, 
      noWalk:'We do <strong>not</strong> take walk-ins. Please call to schedule. Same-day may be possible if you call first.', 
      frust:'I understand this can be frustrating, and I\'m sorry you\'re having trouble. Let\'s try something else. Here are our main phone numbers for direct help:',
      prompts: [
          { text: "Find Jobs", query: "I need to search for jobs" },
          { text: "Get Training Info", query: "How do I apply for job training?" }
      ]
  },
  es:{
      welcome:'👋 ¡Hola! ¿En qué te puedo ayudar hoy?', 
      hello:'¡Hola! 👋 ¿En qué te puedo ayudar hoy?', 
      thanks:'¡Con gusto! 😊 ¿Algo más?',
      bye:`¡Cuídate! Si necesitas una cita, llama al (${CONFIG.APPOINTMENT_NUMBER.substring(0, 3)}) ${CONFIG.APPOINTMENT_NUMBER.substring(3, 6)}-${CONFIG.APPOINTMENT_NUMBER.substring(6)}.`, 
      noWalk:'No atendemos <strong>sin cita</strong>. Por favor llama para programar.', 
      frust:'Entiendo que esto puede ser frustrante y lamento que tengas problemas. Probemos otra cosa. Aquí están nuestros números de teléfono principales para obtener ayuda directa:',
      prompts: [
          { text: "Buscar Empleos", query: "Necesito buscar empleos" },
          { text: "Obtener Información de Capacitación", query: "¿Cómo solicito capacitación laboral?" }
      ]
  },
  ht:{
      welcome:'👋 Bonjou! Kijan mwen ka ede w jodi a?', 
      hello:'Bonjou! 👋 Kijan mwen ka ede w jodi a?', 
      thanks:'Avèk plezi! 😊 Gen lòt bagay?',
      bye:`Si ou bezwen randevou, rele (${CONFIG.APPOINTMENT_NUMBER.substring(0, 3)}) ${CONFIG.APPOINTMENT_NUMBER.substring(3, 6)}-${CONFIG.APPOINTMENT_NUMBER.substring(6)}.`, 
      noWalk:'Nou pa pran <strong>san randevou</strong>. Tanpri rele pou pran randevou.', 
      frust:'Mwen konprann sa ka fwistre, e mwen regrèt ou gen pwoblèm. Ann eseye yon lòt bagay. Men nimewo telefòn prensipal nou yo pou jwenn èd dirèk:',
      prompts: [
          { text: "Jwenn Travay", query: "Mwen bezwen chèche travay" },
          { text: "Jwenn Enfòmasyon sou Fòmasyon", query: "Kijan pou mwen aplike pou fòmasyon travay?" }
      ]
  }
};

/* ================== SOUND & HAPTICS ================== */
let synth;
try {
  synth = new Tone.PolySynth(Tone.Synth, {
    oscillator: { type: "marimba" }, 
    envelope: { attack: 0.01, decay: 0.6, sustain: 0.1, release: 0.8 }, 
  }).toDestination();
} catch (e) { console.warn("Tone.js failed to initialize."); synth = null; }

function playSound(type) {
  if (synth && Tone.context.state !== 'running') { Tone.start(); }
  if (synth) {
    try { 
      if (type === 'send') synth.triggerAttackRelease("G4", "8n", Tone.now());
      if (type === 'receive') synth.triggerAttackRelease(["C5", "E5", "G5"], "8n", Tone.now()); 
    } catch(e) {}
  }
}
function vibrate(style = 'light') {
  if (window.navigator?.vibrate) {
    try { 
      if (style === 'light') navigator.vibrate(10);
      if (style === 'medium') navigator.vibrate([30, 50, 30]);
    } catch(e) {}
  }
}

/* ================== UTILITY FUNCTIONS ================== */

const isNearBottom = () => (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 80;
function safeScroll() { if (isNearBottom()) requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight ); }

/** Toggles loading/interaction state for the input box and send button. */
function setLoadingState(isLoading) {
    box.disabled = isLoading;
    sendBtn.disabled = isLoading;
    ce('magicBtn').disabled = isLoading;
    ce('resetBtn').disabled = isLoading;
    // Show checkmark briefly on successful send
    if (isLoading) {
        sendBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="send-icon"><path d="M10.75 16.75l-4.5-4.5 1.06-1.06 3.44 3.44 6.94-6.94 1.06 1.06-8 8z" /></svg>`;
    } else {
        sendBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="send-icon"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>`;
    }
}

/** Updates the status bar with an optional error message and contact info. */
function setErrorStatus(message) {
    if (message) {
        // Formatted contact info using the configured numbers
        const contactInfo = `
            <div style="margin-top: 8px;">
                <p style="margin: 0; padding-bottom: 4px;">
                    **Need immediate help?** Call one of our staff directly:
                </p>
                <ul style="list-style-type: none; padding: 0; margin: 0;">
                    <li style="display:inline-block; margin-right: 12px;"><a href="tel:${CONFIG.DIANI_NUMBER}">📞 Diani: ${CONFIG.DIANI_NUMBER.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3')}</a></li>
                    <li style="display:inline-block;"><a href="tel:${CONFIG.SEAN_NUMBER}">📞 Sean: ${CONFIG.SEAN_NUMBER.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3')}</a></li>
                </ul>
            </div>
        `;
        // Use softer error messaging
        statusDiv.innerHTML = `
            <span style="font-weight: 700;">
                🚨 We're having trouble connecting to our resources right now.
            </span> 
            ${contactInfo}
        `;
        statusDiv.classList.add('error-status');
    } else {
        statusDiv.innerHTML = '⚠️ I can make mistakes — please double-check important info.';
        statusDiv.classList.remove('error-status');
    }
}

function setLang(l, persist = true) { 
    lang = (['en', 'es', 'ht'].includes(l) ? l : 'en'); 
    if (persist) { try { localStorage.setItem('task_lang', lang); } catch(e) {} } 
}

/** Function to handle Quick Query button clicks */
function sendQuickQuery(event) {
    vibrate('light');
    const query = event.currentTarget.getAttribute('data-query'); 
    if (!query) return;

    event.currentTarget.classList.add('clicked');
    setTimeout(() => { event.currentTarget.classList.remove('clicked'); }, 400);

    box.value = query;
    send(); 
}

window.callPhone = (number) => { window.location.href = `tel:${number}`; vibrate('light'); };
window.textPhone = (number) => { window.location.href = `sms:${number}`; vibrate('light'); };

// --- Error Reporting Function ---
async function sendErrorReport(userPrompt, errorMessage) {
    const FORM_URL = CONFIG.MS_FORM_URL; 
    const USER_PROMPT_FIELD = CONFIG.USER_PROMPT_FIELD; 
    const ERROR_DETAILS_FIELD = CONFIG.ERROR_DETAILS_FIELD; 

    if (FORM_URL.includes('YOUR_MICROSOFT_FORM_SUBMISSION_URL_HERE')) {
        console.warn("Error Reporting Disabled: Please configure Microsoft Form URL/IDs.");
        return;
    }

    const formData = new FormData();
    formData.append(USER_PROMPT_FIELD, userPrompt);
    formData.append(ERROR_DETAILS_FIELD, errorMessage + " | Time: " + new Date().toISOString());

    try {
        await fetch(FORM_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors' // Use no-cors for silent submissions to external forms
        });
        console.log("Error report sent successfully (via Microsoft Form).");
    } catch (error) {
        console.error("Failed to send silent error report:", error);
    }
}

/* ================== RENDER FUNCTIONS ================== */
function addU(t){ 
    const e = document.createElement('div'); 
    e.className = 'bubble-wrapper user-bubble-wrapper'; 
    e.innerHTML = `<div class="bubble user">${t}</div>`; 
    chat.appendChild(e); 
    safeScroll(); 
    playSound('send'); 
    vibrate('light'); 
}

function addB(html){
    const sanitizedHTML = DOMPurify.sanitize(html);
    const wrapper = document.createElement('div');
    wrapper.className = 'bubble-wrapper bot-bubble-wrapper';
    const avatar = `<div class="avatar" aria-hidden="true">E</div>`;
    const bubble = `<div class="bubble bot">${sanitizedHTML}</div>`;
    wrapper.innerHTML = avatar + bubble;
    chat.appendChild(wrapper);
    safeScroll();
    playSound('receive');
    vibrate('light');
}

function typing(on){
    const id = 'typing';
    if(on){
        const wrapper = document.createElement('div');
        wrapper.id = id;
        wrapper.className = 'bubble-wrapper bot-bubble-wrapper';
        const avatar = `<div class="avatar" aria-hidden="true">E</div>`;
        const bubble = `<div class="bubble bot"><div class="typing" aria-hidden="true"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div></div>`;
        wrapper.innerHTML = avatar + bubble;
        chat.appendChild(wrapper);
    } else { ce(id)?.remove(); }
    safeScroll();
}

/** Clears old prompts and adds new quick-start buttons below the welcome message. */
function showQuickStartPrompts() {
    const promptsHTML = UI[lang].prompts.map(p => 
        `<button class="suggestion-btn" data-query="${p.query}">
            ${p.query.includes("Jobs") ? '💼' : '🎓'} ${p.text}
        </button>`
    ).join('');

    const promptsWrapper = document.createElement('div');
    promptsWrapper.className = 'suggestions-container';
    promptsWrapper.innerHTML = promptsHTML;
    chat.appendChild(promptsWrapper);
    
    promptsWrapper.querySelectorAll('.suggestion-btn').forEach(btn => {
        btn.addEventListener('click', sendQuickQuery);
    });
    safeScroll();
}

function renderGoogleMapsCard(address) {
    const mapUrl = `${CONFIG.GOOGLE_MAPS_BASE}${encodeURIComponent(address)}`;
    const html = `
        <div class="card-base">
            <h3>TASK Location & Map</h3>
            <p><strong>${address}</strong></p>
            <div class="controls">
                <a href="${mapUrl}" target="_blank" rel="noopener" class="ctrl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/><circle cx="12" cy="10" r="3"/></svg>
                    Open Google Maps
                </a>
            </div>
        </div>`;
    addB(html);
}

/* ================== AI CORE (GEMINI) - WITH BACKOFF ================== */
async function exponentialBackoffFetch(url, options, retries = 0) {
    try {
        const response = await fetch(url, options);
        if (response.status === 429 || response.status >= 500) {
            if (retries < MAX_RETRIES) {
                const delay = Math.pow(2, retries) * 1000 + (Math.random() * 1000);
                await new Promise(resolve => setTimeout(resolve, delay));
                console.warn(`API retry ${retries + 1} after ${delay}ms: Status ${response.status}`);
                return exponentialBackoffFetch(url, options, retries + 1);
            }
            throw new Error(`API error after ${MAX_RETRIES} attempts: ${response.statusText || response.status}`);
        }
        if (!response.ok) {
            const errorText = await response.text();
             throw new Error(`Non-retryable API error: ${response.status} ${response.statusText || errorText}`);
        }
        return response.json();
    } catch (error) {
        console.error("Fetch attempt failed:", error.message);
        throw error;
    }
}

const systemPrompt = (currentLang) => `
    You are the Employment Assistant for the Trenton Area Soup Kitchen (TASK). 
    Your persona is friendly, empathetic, and extremely helpful. Your primary goal is to provide clear, actionable, and safe information related to employment services.
    
    The user's current language is ${currentLang}. **You MUST respond in this language.**

    ***MANDATORY RULES & ACTIONS***
    1.  **Format for Clarity:** When presenting lists, multiple steps, or diverse information, **you MUST use Markdown bullet points (* ) or numbered lists.** AVOID large, blocky paragraphs.
    2.  **Safety First:** If discussing jobs or applications, always reinforce the need for caution against scams and identity theft. Advise applying directly on the official employer website whenever possible.
    3.  **Hyperlinking:** Automatically convert the following official information into markdown links in your response. DO NOT add "Call" or "Text" buttons; the front-end handles that separately.
        * **Appointment Line**: ${CONFIG.APPOINTMENT_NUMBER} (Link to tel:${CONFIG.APPOINTMENT_NUMBER})
        * **Diani's Number**: ${CONFIG.DIANI_NUMBER} (Link to tel:${CONFIG.DIANI_NUMBER})
        * **Sean's Number**: ${CONFIG.SEAN_NUMBER} (Link to tel:${CONFIG.SEAN_NUMBER})
        * **Appointments/Scheduling**: Link to ${CONFIG.TASK_WEBSITE} or mention the phone number.
        * **Training Application**: Link to [Application](${CONFIG.TRAINING_APPLY_LINK})
        * **TASK Website**: Link to [TASK Website](${CONFIG.TASK_WEBSITE})
        * **SORA License**: Link to [Official NJ Site](${CONFIG.SORA_LINK})
    4.  **Handle Jobs:** If the user asks for "jobs" or "openings," ask for the job type (warehouse, retail, food service, specific company) first. Once they specify a type, respond **ONLY** with the tag: [SEARCH_JOBS: job_type_or_company].
    5.  **Handle Location:** If the user asks for "address" or "location," respond **ONLY** with the tag: [TASK_ADDRESS].
    6.  **Be Empathetic:** If the user expresses frustration, respond with empathy before providing resources.

    ***YOUR KNOWLEDGE BASE***
    - **Appointments**: To make an appointment, call **${CONFIG.APPOINTMENT_NUMBER}**. We do NOT take walk-ins.
    - **TASK Address**: **${CONFIG.TASK_ADDRESS}**
    - **Sean (Training Contact)**: **${CONFIG.SEAN_NUMBER}**
    - **Diani (Appointment Contact)**: **${CONFIG.DIANI_NUMBER}**
`;

async function getAiResponse(prompt) {
    const currentContents = [...chatHistory, { role: "user", parts: [{ text: prompt }] }];
    let finalResponseText = '';
    
    try {
        const payload = {
            contents: currentContents,
            systemInstruction: { parts: [{ text: systemPrompt(lang) }] },
            tools: [{ "google_search": {} }]
        };

        const result = await exponentialBackoffFetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        finalResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || UI[lang].errorSoft;
        
        chatHistory.push({ role: "model", parts: [{ text: finalResponseText }] });
        setErrorStatus(null); 
        return finalResponseText;

    } catch (error) {
        console.error("Gemini API call failed:", error);
        
        const hardErrorMsg = UI[lang].errorHard;
        const diagnosticMsg = `Prompt: "${prompt}" | Error: ${error.message}`;
        sendErrorReport(prompt, diagnosticMsg);
        
        finalResponseText = hardErrorMsg;
        setErrorStatus(finalResponseText); 
        return finalResponseText;

    } finally {
        // NOTE: typing(false) and setLoadingState(false) are handled in handle(t)
    }
}

/* ================== FLOW CONTROL ================== */
/** Main function to handle user input and trigger AI response */
async function handle(t){
    if(!t) return;

    // 1. Instant User Feedback/Loading Signal
    addU(t); 
    setLoadingState(true);
    typing(true); 

    // 2. Auto-detect language 
    await detectAndSetLanguage(t); 

    // 3. Process main AI response
    const aiResponse = await getAiResponse(t);

    if (aiResponse.startsWith('[SEARCH_JOBS:')) {
        const jobMatch = aiResponse.match(/\[SEARCH_JOBS:\s*(.+)\]/);
        if (jobMatch && jobMatch[1]) {
            await getJobs(jobMatch[1]);
        } else {
            addB(UI[lang].errorSoft);
        }
    } else if (aiResponse.startsWith('[TASK_ADDRESS]')) {
        renderGoogleMapsCard(CONFIG.TASK_ADDRESS);
        
    } else {
        // Apply hyperlinking and rendering
        const formattedResponse = applyHyperlinks(aiResponse);
        addB(formattedResponse);
    }
    
    // 4. Reset UI after all rendering is complete
    typing(false); 
    setLoadingState(false);
}

function applyHyperlinks(text) {
    let result = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
        if (url.startsWith('tel:')) { return `<a href="${url}" class="font-bold">${linkText}</a>`; }
        return `<a href="${url}" target="_blank" rel="noopener">${linkText}</a>`;
    });

    // 2. Convert Markdown lists (needed for bullet point formatting)
    result = result.replace(/\* (.*)/g, '<li>$1</li>');
    if (result.includes('<li>')) {
        result = `<ul>${result}</ul>`;
    }

    // 3. Add hyperlinking for non-markdown instances of phone numbers and address
    // (A) Phone Numbers 
    const phoneRegex = /(\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4})/g;
    result = result.replace(phoneRegex, (match) => `<a href="tel:${match.replace(/[^0-9]/g, '')}" class="font-bold">${match}</a>`);
    
    // (B) Address 
    const addressRegex = new RegExp(CONFIG.TASK_ADDRESS.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
    result = result.replace(addressRegex, (match) => `<a href="${CONFIG.GOOGLE_MAPS_BASE}${encodeURIComponent(CONFIG.TASK_ADDRESS)}" target="_blank" rel="noopener">${match}</a>`);

    // (C) Appointment/Training mentions (contextual links)
    result = result.replace(/training\s+application/gi, (match) => `<a href="${CONFIG.TRAINING_APPLY_LINK}" target="_blank" rel="noopener">${match}</a>`);
    result = result.replace(/appointments?|scheduling/gi, (match) => `<a href="tel:${CONFIG.APPOINTMENT_NUMBER}" class="font-bold">${match}</a>`);
    result = result.replace(/SORA\s+License/gi, (match) => `<a href="${CONFIG.SORA_LINK}" target="_blank" rel="noopener">${match}</a>`);
    
    // 4. Add Call/Text buttons for staff phone numbers if mentioned
    if (result.includes(CONFIG.DIANI_NUMBER) || result.includes(CONFIG.SEAN_NUMBER)) {
        const staffButtons = `
            <div class="contact-buttons">
                <a href="tel:${CONFIG.DIANI_NUMBER}" class="call-btn">📞 Call Diani</a>
                <a href="sms:${CONFIG.DIANI_NUMBER}" class="text-btn">💬 Text Diani</a>
                <a href="tel:${CONFIG.SEAN_NUMBER}" class="call-btn">📞 Call Sean</a>
                <a href="sms:${CONFIG.SEAN_NUMBER}" class="text-btn">💬 Text Sean</a>
            </div>
        `;
        result = result.replace(/<\/ul>$/, '') + staffButtons + (result.endsWith('</ul>') ? '</ul>' : '');
    }

    return result;
}

async function getJobs(query) {
    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&ibp=htl;jobs`;
    
    let jobsHtml = `<p>Searching for the latest <strong>${query}</strong> jobs in Mercer County... Click the button below for the most up-to-date listings.</p>`;
    
    jobsHtml += `<div class="card-base job-card">
        <h3>Live Job Search Results</h3>
        <p><strong>Mercer County, NJ</strong></p>
        <div class="controls">
            <a href="${searchUrl}" target="_blank" rel="noopener" class="ctrl">
                ⚠️ View Live Openings Safely
            </a>
        </div>
    </div>`;
    addB(jobsHtml);
}

function send(){ 
    const t = (box.value||'').trim(); 
    if(!t) return; 
    handle(t); 
    box.value = ''; 
    box.blur(); 
    setTimeout(() => box.focus(), 100); 
}


/* ================== LANGUAGE DETECTION ================== */
async function detectAndSetLanguage(prompt) {
    const langDetectionPrompt = `Detect the language of the following user message and return the corresponding two-letter ISO 639-1 language code (en, es, or ht). Do not provide any other text. User message: "${prompt}"`;
    const targetLanguages = ['en', 'es', 'ht'];

    try {
        const payload = {
            contents: [{ parts: [{ text: langDetectionPrompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: { "language": { "type": "STRING", "description": "The two-letter ISO 639-1 code (en, es, or ht)." } },
                    propertyOrdering: ["language"]
                }
            },
            systemInstruction: { parts: [{ text: "You are a language detection expert. Output only the requested JSON object." }] },
        };

        const result = await exponentialBackoffFetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }, 0); 

        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        const parsedJson = JSON.parse(jsonText);
        const detectedLang = parsedJson.language.toLowerCase();
        
        if (targetLanguages.includes(detectedLang) && detectedLang !== lang) {
            setLang(detectedLang);
            console.log(`Language switched to: ${detectedLang}`);
        }
    } catch (e) {
        console.warn("Language detection failed, proceeding with current language.", e);
    }
}

/* ================== ADVANCED LLM TOOLS ================== */

// Tool 1: Job Description Simplifier
async function simplifyJobDescription(jargon, jobType) {
    const prompt = `Act as an Employment Coach. Simplify the following complex job jargon or job description for someone with low literacy. Keep the language direct, use simple words, and summarize the key duties using bullet points: "${jargon}" for a job titled "${jobType}".`;
    const response = await getAiResponse(prompt);
    return `<strong>Job Jargon Simplification:</strong><p>${response}</p>`;
}

// Tool 2: Resume Keyword Checker
async function checkResumeKeywords(resumeText, jobType) {
    const prompt = `Act as a Resume Analyst. Analyze the following resume skills section and suggest 3-5 keywords or phrases specific to a "${jobType}" job that the user should add or highlight. Resume Text: "${resumeText}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Resume Keyword Analysis for ${jobType}:</strong><p>${response}</p>`;
}

// Tool 3: Interview Prep Coach
async function generateInterviewQuestions(jobDesc) {
    const prompt = `Act as an Interview Coach. Based ONLY on the job description below, generate 3 clear, simple interview questions (2 behavioral, 1 technical) that a candidate with low literacy can easily understand and prepare for. Present them as a numbered list. Job Description: "${jobDesc}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Interview Questions:</strong><p>${response}</p>`;
}

// Tool 4: Cover Letter Drafter
async function draftCoverLetter(jobTitle) {
    const prompt = `Act as a professional writer. Draft a concise, 3-paragraph cover letter structure for a client applying for a "${jobTitle}" position. Use simple, direct language. The client will copy and fill in their name and details later.`;
    const response = await getAiResponse(prompt);
    return `<strong>Cover Letter Draft for ${jobTitle}:</strong><p>${response}</p>`;
}

// Tool 5: Document Explainer
async function explainDocument(docText) {
    const prompt = `Act as an Explainer. Analyze the following document text and provide a simple, 2-sentence summary of the document's purpose, and list the 3 most important actions the user must take. Document Text: "${docText}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Document Explanation:</strong><p>${response}</p>`;
}

// Tool 6: Follow-up Email Drafter
async function draftFollowUpEmail(context) {
    const prompt = `Act as a Communication Coach. Draft a short, professional thank-you email template based on the following context: "${context}". Use clear language and end with a call to action.`;
    const response = await getAiResponse(prompt);
    return `<strong>Follow-up Email Draft:</strong><p>${response}</p>`;
}

// Tool 7: Negotiation Planner
async function planNegotiation(jobTitle, payRate) {
    const prompt = `Act as a Financial Negotiator. Based on a job title of "${jobTitle}" and pay rate of "${payRate}", provide 3 simple, bulleted talking points for a client to use when discussing salary or asking for better benefits.`;
    const response = await getAiResponse(prompt);
    return `<strong>Negotiation Talking Points:</strong><p>${response}</p>`;
}

// Tool 8: Financial Goal Planner
async function planFinancialGoals(jobPay) {
    const prompt = `Act as a Financial Coach. Based on the income of "${jobPay}", create a simplified 4-category monthly budget framework (Housing, Food, Transport, Other). Then, list 3 clear, simple financial goals the client can achieve in 6 months.`;
    const response = await getAiResponse(prompt);
    return `<strong>Financial Plan:</strong><p>${response}</p>`;
}

// Tool 9: Local Resource Finder
async function findLocalResources(query) {
    const prompt = `Act as a Local Guide. Find and list 3 organizations in the Trenton/Mercer County area that provide assistance for the following need: "${query}". Include the organization name and one contact detail (phone or address) for each. Use Google Search grounding to find local results.`;
    const response = await getAiResponse(prompt);
    return `<strong>Local Resources for ${query}:</strong><p>${response}</p>`;
}

// Tool 10: Job Search Strategy Planner
async function planJobSearchStrategy(tasks) {
    const prompt = `Act as a Career Planner. Based on the following list of tasks, create a simple, prioritized 5-day job search strategy (Day 1, Day 2, etc.) for a client, ensuring no day is too overwhelming. Tasks: "${tasks}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Your 5-Day Action Plan:</strong><p>${response}</p>`;
}

// Tool 11: Emotional Support Check-In
async function checkWorkLifeBalance(stressLevel) {
    const prompt = `Act as a compassionate Wellness Coach. The user says: "${stressLevel}". Validate their feelings, then provide 3 simple, non-clinical, actionable stress-coping steps they can take today. Gently encourage them to seek human help if needed.`;
    const response = await getAiResponse(prompt);
    return `<strong>Wellness Check:</strong><p>${response}</p>`;
}

// Tool 12: Scam and Fraud Checker
async function checkForScam(suspiciousText) {
    const prompt = `Act as a Fraud Analyst. Analyze the text below for common job scam red flags (upfront fees, urgency, generic contact). Provide a clear verdict (Safe, Warning, High Risk) and a bulleted list of 3 specific reasons for the verdict. Text: "${suspiciousText}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Scam Check Result:</strong><p>${response}</p>`;
}

// Tool 13: Digital Form Assistant
async function assistWithFormQuestion(formQuestion) {
    const prompt = `Act as a Digital Form Coach. Analyze this application question: "${formQuestion}". Provide a simple, plain-language explanation of what the question is asking for, and suggest a simple template for the answer.`;
    const response = await getAiResponse(prompt);
    return `<strong>Form Question Assistance:</strong><p>${response}</p>`;
}

// Tool 14: Career Path Finder
async function findCareerPath(interests) {
    const prompt = `Act as a Vocational Counselor. Based on the user's interests: "${interests}", suggest 2 realistic, entry-level career paths in the Trenton area. For each path, list the single most important next action the user should take.`;
    const response = await getAiResponse(prompt);
    return `<strong>Suggested Career Paths:</strong><p>${response}</p>`;
}

// Tool 15: Search Task Prioritizer
async function prioritizeTasks(dailyTasks) {
    const prompt = `Act as a Productivity Expert. Take the user's list of tasks: "${dailyTasks}". Prioritize and simplify it into a bulleted list of the top 3 most important and achievable tasks for today only. Add a brief, motivational statement.`;
    const response = await getAiResponse(prompt);
    return `<strong>Your Priority Tasks for Today:</strong><p>${response}</p>`;
}

// Tool 16: Workplace Rights Explainer
async function explainWorkplaceRight(rightsTerm) {
    const prompt = `Act as a Rights Explainer. Provide a simple, short explanation of the following term: "${rightsTerm}". Explain what it is, and list 2 ways it benefits the worker.`;
    const response = await getAiResponse(prompt);
    return `<strong>Explanation of ${rightsTerm}:</strong><p>${response}</p>`;
}

// Tool 17: Food Service Skill Translator
async function translateFoodServiceSkill(kitchenTask) {
    const prompt = `Act as a Resume Expert. Translate the following informal food service task: "${kitchenTask}" into one high-impact, professional resume bullet point suitable for a server or kitchen assistant.`;
    const response = await getAiResponse(prompt);
    return `<strong>Professional Resume Bullet:</strong><p>${response}</p>`;
}

// Tool 18: Basic Digital Skill Coach
async function coachDigitalSkill(digitalTask) {
    const prompt = `Act as a Digital Literacy Coach. Provide simple, numbered, step-by-step instructions (no more than 5 steps) on how to perform the following task: "${digitalTask}". Use extremely basic language.`;
    const response = await getAiResponse(prompt);
    return `<strong>How to: ${digitalTask}</strong><p>${response}</p>`;
}

// Tool 19: Benefits Explainer
async function explainBenefit(benefitsTerm) {
    const prompt = `Act as a Benefits Counselor. Explain the following employment benefit: "${benefitsTerm}". Provide a simple, two-sentence explanation of what it is and one sentence about how it primarily helps the employee.`;
    const response = await getAiResponse(prompt);
    return `<strong>Explaining ${benefitsTerm}:</strong><p>${response}</p>`;
}

// Tool 20: Resume Feedback and Scoring
async function scoreResume(resumeDraft) {
    const prompt = `Act as a Career Analyst. Analyze the following resume draft. Give a score from 1 to 5 (1 being poor, 5 being excellent) for clarity, and provide 2-3 specific, bulleted suggestions on how to improve the resume for local jobs. Resume: "${resumeDraft}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Resume Feedback:</strong><p>${response}</p>`;
}

// Tool 21: Skill Gap Analyzer
async function analyzeSkillGap(jobGoal, knownSkill) {
    const prompt = `Act as an Education Advisor. The user wants a job as a "${jobGoal}" and knows the skill "${knownSkill}". Analyze local job requirements and suggest 2 additional, prioritized skills they should learn. Then provide one simple, immediate action step for the user to learn each suggested skill.`;
    const response = await getAiResponse(prompt);
    return `<strong>Skill Gap Analysis:</strong><p>${response}</p>`;
}

// Tool 22: App Troubleshooter
async function troubleshootAppError(appName, errorMsg) {
    const prompt = `Act as a Digital Support Expert. The user is struggling with the app "${appName}" and got the error: "${errorMsg}". Provide 3 simple, numbered troubleshooting steps a client with low literacy can try to resolve the issue.`;
    const response = await getAiResponse(prompt);
    return `<strong>Troubleshooting ${appName}:</strong><p>${response}</p>`;
}

// Tool 23: Public Transportation Route Planner
async function planPublicRoute(startAddress, destination) {
    const prompt = `Act as a Route Planner. Provide simple, numbered directions for taking public transit from "${startAddress}" to "${destination}". Use Google Search grounding to find the route and simplify the steps into 3-5 easy-to-read instructions.`;
    const response = await getAiResponse(prompt);
    return `<strong>Public Transit Route:</strong><p>${response}</p>`;
}

// Tool 24: Workplace Rights Explainer
async function explainWorkplaceRight(rightsTerm) {
    const prompt = `Act as a Rights Explainer. Provide a simple, short explanation of the following term: "${rightsTerm}". Explain what it is, and list 2 ways it benefits the worker.`;
    const response = await getAiResponse(prompt);
    return `<strong>Explanation of ${rightsTerm}:</strong><p>${response}</p>`;
}

async function getAiToolResponse(toolId, inputs) {
    const toolFunctions = {
        simplify: simplifyJobDescription,
        resume_keywords: checkResumeKeywords,
        interview_prep: generateInterviewQuestions,
        cover_letter: draftCoverLetter,
        doc_explainer: explainDocument,
        follow_up_email: draftFollowUpEmail,
        negotiation_planner: planNegotiation,
        financial_goals: planFinancialGoals,
        resource_finder: findLocalResources,
        search_strategy: planJobSearchStrategy,
        balance_check: checkWorkLifeBalance,
        scam_checker: checkForScam,
        form_assistant: assistWithFormQuestion,
        career_path: findCareerPath,
        task_prioritizer: prioritizeTasks,
        workplace_rights: explainWorkplaceRight,
        skill_translator: translateFoodServiceSkill,
        digital_coach: coachDigitalSkill,
        benefits_explainer: explainBenefit,
        resume_score: scoreResume,
        skill_gap: analyzeSkillGap,
        app_troubleshooter: troubleshootAppError,
        public_route: planPublicRoute,
    };

    const func = toolFunctions[toolId];
    if (func) {
        // Map the tool inputs correctly based on the function signature
        const params = [];
        switch (toolId) {
            case 'simplify': params.push(inputs.jargon, inputs.job_type); break;
            case 'resume_keywords': params.push(inputs.resume_text, inputs.job_type); break;
            case 'interview_prep': params.push(inputs.job_desc); break;
            case 'cover_letter': params.push(inputs.job_title); break;
            case 'doc_explainer': params.push(inputs.doc_text); break;
            case 'follow_up_email': params.push(inputs.context); break;
            case 'negotiation_planner': params.push(inputs.job_title_neg, inputs.pay_rate); break;
            case 'financial_goals': params.push(inputs.job_type_pay); break;
            case 'resource_finder': params.push(inputs.query); break;
            case 'search_strategy': params.push(inputs.tasks); break;
            case 'balance_check': params.push(inputs.stress_level); break;
            case 'scam_checker': params.push(inputs.suspicious_text); break;
            case 'form_assistant': params.push(inputs.form_question); break;
            case 'career_path': params.push(inputs.interests); break; // Only takes one input (interests)
            case 'task_prioritizer': params.push(inputs.daily_tasks); break;
            case 'workplace_rights': params.push(inputs.rights_term); break;
            case 'skill_translator': params.push(inputs.kitchen_task); break;
            case 'digital_coach': params.push(inputs.digital_task); break;
            case 'benefits_explainer': params.push(inputs.benefits_term); break;
            case 'resume_score': params.push(inputs.resume_draft); break;
            case 'skill_gap': params.push(inputs.job_goal, inputs.known_skill); break;
            case 'app_troubleshooter': params.push(inputs.app_name, inputs.error_msg); break;
            case 'public_route': params.push(inputs.start_address, inputs.destination); break;
        }
        return func(...params);
    }
    throw new Error("Invalid tool ID.");
}

/* ================== INITIALIZATION & EVENTS ================== */
function initTheme(){
    let saved = null; try{saved = localStorage.getItem('task_theme');}catch(e){}
    if(!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
        document.documentElement.setAttribute('data-theme','dark');
    } else if(saved){
        document.documentElement.setAttribute('data-theme', saved);
    }
}
ce('themeToggle').addEventListener('click',()=>{
    const dark = document.documentElement.getAttribute('data-theme') === 'dark';
    const next = dark ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    try{ localStorage.setItem('task_theme', next); }catch(e){}
});

function initMic(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ return; }
    // Add the microphone button to the header actions
    const headerActions = document.querySelector('.header-actions');
    headerActions.insertBefore(micBtn, headerActions.firstChild);

    const rec = new SR(); 
    const langMap = {en:'en-US', es:'es-ES', ht:'ht-HT'};
    micBtn.addEventListener('click', () => { 
        rec.lang = langMap[lang] || 'en-US'; 
        rec.start(); 
    });
    rec.onresult = e => { box.value = e.results[0][0].transcript; send(); };
}

ce('resetBtn').addEventListener('click', () => { chat.innerHTML = ''; chatHistory = []; setErrorStatus(null); greet(true); });
ce('send').addEventListener('click', send);
box.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); send(); }});
box.addEventListener('focus', () => setTimeout(() => safeScroll(), 300));
ce('magicBtn').addEventListener('click', () => {
    vibrate('light');
    showToolsOverlay();
});

// --- Advanced Tools Overlay Logic ---
let currentTool = CONFIG.ADVANCED_TOOLS[0].id;
const toolsOverlay = ce('tools-overlay');
const toolsTabs = ce('tools-tabs');
const toolsBody = ce('tools-body');

function renderToolsPanel() {
    let tabsHtml = '';
    let bodyHtml = '';

    CONFIG.ADVANCED_TOOLS.forEach((tool, index) => {
        const isActive = tool.id === currentTool;
        tabsHtml += `<button class="${isActive ? 'active' : ''}" data-tool-id="${tool.id}" onclick="switchTool('${tool.id}')">${tool.title}</button>`;

        let inputFieldsHtml = tool.inputs.map(input => `
            <label>${input.label}:</label>
            <${input.type === 'textarea' ? 'textarea' : 'input'} id="tool-input-${input.id}" placeholder="${input.label}" ${input.type === 'text' ? 'type="text"' : ''}></${input.type === 'textarea' ? 'textarea' : 'input'}>
        `).join('');

        bodyHtml += `
            <div class="tool-content" id="tool-content-${tool.id}" style="display: ${isActive ? 'block' : 'none'};">
                <h3>${tool.title}</h3>
                ${inputFieldsHtml}
                <button onclick="runTool('${tool.id}')">Generate Assistant Output</button>
                <div class="tool-output" id="tool-output-${tool.id}">Output will appear here.</div>
            </div>
        `;
    });

    toolsTabs.innerHTML = tabsHtml;
    toolsBody.innerHTML = bodyHtml;
}

window.switchTool = (toolId) => {
    toolsTabs.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
    toolsTabs.querySelector(`button[data-tool-id="${toolId}"]`).classList.add('active');
    
    toolsBody.querySelectorAll('.tool-content').forEach(div => div.style.display = 'none');
    toolsBody.querySelector(`#tool-content-${toolId}`).style.display = 'block';
    currentTool = toolId;
};

window.runTool = async (toolId) => {
    const tool = CONFIG.ADVANCED_TOOLS.find(t => t.id === toolId);
    if (!tool) return;

    const outputElement = ce(`tool-output-${toolId}`);
    const inputValues = {};
    let allInputsValid = true;

    tool.inputs.forEach(input => {
        const inputElement = ce(`tool-input-${input.id}`);
        inputValues[input.id] = inputElement.value.trim();
        if (inputValues[input.id] === '') {
            inputElement.style.border = '2px solid var(--error)';
            allInputsValid = false;
        } else {
            inputElement.style.border = '1px solid var(--border)';
        }
    });

    if (!allInputsValid) {
        outputElement.innerHTML = `<strong style="color: var(--error);">Please fill out all required fields.</strong>`;
        return;
    }

    outputElement.innerHTML = 'Analyzing... <div class="typing" style="display: inline-flex;"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';

    try {
        const result = await getAiToolResponse(toolId, inputValues);
        outputElement.innerHTML = `<strong>Assistant Result:</strong><p>${result}</p>`;
    } catch (e) {
        outputElement.innerHTML = `<strong style="color: var(--error);">Error generating response. Please try again.</strong>`;
        console.error(`Tool ${toolId} failed:`, e);
    }
};

window.closeToolsOverlay = () => {
    toolsOverlay.style.display = 'none';
};

function showToolsOverlay() {
    renderToolsPanel();
    toolsOverlay.style.display = 'flex';
};


function focusInput() {
    box.focus();
}

function greet(fromReset = false) {
    if (fromReset) {
        let saved = null; try{ saved = localStorage.getItem('task_lang'); }catch(e){}
        setLang(saved || 'en');
    }
    const welcomeMessage = UI[lang].welcomeSession;
    const welcomeCard = `
        <div class="card-base">
            <h3 class="text-xl">${UI[lang].welcome}</h3>
            ${welcomeMessage}
        </div>
    `;
    addB(welcomeCard);
    showQuickStartPrompts();
}

function initApp() {
    initTheme();
    initMic();
    // Load DOMPurify explicitly
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js';
    script.onload = () => {
        let saved = null; try{ saved = localStorage.getItem('task_lang'); }catch(e){} 
        setLang(saved || 'en');
        greet();
        setTimeout(focusInput, 500); 
    };
    document.head.appendChild(script);
}

// --- Splash Screen Control ---
document.getElementById('start-chat-btn').addEventListener('click', () => {
    const splash = document.getElementById('splash-screen');
    const mainAppContainer = document.getElementById('app-container');
    splash.style.opacity = '0';
    setTimeout(() => {
        splash.style.display = 'none';
        mainAppContainer.style.display = 'flex';
        initApp(); // Initialize chat after splash screen disappears
    }, 500);
});

// If the splash screen is not present (e.g., during development), initialize directly
if (!document.getElementById('splash-screen')) {
    document.addEventListener('DOMContentLoaded', initApp);
}
</script>
</body>
</html>

/* ================== SOUND & HAPTICS ================== */
let synth;
try {
  synth = new Tone.PolySynth(Tone.Synth, {
    oscillator: { type: "marimba" }, 
    envelope: { attack: 0.01, decay: 0.6, sustain: 0.1, release: 0.8 }, 
  }).toDestination();
} catch (e) { console.warn("Tone.js failed to initialize."); synth = null; }

function playSound(type) {
  if (synth && Tone.context.state !== 'running') { Tone.start(); }
  if (synth) {
    try { 
      if (type === 'send') synth.triggerAttackRelease("G4", "8n", Tone.now());
      if (type === 'receive') synth.triggerAttackRelease(["C5", "E5", "G5"], "8n", Tone.now()); 
    } catch(e) {}
  }
}
function vibrate(style = 'light') {
  if (window.navigator?.vibrate) {
    try { 
      if (style === 'light') navigator.vibrate(10);
      if (style === 'medium') navigator.vibrate([30, 50, 30]);
    } catch(e) {}
  }
}

/* ================== UTILITY FUNCTIONS ================== */

const isNearBottom = () => (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 80;
function safeScroll() { if (isNearBottom()) requestAnimationFrame(() => chat.scrollTop = chat.scrollHeight ); }

/** Toggles loading/interaction state for the input box and send button. */
function setLoadingState(isLoading) {
    box.disabled = isLoading;
    sendBtn.disabled = isLoading;
    ce('magicBtn').disabled = isLoading;
    ce('resetBtn').disabled = isLoading;
    // Show checkmark briefly on successful send
    if (isLoading) {
        sendBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="send-icon"><path d="M10.75 16.75l-4.5-4.5 1.06-1.06 3.44 3.44 6.94-6.94 1.06 1.06-8 8z" /></svg>`;
    } else {
        sendBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24" class="send-icon"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>`;
    }
}

/** Updates the status bar with an optional error message and contact info. */
function setErrorStatus(message) {
    if (message) {
        // Formatted contact info using the configured numbers
        const contactInfo = `
            <div style="margin-top: 8px;">
                <p style="margin: 0; padding-bottom: 4px;">
                    **Need immediate help?** Call one of our staff directly:
                </p>
                <ul style="list-style-type: none; padding: 0; margin: 0;">
                    <li style="display:inline-block; margin-right: 12px;"><a href="tel:${CONFIG.DIANI_NUMBER}">📞 Diani: ${CONFIG.DIANI_NUMBER.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3')}</a></li>
                    <li style="display:inline-block;"><a href="tel:${CONFIG.SEAN_NUMBER}">📞 Sean: ${CONFIG.SEAN_NUMBER.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3')}</a></li>
                </ul>
            </div>
        `;
        // Use softer error messaging
        statusDiv.innerHTML = `
            <span style="font-weight: 700;">
                🚨 We're having trouble connecting to our resources right now.
            </span> 
            ${contactInfo}
        `;
        statusDiv.classList.add('error-status');
    } else {
        statusDiv.innerHTML = '⚠️ I can make mistakes — please double-check important info.';
        statusDiv.classList.remove('error-status');
    }
}

function setLang(l, persist = true) { 
    lang = (['en', 'es', 'ht'].includes(l) ? l : 'en'); 
    if (persist) { try { localStorage.setItem('task_lang', lang); } catch(e) {} } 
}

/** Function to handle Quick Query button clicks */
function sendQuickQuery(event) {
    vibrate('light');
    const query = event.currentTarget.getAttribute('data-query'); 
    if (!query) return;

    event.currentTarget.classList.add('clicked');
    setTimeout(() => { event.currentTarget.classList.remove('clicked'); }, 400);

    box.value = query;
    send(); 
}

window.callPhone = (number) => { window.location.href = `tel:${number}`; vibrate('light'); };
window.textPhone = (number) => { window.location.href = `sms:${number}`; vibrate('light'); };

// --- Error Reporting Function ---
async function sendErrorReport(userPrompt, errorMessage) {
    const FORM_URL = CONFIG.MS_FORM_URL; 
    const USER_PROMPT_FIELD = CONFIG.USER_PROMPT_FIELD; 
    const ERROR_DETAILS_FIELD = CONFIG.ERROR_DETAILS_FIELD; 

    if (FORM_URL.includes('YOUR_MICROSOFT_FORM_SUBMISSION_URL_HERE')) {
        console.warn("Error Reporting Disabled: Please configure Microsoft Form URL/IDs.");
        return;
    }

    const formData = new FormData();
    formData.append(USER_PROMPT_FIELD, userPrompt);
    formData.append(ERROR_DETAILS_FIELD, errorMessage + " | Time: " + new Date().toISOString());

    try {
        await fetch(FORM_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors' // Use no-cors for silent submissions to external forms
        });
        console.log("Error report sent successfully (via Microsoft Form).");
    } catch (error) {
        console.error("Failed to send silent error report:", error);
    }
}

/* ================== RENDER FUNCTIONS ================== */
function addU(t){ 
    const e = document.createElement('div'); 
    e.className = 'bubble-wrapper user-bubble-wrapper'; 
    e.innerHTML = `<div class="bubble user">${t}</div>`; 
    chat.appendChild(e); 
    safeScroll(); 
    playSound('send'); 
    vibrate('light'); 
}

function addB(html){
    const sanitizedHTML = DOMPurify.sanitize(html);
    const wrapper = document.createElement('div');
    wrapper.className = 'bubble-wrapper bot-bubble-wrapper';
    const avatar = `<div class="avatar" aria-hidden="true">E</div>`;
    const bubble = `<div class="bubble bot">${sanitizedHTML}</div>`;
    wrapper.innerHTML = avatar + bubble;
    chat.appendChild(wrapper);
    safeScroll();
    playSound('receive');
    vibrate('light');
}

function typing(on){
    const id = 'typing';
    if(on){
        const wrapper = document.createElement('div');
        wrapper.id = id;
        wrapper.className = 'bubble-wrapper bot-bubble-wrapper';
        const avatar = `<div class="avatar" aria-hidden="true">E</div>`;
        const bubble = `<div class="bubble bot"><div class="typing" aria-hidden="true"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div></div>`;
        wrapper.innerHTML = avatar + bubble;
        chat.appendChild(wrapper);
    } else { ce(id)?.remove(); }
    safeScroll();
}

/** Clears old prompts and adds new quick-start buttons below the welcome message. */
function showQuickStartPrompts() {
    const promptsHTML = UI[lang].prompts.map(p => 
        `<button class="suggestion-btn" data-query="${p.query}">
            ${p.query.includes("Jobs") ? '💼' : '🎓'} ${p.text}
        </button>`
    ).join('');

    const promptsWrapper = document.createElement('div');
    promptsWrapper.className = 'suggestions-container';
    promptsWrapper.innerHTML = promptsHTML;
    chat.appendChild(promptsWrapper);
    
    promptsWrapper.querySelectorAll('.suggestion-btn').forEach(btn => {
        btn.addEventListener('click', sendQuickQuery);
    });
    safeScroll();
}

function renderGoogleMapsCard(address) {
    const mapUrl = `${CONFIG.GOOGLE_MAPS_BASE}${encodeURIComponent(address)}`;
    const html = `
        <div class="card-base">
            <h3>TASK Location & Map</h3>
            <p><strong>${address}</strong></p>
            <div class="controls">
                <a href="${mapUrl}" target="_blank" rel="noopener" class="ctrl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/><circle cx="12" cy="10" r="3"/></svg>
                    Open Google Maps
                </a>
            </div>
            <a href="tel:${CONFIG.APPOINTMENT_NUMBER}" class="call-btn mt-2 inline-flex items-center gap-2">📞 Call for Appointments</a>
        </div>`;
    addB(html);
}

/* ================== AI CORE (GEMINI) - WITH BACKOFF ================== */
async function exponentialBackoffFetch(url, options, retries = 0) {
    try {
        const response = await fetch(url, options);
        if (response.status === 429 || response.status >= 500) {
            if (retries < CONFIG.MAX_RETRIES) {
                const delay = Math.pow(2, retries) * 1000 + (Math.random() * 1000);
                await new Promise(resolve => setTimeout(resolve, delay));
                console.warn(`API retry ${retries + 1} after ${delay}ms: Status ${response.status}`);
                return exponentialBackoffFetch(url, options, retries + 1);
            }
            throw new Error(`API error after ${MAX_RETRIES} attempts: ${response.statusText || response.status}`);
        }
        if (!response.ok) {
            const errorText = await response.text();
             throw new Error(`Non-retryable API error: ${response.status} ${response.statusText || errorText}`);
        }
        return response.json();
    } catch (error) {
        console.error("Fetch attempt failed:", error.message);
        throw error;
    }
}

const systemPrompt = (currentLang) => `
    You are the Employment Assistant for the Trenton Area Soup Kitchen (TASK). 
    Your persona is friendly, empathetic, and extremely helpful. Your primary goal is to provide clear, actionable, and safe information related to employment services.
    
    The user's current language is ${currentLang}. **You MUST respond in this language.**

    ***MANDATORY RULES & ACTIONS***
    1.  **Format for Clarity:** When presenting lists, multiple steps, or diverse information, **you MUST use Markdown bullet points (* ) or numbered lists.** AVOID large, blocky paragraphs.
    2.  **Safety First:** If discussing jobs or applications, always reinforce the need for caution against scams and identity theft. Advise applying directly on the official employer website whenever possible.
    3.  **Hyperlinking:** Automatically convert the following official information into markdown links in your response. DO NOT add "Call" or "Text" buttons; the front-end handles that separately.
        * **Appointment Line**: ${CONFIG.APPOINTMENT_NUMBER} (Link to tel:${CONFIG.APPOINTMENT_NUMBER})
        * **Diani's Number**: ${CONFIG.DIANI_NUMBER} (Link to tel:${CONFIG.DIANI_NUMBER})
        * **Sean's Number**: ${CONFIG.SEAN_NUMBER} (Link to tel:${CONFIG.SEAN_NUMBER})
        * **Appointments/Scheduling**: Link to ${CONFIG.TASK_WEBSITE} or mention the phone number.
        * **Training Application**: Link to [Application](${CONFIG.TRAINING_APPLY_LINK})
        * **TASK Website**: Link to [TASK Website](${CONFIG.TASK_WEBSITE})
        * **SORA License**: Link to [Official NJ Site](${CONFIG.SORA_LINK})
    4.  **Handle Jobs:** If the user asks for "jobs" or "openings," ask for the job type (warehouse, retail, food service, specific company) first. Once they specify a type, respond **ONLY** with the tag: [SEARCH_JOBS: job_type_or_company].
    5.  **Handle Location:** If the user asks for "address" or "location," respond **ONLY** with the tag: [TASK_ADDRESS].
    6.  **Be Empathetic:** If the user expresses frustration, respond with empathy before providing resources.

    ***YOUR KNOWLEDGE BASE***
    - **Appointments**: To make an appointment, call **${CONFIG.APPOINTMENT_NUMBER}**. We do NOT take walk-ins.
    - **TASK Address**: **${CONFIG.TASK_ADDRESS}**
    - **Sean (Training Contact)**: **${CONFIG.SEAN_NUMBER}**
    - **Diani (Appointment Contact)**: **${CONFIG.DIANI_NUMBER}**
`;

async function getAiResponse(prompt) {
    const currentContents = [...chatHistory, { role: "user", parts: [{ text: prompt }] }];
    let finalResponseText = '';
    
    try {
        const payload = {
            contents: currentContents,
            systemInstruction: { parts: [{ text: systemPrompt(lang) }] },
            tools: [{ "google_search": {} }]
        };

        const result = await exponentialBackoffFetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        finalResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || UI[lang].errorSoft;
        
        chatHistory.push({ role: "model", parts: [{ text: finalResponseText }] });
        setErrorStatus(null); 
        return finalResponseText;

    } catch (error) {
        console.error("Gemini API call failed:", error);
        
        const hardErrorMsg = UI[lang].errorHard;
        const diagnosticMsg = `Prompt: "${prompt}" | Error: ${error.message}`;
        sendErrorReport(prompt, diagnosticMsg);
        
        finalResponseText = hardErrorMsg;
        setErrorStatus(finalResponseText); 
        return finalResponseText;

    } finally {
        // NOTE: typing(false) and setLoadingState(false) are handled in handle(t)
    }
}

/* ================== FLOW CONTROL ================== */
/** Main function to handle user input and trigger AI response */
async function handle(t){
    if(!t) return;

    // 1. Instant User Feedback/Loading Signal
    addU(t); 
    setLoadingState(true);
    typing(true); 

    // 2. Auto-detect language 
    await detectAndSetLanguage(t); 

    // 3. Process main AI response
    const aiResponse = await getAiResponse(t);

    if (aiResponse.startsWith('[SEARCH_JOBS:')) {
        const jobMatch = aiResponse.match(/\[SEARCH_JOBS:\s*(.+)\]/);
        if (jobMatch && jobMatch[1]) {
            await getJobs(jobMatch[1]);
        } else {
            addB(UI[lang].errorSoft);
        }
    } else if (aiResponse.startsWith('[TASK_ADDRESS]')) {
        renderGoogleMapsCard(CONFIG.TASK_ADDRESS);
        
    } else {
        // Apply hyperlinking and rendering
        const formattedResponse = applyHyperlinks(aiResponse);
        addB(formattedResponse);
    }
    
    // 4. Reset UI after all rendering is complete
    typing(false); 
    setLoadingState(false);
}

function applyHyperlinks(text) {
    let result = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
        if (url.startsWith('tel:')) { return `<a href="${url}" class="font-bold">${linkText}</a>`; }
        return `<a href="${url}" target="_blank" rel="noopener">${linkText}</a>`;
    });

    // 2. Convert Markdown lists (needed for bullet point formatting)
    result = result.replace(/\* (.*)/g, '<li>$1</li>');
    if (result.includes('<li>')) {
        result = `<ul>${result}</ul>`;
    }

    // 3. Add hyperlinking for non-markdown instances of phone numbers and address
    // (A) Phone Numbers 
    const phoneRegex = /(\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4})/g;
    result = result.replace(phoneRegex, (match) => `<a href="tel:${match.replace(/[^0-9]/g, '')}" class="font-bold">${match}</a>`);
    
    // (B) Address 
    const addressRegex = new RegExp(CONFIG.TASK_ADDRESS.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
    result = result.replace(addressRegex, (match) => `<a href="${CONFIG.GOOGLE_MAPS_BASE}${encodeURIComponent(CONFIG.TASK_ADDRESS)}" target="_blank" rel="noopener">${match}</a>`);

    // (C) Appointment/Training mentions (contextual links)
    result = result.replace(/training\s+application/gi, (match) => `<a href="${CONFIG.TRAINING_APPLY_LINK}" target="_blank" rel="noopener">${match}</a>`);
    result = result.replace(/appointments?|scheduling/gi, (match) => `<a href="tel:${CONFIG.APPOINTMENT_NUMBER}" class="font-bold">${match}</a>`);
    result = result.replace(/SORA\s+License/gi, (match) => `<a href="${CONFIG.SORA_LINK}" target="_blank" rel="noopener">${match}</a>`);
    
    // 4. Add Call/Text buttons for staff phone numbers if mentioned
    if (result.includes(CONFIG.DIANI_NUMBER) || result.includes(CONFIG.SEAN_NUMBER)) {
        const staffButtons = `
            <div class="contact-buttons">
                <a href="tel:${CONFIG.DIANI_NUMBER}" class="call-btn">📞 Call Diani</a>
                <a href="sms:${CONFIG.DIANI_NUMBER}" class="text-btn">💬 Text Diani</a>
                <a href="tel:${CONFIG.SEAN_NUMBER}" class="call-btn">📞 Call Sean</a>
                <a href="sms:${CONFIG.SEAN_NUMBER}" class="text-btn">💬 Text Sean</a>
            </div>
        `;
        result = result.replace(/<\/ul>$/, '') + staffButtons + (result.endsWith('</ul>') ? '</ul>' : '');
    }

    return result;
}

async function getJobs(query) {
    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&ibp=htl;jobs`;
    
    let jobsHtml = `<p>Searching for the latest <strong>${query}</strong> jobs in Mercer County... Click the button below for the most up-to-date listings.</p>`;
    
    jobsHtml += `<div class="card-base job-card">
        <h3>Live Job Search Results</h3>
        <p><strong>Mercer County, NJ</strong></p>
        <div class="controls">
            <a href="${searchUrl}" target="_blank" rel="noopener" class="ctrl">
                ⚠️ View Live Openings Safely
            </a>
        </div>
    </div>`;
    addB(jobsHtml);
}

function send(){ 
    const t = (box.value||'').trim(); 
    if(!t) return; 
    handle(t); 
    box.value = ''; 
    box.blur(); 
    setTimeout(() => box.focus(), 100); 
}
/* ================== LANGUAGE DETECTION ================== */
async function detectAndSetLanguage(prompt) {
    const langDetectionPrompt = `Detect the language of the following user message and return the corresponding two-letter ISO 639-1 language code (en, es, or ht). Do not provide any other text. User message: "${prompt}"`;
    const targetLanguages = ['en', 'es', 'ht'];

    try {
        const payload = {
            contents: [{ parts: [{ text: langDetectionPrompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: { "language": { "type": "STRING", "description": "The two-letter ISO 639-1 code (en, es, or ht)." } },
                    propertyOrdering: ["language"]
                }
            },
            systemInstruction: { parts: [{ text: "You are a language detection expert. Output only the requested JSON object." }] },
        };

        const result = await exponentialBackoffFetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }, 0); 

        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        const parsedJson = JSON.parse(jsonText);
        const detectedLang = parsedJson.language.toLowerCase();
        
        if (targetLanguages.includes(detectedLang) && detectedLang !== lang) {
            setLang(detectedLang);
            console.log(`Language switched to: ${detectedLang}`);
        }
    } catch (e) {
        console.warn("Language detection failed, proceeding with current language.", e);
    }
}

/* ================== ADVANCED LLM TOOLS ================== */

// Tool 1: Job Description Simplifier
async function simplifyJobDescription(jargon, jobType) {
    const prompt = `Act as an Employment Coach. Simplify the following complex job jargon or job description for someone with low literacy. Keep the language direct, use simple words, and summarize the key duties using bullet points: "${jargon}" for a job titled "${jobType}".`;
    const response = await getAiResponse(prompt);
    return `<strong>Job Jargon Simplification:</strong><p>${response}</p>`;
}

// Tool 2: Resume Keyword Checker
async function checkResumeKeywords(resumeText, jobType) {
    const prompt = `Act as a Resume Analyst. Analyze the following resume skills section and suggest 3-5 keywords or phrases specific to a "${jobType}" job that the user should add or highlight. Resume Text: "${resumeText}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Resume Keyword Analysis for ${jobType}:</strong><p>${response}</p>`;
}

// Tool 3: Interview Prep Coach
async function generateInterviewQuestions(jobDesc) {
    const prompt = `Act as an Interview Coach. Based ONLY on the job description below, generate 3 clear, simple interview questions (2 behavioral, 1 technical) that a candidate with low literacy can easily understand and prepare for. Present them as a numbered list. Job Description: "${jobDesc}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Interview Questions:</strong><p>${response}</p>`;
}

// Tool 4: Cover Letter Drafter
async function draftCoverLetter(jobTitle) {
    const prompt = `Act as a professional writer. Draft a concise, 3-paragraph cover letter structure for a client applying for a "${jobTitle}" position. Use simple, direct language. The client will copy and fill in their name and details later.`;
    const response = await getAiResponse(prompt);
    return `<strong>Cover Letter Draft for ${jobTitle}:</strong><p>${response}</p>`;
}

// Tool 5: Document Explainer
async function explainDocument(docText) {
    const prompt = `Act as an Explainer. Analyze the following document text and provide a simple, 2-sentence summary of the document's purpose, and list the 3 most important actions the user must take. Document Text: "${docText}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Document Explanation:</strong><p>${response}</p>`;
}

// Tool 6: Follow-up Email Drafter
async function draftFollowUpEmail(context) {
    const prompt = `Act as a Communication Coach. Draft a short, professional thank-you email template based on the following context: "${context}". Use clear language and end with a call to action.`;
    const response = await getAiResponse(prompt);
    return `<strong>Follow-up Email Draft:</strong><p>${response}</p>`;
}

// Tool 7: Negotiation Planner
async function planNegotiation(jobTitle, payRate) {
    const prompt = `Act as a Financial Negotiator. Based on a job title of "${jobTitle}" and pay rate of "${payRate}", provide 3 simple, bulleted talking points for a client to use when discussing salary or asking for better benefits.`;
    const response = await getAiResponse(prompt);
    return `<strong>Negotiation Talking Points:</strong><p>${response}</p>`;
}

// Tool 8: Financial Goal Planner
async function planFinancialGoals(jobPay) {
    const prompt = `Act as a Financial Coach. Based on the income of "${jobPay}", create a simplified 4-category monthly budget framework (Housing, Food, Transport, Other). Then, list 3 clear, simple financial goals the client can achieve in 6 months.`;
    const response = await getAiResponse(prompt);
    return `<strong>Financial Plan:</strong><p>${response}</p>`;
}

// Tool 9: Local Resource Finder
async function findLocalResources(query) {
    const prompt = `Act as a Local Guide. Find and list 3 organizations in the Trenton/Mercer County area that provide assistance for the following need: "${query}". Include the organization name and one contact detail (phone or address) for each. Use Google Search grounding to find local results.`;
    const response = await getAiResponse(prompt);
    return `<strong>Local Resources for ${query}:</strong><p>${response}</p>`;
}

// Tool 10: Job Search Strategy Planner
async function planJobSearchStrategy(tasks) {
    const prompt = `Act as a Career Planner. Based on the following list of tasks, create a simple, prioritized 5-day job search strategy (Day 1, Day 2, etc.) for a client, ensuring no day is too overwhelming. Tasks: "${tasks}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Your 5-Day Action Plan:</strong><p>${response}</p>`;
}

// Tool 11: Emotional Support Check-In
async function checkWorkLifeBalance(stressLevel) {
    const prompt = `Act as a compassionate Wellness Coach. The user says: "${stressLevel}". Validate their feelings, then provide 3 simple, non-clinical, actionable stress-coping steps they can take today. Gently encourage them to seek human help if needed.`;
    const response = await getAiResponse(prompt);
    return `<strong>Wellness Check:</strong><p>${response}</p>`;
}

// Tool 12: Scam and Fraud Checker
async function checkForScam(suspiciousText) {
    const prompt = `Act as a Fraud Analyst. Analyze the text below for common job scam red flags (upfront fees, urgency, generic contact). Provide a clear verdict (Safe, Warning, High Risk) and a bulleted list of 3 specific reasons for the verdict. Text: "${suspiciousText}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Scam Check Result:</strong><p>${response}</p>`;
}

// Tool 13: Digital Form Assistant
async function assistWithFormQuestion(formQuestion) {
    const prompt = `Act as a Digital Form Coach. Analyze this application question: "${formQuestion}". Provide a simple, plain-language explanation of what the question is asking for, and suggest a simple template for the answer.`;
    const response = await getAiResponse(prompt);
    return `<strong>Form Question Assistance:</strong><p>${response}</p>`;
}

// Tool 14: Career Path Finder
async function findCareerPath(interests) {
    const prompt = `Act as a Vocational Counselor. Based on the user's interests: "${interests}", suggest 2 realistic, entry-level career paths in the Trenton area. For each path, list the single most important next action the user should take.`;
    const response = await getAiResponse(prompt);
    return `<strong>Suggested Career Paths:</strong><p>${response}</p>`;
}

// Tool 15: Search Task Prioritizer
async function prioritizeTasks(dailyTasks) {
    const prompt = `Act as a Productivity Expert. Take the user's list of tasks: "${dailyTasks}". Prioritize and simplify it into a bulleted list of the top 3 most important and achievable tasks for today only. Add a brief, motivational statement.`;
    const response = await getAiResponse(prompt);
    return `<strong>Your Priority Tasks for Today:</strong><p>${response}</p>`;
}

// Tool 16: Workplace Rights Explainer
async function explainWorkplaceRight(rightsTerm) {
    const prompt = `Act as a Rights Explainer. Provide a simple, short explanation of the following term: "${rightsTerm}". Explain what it is, and list 2 ways it benefits the worker.`;
    const response = await getAiResponse(prompt);
    return `<strong>Explanation of ${rightsTerm}:</strong><p>${response}</p>`;
}

// Tool 17: Food Service Skill Translator
async function translateFoodServiceSkill(kitchenTask) {
    const prompt = `Act as a Resume Expert. Translate the following informal food service task: "${kitchenTask}" into one high-impact, professional resume bullet point suitable for a server or kitchen assistant.`;
    const response = await getAiResponse(prompt);
    return `<strong>Professional Resume Bullet:</strong><p>${response}</p>`;
}

// Tool 18: Basic Digital Skill Coach
async function coachDigitalSkill(digitalTask) {
    const prompt = `Act as a Digital Literacy Coach. Provide simple, numbered, step-by-step instructions (no more than 5 steps) on how to perform the following task: "${digitalTask}". Use extremely basic language.`;
    const response = await getAiResponse(prompt);
    return `<strong>How to: ${digitalTask}</strong><p>${response}</p>`;
}

// Tool 19: Benefits Explainer
async function explainBenefit(benefitsTerm) {
    const prompt = `Act as a Benefits Counselor. Explain the following employment benefit: "${benefitsTerm}". Provide a simple, two-sentence explanation of what it is and one sentence about how it primarily helps the employee.`;
    const response = await getAiResponse(prompt);
    return `<strong>Explaining ${benefitsTerm}:</strong><p>${response}</p>`;
}

// Tool 20: Resume Feedback and Scoring
async function scoreResume(resumeDraft) {
    const prompt = `Act as a Career Analyst. Analyze the following resume draft. Give a score from 1 to 5 (1 being poor, 5 being excellent) for clarity, and provide 2-3 specific, bulleted suggestions on how to improve the resume for local jobs. Resume: "${resumeDraft}"`;
    const response = await getAiResponse(prompt);
    return `<strong>Resume Feedback:</strong><p>${response}</p>`;
}

// Tool 21: Skill Gap Analyzer
async function analyzeSkillGap(jobGoal, knownSkill) {
    const prompt = `Act as an Education Advisor. The user wants a job as a "${jobGoal}" and knows the skill "${knownSkill}". Analyze local job requirements and suggest 2 additional, prioritized skills they should learn. Then provide one simple, immediate action step for the user to learn each suggested skill.`;
    const response = await getAiResponse(prompt);
    return `<strong>Skill Gap Analysis:</strong><p>${response}</p>`;
}

// Tool 22: App Troubleshooter
async function troubleshootAppError(appName, errorMsg) {
    const prompt = `Act as a Digital Support Expert. The user is struggling with the app "${appName}" and got the error: "${errorMsg}". Provide 3 simple, numbered troubleshooting steps a client with low literacy can try to resolve the issue.`;
    const response = await getAiResponse(prompt);
    return `<strong>Troubleshooting ${appName}:</strong><p>${response}</p>`;
}

// Tool 23: Public Transportation Route Planner
async function planPublicRoute(startAddress, destination) {
    const prompt = `Act as a Route Planner. Provide simple, numbered directions for taking public transit from "${startAddress}" to "${destination}". Use Google Search grounding to find the route and simplify the steps into 3-5 easy-to-read instructions.`;
    const response = await getAiResponse(prompt);
    return `<strong>Public Transit Route:</strong><p>${response}</p>`;
}

// Tool 24: Workplace Rights Explainer
async function explainWorkplaceRight(rightsTerm) {
    const prompt = `Act as a Rights Explainer. Provide a simple, short explanation of the following term: "${rightsTerm}". Explain what it is, and list 2 ways it benefits the worker.`;
    const response = await getAiResponse(prompt);
    return `<strong>Explanation of ${rightsTerm}:</strong><p>${response}</p>`;
}

async function getAiToolResponse(toolId, inputs) {
    const toolFunctions = {
        simplify: simplifyJobDescription,
        resume_keywords: checkResumeKeywords,
        interview_prep: generateInterviewQuestions,
        cover_letter: draftCoverLetter,
        doc_explainer: explainDocument,
        follow_up_email: draftFollowUpEmail,
        negotiation_planner: planNegotiation,
        financial_goals: planFinancialGoals,
        resource_finder: findLocalResources,
        search_strategy: planJobSearchStrategy,
        balance_check: checkWorkLifeBalance,
        scam_checker: checkForScam,
        form_assistant: assistWithFormQuestion,
        career_path: findCareerPath,
        task_prioritizer: prioritizeTasks,
        workplace_rights: explainWorkplaceRight,
        skill_translator: translateFoodServiceSkill,
        digital_coach: coachDigitalSkill,
        benefits_explainer: explainBenefit,
        resume_score: scoreResume,
        skill_gap: analyzeSkillGap,
        app_troubleshooter: troubleshootAppError,
        public_route: planPublicRoute,
    };

    const func = toolFunctions[toolId];
