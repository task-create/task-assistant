<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TASK Assistant</title>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23ff8a00'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">

  <style>
    /* System theme by default (no visible toggle on splash) */
    :root {
      color-scheme: light dark;
      --bg-dark:#0b1220; --panel-dark:#0f172a; --text-dark:#e5e7eb; --muted-dark:#9aa4b2; --border-dark:#1f2937;
      --bg-light:#f8fafc; --panel-light:#ffffff; --text-light:#0b1220; --muted-light:#475569; --border-light:#e5e7eb;
      --brand:#ff8a00; --brand2:#ffd088;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg:var(--bg-dark); --panel:var(--panel-dark); --text:var(--text-dark); --muted:var(--muted-dark); --border:var(--border-dark); }
    }
    @media (prefers-color-scheme: light) {
      :root { --bg:var(--bg-light); --panel:var(--panel-light); --text:var(--text-light); --muted:var(--muted-light); --border:var(--border-light); }
    }

    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:grid; place-items:center;
    }
    .app {
      width:min(980px,96vw); min-height:76vh; background:var(--panel);
      border:1px solid var(--border); border-radius:16px; padding:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      display:grid; grid-template-rows:auto 1fr auto; gap:14px;
    }
    header { display:flex; align-items:center; gap:12px; }
    .logo-wrap { position:relative; width:46px; height:46px; }
    .logo {
      width:46px; height:46px; border-radius:12px; display:grid; place-items:center;
      background:var(--brand); color:#000; font-weight:800; font-size:20px; z-index:2; position:relative;
    }
    .sparkle {
      position:absolute; inset:-8px; border-radius:20px; pointer-events:none; opacity:.0; transition:opacity .25s ease;
      background: conic-gradient(from 0deg, var(--brand) 0%, var(--brand2) 25%, transparent 40%, transparent 60%, var(--brand2) 75%, var(--brand) 100%);
      filter: blur(10px) saturate(1.2); animation: spin 4s linear infinite;
    }
    .sparkle.on { opacity:.7; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .muted { color:var(--muted); font-size:14px; }
    .chat {
      overflow:auto; padding:12px; border-radius:12px; background: rgba(0,0,0,0.06);
      border:1px solid var(--border); display:flex; flex-direction:column; gap:12px;
    }
    .bubble {
      max-width:82%; padding:12px 14px; border-radius:14px; line-height:1.5;
      border:1px solid var(--border); word-wrap:break-word; white-space:pre-wrap;
    }
    .me { align-self:flex-end; background:#172554; color:#fff; }
    .bot { align-self:flex-start; background:#111827; color:#e5e7eb; }
    @media (prefers-color-scheme: light) {
      .me { background:#e6f0ff; color:#0b1220; }
      .bot{ background:#f3f4f6; color:#0b1220; }
    }

    .row{ display:flex; gap:10px; }
    input[type="text"]{
      flex:1; font-size:18px; padding:14px; border-radius:12px;
      background:transparent; color:var(--text); border:1px solid var(--border); outline:none;
    }
    button{ font-size:18px; padding:14px 18px; border-radius:12px; border:0; cursor:pointer; background:var(--brand); color:#000; }

    .error{ color:#ef4444; }
    .hidden{ display:none !important; }

    /* Splash */
    .splash{ position:fixed; inset:0; display:grid; place-items:center; background:var(--bg); z-index:9999; }
    .splash-card{
      width:min(520px,92vw); background:var(--panel); border:1px solid var(--border);
      border-radius:16px; padding:24px; display:grid; gap:12px; text-align:center;
    }
    .splash h1{ margin:0; font-size:28px; }
    .splash p{ margin:0; color:var(--muted); }
    .splash .actions{ display:flex; gap:10px; justify-content:center; padding-top:8px; }
  </style>
</head>
<body>
  <!-- Splash / user gesture gate -->
  <div id="splash" class="splash">
    <div class="splash-card">
      <div class="logo-wrap" style="margin:0 auto 8px;">
        <div class="sparkle on" id="splashSparkle"></div>
        <div class="logo">T</div>
      </div>
      <h1>Welcome to TASK Assistant</h1>
      <p>Click <b>Start</b> to continue. (Audio & features enable after your click.)</p>
      <div class="actions"><button id="start" style="padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:var(--brand);color:#000;">Start</button></div>
    </div>
  </div>

  <div class="app hidden" id="app">
    <header>
      <div class="logo-wrap">
        <div class="sparkle" id="sparkle"></div>
        <div class="logo">T</div>
      </div>
      <div>
        <div style="font-weight:700;">TASK Assistant</div>
        <div class="muted">Ask anything — resumes, interviews, training dates.</div>
      </div>
      <!-- No theme toggle at outset -->
      <div style="margin-left:auto;" class="muted" id="providerTag"></div>
    </header>

    <div id="chat" class="chat" aria-live="polite"></div>

    <form id="composer" class="row" autocomplete="off">
      <input id="input" type="text" placeholder="Type your question…" />
      <button id="send" type="submit">Send</button>
    </form>

    <div id="status" class="muted"></div>
  </div>

  <script>
    // elements
    const splash  = document.getElementById('splash');
    const app     = document.getElementById('app');
    const startBtn= document.getElementById('start');
    const chat    = document.getElementById('chat');
    const form    = document.getElementById('composer');
    const input   = document.getElementById('input');
    const statusEl= document.getElementById('status');
    const sparkle = document.getElementById('sparkle');
    const providerTag = document.getElementById('providerTag');

    // audio (lazy import Tone after click)
    let Tone = null;
    let audioReady = false;
    async function ensureAudio() {
      if (!Tone) {
        // Lazy-load Tone ONLY after user gesture -> avoids autoplay warnings entirely
        const mod = await import('https://cdn.jsdelivr.net/npm/tone@15.1.22/build/Tone.js');
        Tone = mod.default || window.Tone || mod; // CDN exposes default export or global
      }
      if (Tone?.context?.state !== 'running') {
        await Tone.start();
      }
      audioReady = true;
    }
    function ding() {
      if (!audioReady || !Tone) return;
      const synth = new Tone.Synth().toDestination();
      synth.triggerAttackRelease("C5", "8n");
    }

    function bubble(text, who='bot') {
      const div = document.createElement('div');
      div.className = `bubble ${who}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function setStatus(msg, isError=false) {
      statusEl.textContent = msg || '';
      statusEl.className = isError ? 'error' : 'muted';
    }

    const history = [];

    async function askAI(prompt) {
      const res = await fetch('/api/ai', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ prompt, history })
      });
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        throw new Error(`Upstream error: ${res.status} ${res.statusText} ${text}`);
      }
      return res.json();
    }

    async function getSuggestion(lastUserMessage) {
      const res = await fetch('/api/suggest', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ lastUserMessage })
      });
      if (!res.ok) return null;
      const json = await res.json().catch(()=> null);
      return json?.suggestion || null;
    }

    // Start flow (no theme toggle shown here)
    startBtn.addEventListener('click', async () => {
      // enable audio once, safely
      try { await ensureAudio(); } catch {}
      splash.classList.add('hidden');
      app.classList.remove('hidden');
      input.focus();
    });

    // Chat send
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = input.value.trim();
      if (!prompt) return;

      // ensure audio on first send if user bypassed Start with Enter (unlikely, but safe)
      if (!audioReady) { try { await ensureAudio(); } catch {} }

      bubble(prompt, 'me');
      input.value = '';
      setStatus('Thinking…');

      try {
        const json = await askAI(prompt);
        const text = json?.text || '(no response)';
        providerTag.textContent = json?.provider ? `via ${json.provider}` : '';
        history.push({ role:'user', text: prompt });
        history.push({ role:'assistant', text });

        bubble(text, 'bot');
        setStatus('');
        ding();

        // ----- Gemini Sparkle: auto-suggest follow-up
        sparkle.classList.add('on');
        const suggestion = await getSuggestion(prompt);
        sparkle.classList.remove('on');
        if (suggestion) {
          bubble(`✨ Try: ${suggestion}`, 'bot');
        }
      } catch (err) {
        console.error(err);
        const msg = (err && err.message) ? err.message : String(err);
        setStatus(msg, true);
        bubble('Sorry — I couldn’t reach the AI service. Please try again.', 'bot');
      }
    });

    // Starter bubbles
    bubble('Hi! I’m TASK Assistant. Ask me anything — resumes, interviews, training info, and more.');
    bubble('Example: “Give me 3 bullet points for a prep cook resume in Trenton.”');
  </script>
</body>
</html>
