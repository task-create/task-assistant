<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .sticky-tools{position:sticky;top:0;z-index:20}
    .prose p{margin:.5rem 0}
    .msg{animation:fade .2s ease-in}
    @keyframes fade{from{opacity:.4;transform:translateY(3px)}to{opacity:1;transform:none}}
    details>summary::-webkit-details-marker{display:none}
  </style>
</head>
<body class="h-screen bg-neutral-50 text-neutral-900">
  <div class="h-screen grid grid-cols-1 md:grid-cols-[300px,1fr]">
    <!-- SIDEBAR -->
    <aside class="border-r border-neutral-200 bg-white flex flex-col">
      <div class="p-3 sticky-tools bg-white border-b border-neutral-200 flex items-center gap-2">
        <div class="text-xl font-semibold">Solace</div>
        <span class="text-xs text-neutral-500 ml-auto">TASK Assistant</span>
      </div>
      <div class="p-3">
        <button id="newChatBtn" class="w-full flex items-center justify-center gap-2 rounded-2xl px-3 py-2 bg-neutral-900 text-white hover:bg-neutral-800">
          <i data-lucide="message-circle"></i>
          <span>New chat</span>
        </button>
      </div>
      <div class="px-3 flex items-center justify-between">
        <div class="text-sm font-medium tracking-wide uppercase text-neutral-500">Recent</div>
        <div class="flex items-center gap-2 text-neutral-500">
          <button id="renameChatTool" class="p-1 hover:text-neutral-900" title="Rename selected chat">
            <i data-lucide="pencil"></i>
          </button>
          <button id="deleteChatTool" class="p-1 hover:text-red-600" title="Delete selected chat">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      </div>
      <div id="chatList" class="overflow-auto p-2 space-y-1"></div>
      <div class="mt-auto p-3 text-xs text-neutral-400">v1.4 — hardcoded.js ➜ Supabase ➜ Gemini</div>
    </aside>

    <!-- MAIN -->
    <main class="flex flex-col min-h-0">
      <div class="sticky-tools bg-white border-b border-neutral-200">
        <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-2">
          <button id="toggleMenu" class="md:hidden p-2 rounded-xl border border-neutral-200"><i data-lucide="sidebar"></i></button>
          <input id="chatTitle" class="flex-1 bg-transparent outline-none text-base font-medium" value="New chat" />
          <div class="ml-auto text-xs text-neutral-400">Answers: Hardcoded ➜ Supabase ➜ Gemini</div>
        </div>
      </div>
      <div id="messages" class="flex-1 overflow-auto"><div class="max-w-3xl mx-auto px-4 py-6 space-y-6" id="thread"></div></div>
      <div class="border-t border-neutral-200 bg-white">
        <div class="max-w-3xl mx-auto p-4">
          <form id="composer" class="flex gap-2">
            <textarea id="prompt" rows="1" placeholder="Ask about SORA training, Culinary program, Job help…" class="flex-1 resize-none px-3 py-2 rounded-2xl border border-neutral-300 focus:ring-2 focus:ring-neutral-900/10 outline-none"></textarea>
            <button class="px-4 py-2 rounded-2xl bg-neutral-900 text-white hover:bg-neutral-800"><i data-lucide="send"></i></button>
          </form>
          <p class="text-[11px] text-neutral-400 mt-2">Long answers auto‑collapse with a “Show full answer” toggle.</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Optional: set these to enable Supabase lookup -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || '';
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
  </script>

  <!-- App (module) -->
  <script type="module">
    import { answerBank, matchHardcoded, classifyTrainingQ } from '/data/hardcoded.js';

    const $ = (q, el=document)=>el.querySelector(q);
    const uid = ()=>Math.random().toString(36).slice(2,9);
    const messages = $('#messages');

    const renderIcons = () => lucide.createIcons();

    const mdify = (text) => {
      if(!text) return '';
      const parts = String(text).split(/\n{2,}|### /g).map(s=>s.trim()).filter(Boolean);
      return parts.map(p=>{
        if(p.length>600){
          return '<ul class="list-disc ml-5">'+p.split(/\.?\s+(?=[A-Z])/).slice(0,8).map(s=>`<li>${s.trim()}</li>`).join('')+'</ul>'
        }
        return `<p>${p}</p>`;
      }).join('');
    };

    const chunkIfLong = (html) => {
      const div=document.createElement('div'); div.innerHTML=html; const t=div.textContent||'';
      if(t.length<900) return html;
      return `<details class="rounded-xl border border-neutral-200 bg-neutral-50 p-3"><summary class="cursor-pointer select-none text-sm">Show full answer</summary><div class="prose max-w-none mt-2">${html}</div></details>`;
    };

    // Supabase fallback
    const SUPABASE_URL = window.SUPABASE_URL||'';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY||'';
    async function fetchFromSupabase(query){
      try{
        if(!SUPABASE_URL||!SUPABASE_ANON_KEY) return null;
        const res = await fetch(`${SUPABASE_URL}/rest/v1/faqs?select=answer&topic=ilike.*${encodeURIComponent(query)}*`,{
          headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`}
        });
        if(!res.ok) return null; const rows=await res.json();
        if(rows?.[0]?.answer) return { title:'From knowledge base', answer: rows[0].answer };
      }catch(e){ console.warn('Supabase error',e); }
      return null;
    }

    // Gemini last
    async function fetchFromGemini(query){
      try{
        const r = await fetch('/api/ai',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:[{role:'user',content:query}],max_tokens:400})});
        const d = await r.json();
        return { title:'AI', answer: d.reply || 'Model unavailable.' };
      }catch(e){ return { title:'AI', answer:'Model unavailable.' }; }
    }

    // State + UI
    const state={chats:{},currentId:null};
    function newChat(title='New chat'){ const id=uid(); state.chats[id]={id,title,messages:[]}; state.currentId=id; renderChatList(); renderThread(); $('#chatTitle').value=title; return id; }
    function selectChat(id){ state.currentId=id; renderChatList(); renderThread(); }
    function deleteCurrent(){ if(!state.currentId) return; delete state.chats[state.currentId]; state.currentId=Object.keys(state.chats)[0]||newChat(); renderChatList(); renderThread(); }
    function renameCurrent(){ if(!state.currentId) return; const t=prompt('Rename chat to:', $('#chatTitle').value.trim()||'Untitled'); if(t){ state.chats[state.currentId].title=t; $('#chatTitle').value=t; renderChatList(); } }

    function renderChatList(){ const wrap=$('#chatList'); wrap.innerHTML=''; Object.values(state.chats).forEach(c=>{ const b=document.createElement('button'); b.className=`w-full text-left px-3 py-2 rounded-xl ${c.id===state.currentId?'bg-neutral-900 text-white':'hover:bg-neutral-100'}`; b.innerHTML=`<div class="text-sm font-medium">${c.title||'Untitled'}</div>`; b.onclick=()=>selectChat(c.id); wrap.appendChild(b); }); }
    function renderThread(){ const thread=$('#thread'); thread.innerHTML=''; const chat=state.chats[state.currentId]; (chat?.messages||[]).forEach(m=>thread.appendChild(renderMsg(m))); messages.scrollTop=messages.scrollHeight; }
    function renderMsg(m){ const wrap=document.createElement('div'); wrap.className='msg'; wrap.innerHTML=`<div class="flex gap-3"><div class="shrink-0 w-8 h-8 rounded-xl grid place-items-center ${m.role==='user'?'bg-neutral-900 text-white':'bg-neutral-100'}"><i data-lucide="${m.role==='user'?'user':'bot'}"></i></div><div class="flex-1">${m.role==='assistant'?`<div class="text-[11px] text-neutral-500 mb-1">${m.title||''}</div>`:''}<div class="prose max-w-none">${m.html}</div></div></div>`; renderIcons(); return wrap; }
    function push(role, html, title=''){ const chat=state.chats[state.currentId]; const msg={role,html,title}; chat.messages.push(msg); $('#thread').appendChild(renderMsg(msg)); messages.scrollTop=messages.scrollHeight; }

    // Router: Hardcoded ➜ Supabase ➜ Gemini
    function formatProgramCard(p){
      return [
        `**${p.label}**`,
        `• **Location:** ${p.location}`,
        `• **Schedule:** ${p.schedule}`,
        `• **Duration:** ${p.duration}`,
        `• **Purpose/Outcomes:** ${p.purpose_outcomes}`,
        `• **Instructor:** ${p.instructor}`,
        `• **Eligibility:** ${p.eligibility}`,
        `• **Cost:** ${p.cost}`,
        `• **Next start:** ${p.next_start_date}`,
        `• **Apply:** ${p.signup_link}`,
        `• **Contact:** ${p.contact_info}`,
        p.notes?`• **Notes:** ${p.notes}`:''
      ].filter(Boolean).join('\n');
    }

    async function answer(query){
      // 1) HARDCODED (external module)
      const hit = matchHardcoded(query);
      if(hit){
        if(hit.html){ push('assistant', chunkIfLong(mdify(hit.html)), 'TASK (hardcoded)'); return; }
        if(hit.id==='training_program' && hit.program){
          const html = formatProgramCard(hit.program);
          push('assistant', chunkIfLong(mdify(html)), 'TASK (hardcoded program)');
          return;
        }
      }
      // 2) SUPABASE
      const kb = await fetchFromSupabase(query);
      if(kb){ push('assistant', chunkIfLong(mdify(kb.answer)), kb.title); return; }
      // 3) GEMINI
      const ai = await fetchFromGemini(query);
      push('assistant', chunkIfLong(mdify(ai.answer)), ai.title);
    }

    // Wire up UI
    $('#composer').addEventListener('submit', async (e)=>{
      e.preventDefault(); const q=$('#prompt').value.trim(); if(!q) return; $('#prompt').value=''; push('user', mdify(q));
      const chat=state.chats[state.currentId]; if(chat.messages.length<=1){ chat.title=q.slice(0,50); $('#chatTitle').value=chat.title; renderChatList(); }
      await answer(q);
    });
    $('#newChatBtn').onclick=()=>newChat();
    $('#deleteChatTool').onclick=deleteCurrent;
    $('#renameChatTool').onclick=renameCurrent;
    $('#chatTitle').addEventListener('change',(e)=>{ const t=e.target.value.trim(); if(t){ state.chats[state.currentId].title=t; renderChatList(); }});
    $('#toggleMenu').onclick=()=>document.querySelector('aside').classList.toggle('hidden');

    // init
    newChat();
    push('assistant', mdify('Hi! Ask me about **SORA**, the **Culinary program**, job help, or events. I will always use TASK\'s **hardcoded answers first**, then our knowledge base, and AI last.'), 'Welcome');
    renderIcons();
  </script>
</body>
</html>
